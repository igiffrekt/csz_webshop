---
phase: 02-product-catalog-backend
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/cms/src/api/product/content-types/product/schema.json
  - apps/cms/src/api/product/controllers/product.ts
  - apps/cms/src/api/product/services/product.ts
  - apps/cms/src/api/product/routes/product.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create a product with name, description, SKU, and images in Strapi"
    - "Admin can set basePrice and compareAtPrice on products"
    - "Admin can add multiple specifications (key-value pairs) to a product"
    - "Admin can add multiple certifications with optional PDF certificates"
    - "Admin can assign products to categories"
    - "Admin can mark products as featured or on sale"
    - "Admin can set inventory stock quantity"
  artifacts:
    - path: "apps/cms/src/api/product/content-types/product/schema.json"
      provides: "Product collection type with all required fields"
      contains: "collectionType"
    - path: "apps/cms/src/api/product/controllers/product.ts"
      provides: "Product API controller"
      contains: "createCoreController"
    - path: "apps/cms/src/api/product/services/product.ts"
      provides: "Product service layer"
      contains: "createCoreService"
    - path: "apps/cms/src/api/product/routes/product.ts"
      provides: "Product API routes"
      contains: "createCoreRouter"
  key_links:
    - from: "apps/cms/src/api/product/content-types/product/schema.json"
      to: "apps/cms/src/components/product/specification.json"
      via: "component reference"
      pattern: "product.specification"
    - from: "apps/cms/src/api/product/content-types/product/schema.json"
      to: "apps/cms/src/components/product/certification.json"
      via: "component reference"
      pattern: "product.certification"
    - from: "apps/cms/src/api/product/content-types/product/schema.json"
      to: "apps/cms/src/api/category/content-types/category/schema.json"
      via: "manyToMany relation"
      pattern: "api::category.category"
---

<objective>
Create the main Product content type with all fields required by ADMN-01 through ADMN-09.

Purpose: Product is the core entity of the catalog. It references the components and Category created in Plan 02-01. This enables admins to create products with pricing, images, specifications, certifications, inventory, and promotional flags.

Output: Product collection type visible in Strapi Content-Type Builder with all required fields functional.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-product-catalog-backend/02-RESEARCH.md
@.planning/phases/02-product-catalog-backend/02-01-SUMMARY.md

Reference schema patterns from research:
- Pattern 1: Product Collection Type Schema (primary reference)

Requirements mapping from research:
| Requirement | Schema Field |
|-------------|--------------|
| ADMN-01 | name, description, images |
| ADMN-02 | basePrice, compareAtPrice |
| ADMN-03 | variants (relation - created in 02-03) |
| ADMN-04 | categories (relation) |
| ADMN-05 | certifications (component) |
| ADMN-06 | specifications (component) |
| ADMN-07 | documents (media field) |
| ADMN-08 | stock |
| ADMN-09 | isFeatured, isOnSale |
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Product collection type schema</name>
  <files>
    apps/cms/src/api/product/content-types/product/schema.json
  </files>
  <action>
Create the Product content type directory and schema:

1. Create directory: `apps/cms/src/api/product/content-types/product/`

2. Create `schema.json` with all fields from 02-RESEARCH.md Pattern 1:

Required fields:
- name: string, required, maxLength 255
- slug: uid targeting name, required
- sku: string, unique, required
- basePrice: integer, required, min 0 (price in HUF smallest unit)
- stock: integer, default 0, min 0

Optional fields:
- description: richtext
- shortDescription: text, maxLength 500
- compareAtPrice: integer, min 0
- weight: decimal
- isFeatured: boolean, default false
- isOnSale: boolean, default false

Media fields:
- images: media, multiple, allowedTypes ["images"]
- documents: media, multiple, allowedTypes ["files"] (for PDFs)

Component fields:
- specifications: component, repeatable, component "product.specification"
- certifications: component, repeatable, component "product.certification"

Relation fields:
- categories: manyToMany to api::category.category, inversedBy "products"
- variants: oneToMany to api::product-variant.product-variant, mappedBy "product" (will show warning until 02-03)

Options:
- kind: collectionType
- draftAndPublish: true

IMPORTANT: Store prices as integers (HUF cents equivalent). Frontend will format. This avoids floating-point precision issues.
  </action>
  <verify>
File exists and is valid JSON:
- `ls apps/cms/src/api/product/content-types/product/schema.json`
- `node -e "require('./apps/cms/src/api/product/content-types/product/schema.json')"`

Schema contains required fields:
- `grep -l "basePrice" apps/cms/src/api/product/content-types/product/schema.json`
- `grep -l "specifications" apps/cms/src/api/product/content-types/product/schema.json`
- `grep -l "certifications" apps/cms/src/api/product/content-types/product/schema.json`
  </verify>
  <done>Product schema.json exists with all required fields for ADMN-01 through ADMN-09</done>
</task>

<task type="auto">
  <name>Task 2: Create Product controller, service, and routes</name>
  <files>
    apps/cms/src/api/product/controllers/product.ts
    apps/cms/src/api/product/services/product.ts
    apps/cms/src/api/product/routes/product.ts
  </files>
  <action>
Create the standard Strapi API files for Product:

1. Create directories:
   - `apps/cms/src/api/product/controllers/`
   - `apps/cms/src/api/product/services/`
   - `apps/cms/src/api/product/routes/`

2. Create `controllers/product.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreController('api::product.product');
```

3. Create `services/product.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreService('api::product.product');
```

4. Create `routes/product.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreRouter('api::product.product');
```

These use Strapi's factory pattern for standard CRUD operations.
  </action>
  <verify>
Files exist:
- `ls apps/cms/src/api/product/controllers/product.ts`
- `ls apps/cms/src/api/product/services/product.ts`
- `ls apps/cms/src/api/product/routes/product.ts`

TypeScript syntax is valid:
- `npx tsc --noEmit apps/cms/src/api/product/controllers/product.ts` (may need Strapi context)
  </verify>
  <done>Product controller, service, and routes files created with standard factory pattern</done>
</task>

<task type="auto">
  <name>Task 3: Restart Strapi and verify Product content type</name>
  <files>None (verification only)</files>
  <action>
1. Restart Strapi to load Product schema:
   - Stop any running Strapi process (Ctrl+C)
   - Run `pnpm dev:cms` from project root
2. Wait for full startup
3. Verify in logs:
   - Product content type registered
   - Components loaded (specification, certification)
   - Warning about missing product-variant relation is expected (created in 02-03)
4. Test API endpoint:
   - `curl http://localhost:1337/api/products` should return 200 or 403 (no permissions yet)
  </action>
  <verify>
Strapi starts successfully:
- Look for admin panel URL in startup logs
- No fatal schema errors

Product API responds:
- `curl -s -o /dev/null -w "%{http_code}" http://localhost:1337/api/products` returns 200 or 403

Visual verification (optional):
- Navigate to http://localhost:1337/admin
- Content Manager shows "Product" in sidebar
- Product has all expected fields in Content-Type Builder
  </verify>
  <done>Product content type is registered and visible in Strapi admin. API endpoint responds (permissions configured in 02-04)</done>
</task>

</tasks>

<verification>
Phase verification for Plan 02-02:

1. Product schema.json contains all required fields:
   - Basic: name, slug, sku, description, shortDescription
   - Pricing: basePrice, compareAtPrice
   - Inventory: stock, weight
   - Media: images, documents
   - Flags: isFeatured, isOnSale
   - Components: specifications, certifications
   - Relations: categories, variants (placeholder)

2. Standard Strapi API files exist (controller, service, routes)

3. Strapi loads Product without fatal errors

4. Product appears in Content Manager sidebar
</verification>

<success_criteria>
- Product collection type exists with all fields from requirements mapping
- Product references Specification and Certification components
- Product has manyToMany relation to Category
- Product has oneToMany relation to ProductVariant (placeholder until 02-03)
- Strapi admin shows Product in Content Manager
- Satisfies field requirements for ADMN-01, ADMN-02, ADMN-04, ADMN-05, ADMN-06, ADMN-07, ADMN-08, ADMN-09
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-catalog-backend/02-02-SUMMARY.md`
</output>
