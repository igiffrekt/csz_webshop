---
phase: 02-product-catalog-backend
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Public API returns products with all populated fields (images, categories, variants, specs, certs)"
    - "Store Manager role has full CRUD permissions on Product, ProductVariant, Category"
    - "Admin can create a complete product via Strapi admin"
    - "Product API returns data usable by frontend (all relations populated)"
  artifacts: []
  key_links:
    - from: "Strapi Public Role"
      to: "/api/products"
      via: "Users & Permissions Plugin"
      pattern: "find, findOne enabled"
    - from: "Strapi Store Manager Role"
      to: "Product, ProductVariant, Category"
      via: "Admin RBAC"
      pattern: "create, read, update, delete, publish"
---

<objective>
Configure API permissions for public product access, update Store Manager role with product permissions, and verify complete catalog functionality.

Purpose: Without permissions, the API returns 403 Forbidden. Store Managers need product access to fulfill their role. This plan completes Phase 2 by wiring everything together and verifying end-to-end.

Output: Working public product API, Store Manager with product permissions, verified product creation workflow.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-product-catalog-backend/02-RESEARCH.md
@.planning/phases/02-product-catalog-backend/02-03-SUMMARY.md

From Phase 1 (01-05):
- Store Manager role exists but has only Media Library permissions
- Need to add Product, ProductVariant, Category permissions

Reference from research:
- Configuring Public API Permissions section
- Pitfall 5: Permissions Not Configured for API Access
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure public API permissions for read access</name>
  <files>None (Strapi admin configuration)</files>
  <action>
Configure public role permissions via Strapi admin UI:

1. Ensure Strapi is running (`pnpm dev:cms`)
2. Navigate to http://localhost:1337/admin
3. Log in as Super Admin (Tamas Horvath / stickerey@gmail.com)
4. Go to: Settings > Users & Permissions Plugin > Roles
5. Click on "Public" role
6. Enable permissions:

For **Product**:
- [x] find (list products)
- [x] findOne (get single product)
- [ ] create (disabled)
- [ ] update (disabled)
- [ ] delete (disabled)

For **Product-variant**:
- [x] find
- [x] findOne
- [ ] create, update, delete (disabled)

For **Category**:
- [x] find
- [x] findOne
- [ ] create, update, delete (disabled)

7. Click "Save"

This enables the Fastify API backend to fetch products without authentication while keeping write operations protected.
  </action>
  <verify>
Test public API access (no auth token):
- `curl http://localhost:1337/api/products` returns 200 with data array
- `curl http://localhost:1337/api/categories` returns 200 with data array
- `curl http://localhost:1337/api/product-variants` returns 200 with data array

Test write operations are blocked:
- `curl -X POST http://localhost:1337/api/products -H "Content-Type: application/json" -d "{}"` returns 403
  </verify>
  <done>Public role has read-only access to Product, ProductVariant, Category APIs</done>
</task>

<task type="auto">
  <name>Task 2: Update Store Manager role with product permissions</name>
  <files>None (Strapi admin configuration)</files>
  <action>
Extend Store Manager role to include product management:

1. In Strapi admin, go to: Settings > Administration panel > Roles
2. Click on "Store Manager" role (created in Phase 1)
3. Under Content Manager section, enable permissions:

For **Product**:
- [x] Create
- [x] Read
- [x] Update
- [x] Delete
- [x] Publish (if draft/publish enabled)

For **Product-variant**:
- [x] Create
- [x] Read
- [x] Update
- [x] Delete
- [x] Publish

For **Category**:
- [x] Create
- [x] Read
- [x] Update
- [x] Delete
- [x] Publish

4. Click "Save"

This fulfills ADMN-27: Store Manager role has products/orders/coupons access (products now added, orders/coupons in later phases).
  </action>
  <verify>
Visual verification in Strapi admin:
- Store Manager role shows Product, ProductVariant, Category in allowed content types
- All CRUD + Publish permissions checked

Note: Full verification requires logging in as Store Manager user (can be created for testing or verified later)
  </verify>
  <done>Store Manager role has full CRUD permissions on Product, ProductVariant, Category</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete product catalog backend:
- Product, ProductVariant, Category content types with all fields
- Specification and Certification components
- Public API read access
- Store Manager role with product permissions
- Upload plugin configured for 50MB PDFs
  </what-built>
  <how-to-verify>
1. **Create a test product in Strapi admin:**
   - Go to http://localhost:1337/admin
   - Content Manager > Product > Create new entry
   - Fill in required fields:
     - Name: "Test Extinguisher"
     - Slug: (auto-generated)
     - SKU: "TEST-001"
     - Base Price: 15000 (represents 15,000 HUF)
   - Add optional fields:
     - Description: Test description
     - Short Description: Test short
     - Images: Upload a test image
     - isFeatured: true
   - Add a Specification:
     - Key: "Weight"
     - Value: "6"
     - Unit: "kg"
   - Add a Certification:
     - Name: "CE Mark"
     - Standard: "EN 3-7:2004"
   - Save and Publish

2. **Create a test category:**
   - Content Manager > Category > Create new entry
   - Name: "Fire Extinguishers"
   - Slug: (auto-generated)
   - Save and Publish

3. **Link product to category:**
   - Edit the test product
   - In Categories field, select "Fire Extinguishers"
   - Save

4. **Create a test variant:**
   - Content Manager > Product Variant > Create new entry
   - Name: "6kg Version"
   - SKU: "TEST-001-6KG"
   - Price: 15000
   - Stock: 10
   - Attribute Label: "Size"
   - Attribute Value: "6kg"
   - Product: Select "Test Extinguisher"
   - Save and Publish

5. **Verify public API:**
   - Open browser or curl: http://localhost:1337/api/products?populate=*
   - Confirm product appears with:
     - Basic fields (name, sku, basePrice)
     - specifications array
     - certifications array
     - categories relation
     - variants relation
     - images (if uploaded)

6. **Test nested population:**
   - `curl "http://localhost:1337/api/products?populate[specifications]=*&populate[certifications]=*&populate[categories]=*&populate[variants]=*&populate[images]=*"`
   - All nested data should appear
  </how-to-verify>
  <resume-signal>Type "approved" if product creation and API verification succeeded, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete verification:

1. Content types exist and are functional:
   - Product with all required fields
   - ProductVariant with Product relation
   - Category with hierarchy support
   - Specification component
   - Certification component

2. Permissions configured:
   - Public role: read-only access to all content types
   - Store Manager role: full CRUD on products

3. Test data verifies:
   - Product creation with all field types
   - Component usage (specifications, certifications)
   - Relation linking (categories, variants)
   - Media uploads (images)
   - API population returns nested data
</verification>

<success_criteria>
Phase 2 Success Criteria (from ROADMAP.md):

1. [x] Admin can create a complete product with images, price, variants, and category assignment
2. [x] Admin can add fire safety certifications (CE, EN3, EN1866) and they display in product data
3. [x] Admin can upload PDF certificates and spec sheets that are downloadable via API
4. [x] Admin can mark products as featured or on sale and filter by these flags

Requirements satisfied:
- ADMN-01: Admin can create products with title, description, images
- ADMN-02: Admin can set product price and compare-at price
- ADMN-03: Admin can create product variants
- ADMN-04: Admin can assign products to categories
- ADMN-05: Admin can add certification information to products
- ADMN-06: Admin can upload technical specification data
- ADMN-07: Admin can upload downloadable documents (certificates, data sheets)
- ADMN-08: Admin can manage inventory quantities
- ADMN-09: Admin can set product as featured or on sale
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-catalog-backend/02-04-SUMMARY.md`
</output>
