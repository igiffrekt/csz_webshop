---
phase: 02-product-catalog-backend
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - apps/cms/src/api/product-variant/content-types/product-variant/schema.json
  - apps/cms/src/api/product-variant/controllers/product-variant.ts
  - apps/cms/src/api/product-variant/services/product-variant.ts
  - apps/cms/src/api/product-variant/routes/product-variant.ts
  - apps/cms/config/plugins.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create product variants with independent SKU, price, and stock"
    - "Variants are linked to parent product"
    - "Each variant can have its own image"
    - "Variants have attribute label/value for describing the variation (e.g., Size: 6kg)"
    - "PDF files up to 50MB can be uploaded for certificates"
  artifacts:
    - path: "apps/cms/src/api/product-variant/content-types/product-variant/schema.json"
      provides: "ProductVariant collection type"
      contains: "collectionType"
    - path: "apps/cms/src/api/product-variant/controllers/product-variant.ts"
      provides: "ProductVariant API controller"
      contains: "createCoreController"
    - path: "apps/cms/config/plugins.ts"
      provides: "Upload plugin configuration with 50MB limit"
      contains: "sizeLimit"
  key_links:
    - from: "apps/cms/src/api/product-variant/content-types/product-variant/schema.json"
      to: "apps/cms/src/api/product/content-types/product/schema.json"
      via: "manyToOne relation"
      pattern: "api::product.product"
    - from: "apps/cms/config/plugins.ts"
      to: "Strapi upload middleware"
      via: "plugin configuration"
      pattern: "upload"
---

<objective>
Create ProductVariant collection type for size/type/capacity variations, and configure upload plugin for larger certificate files.

Purpose: Fire extinguishers come in multiple sizes (2kg, 6kg, 12kg). Each variant needs its own SKU, price, and inventory. The upload config ensures PDF certificates (which can be large) upload successfully.

Output: ProductVariant content type linked to Product, upload plugin configured for 50MB files.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-product-catalog-backend/02-RESEARCH.md
@.planning/phases/02-product-catalog-backend/02-02-SUMMARY.md

Reference schema patterns from research:
- Pattern 2: ProductVariant Collection Type
- Upload Plugin Configuration example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProductVariant collection type</name>
  <files>
    apps/cms/src/api/product-variant/content-types/product-variant/schema.json
    apps/cms/src/api/product-variant/controllers/product-variant.ts
    apps/cms/src/api/product-variant/services/product-variant.ts
    apps/cms/src/api/product-variant/routes/product-variant.ts
  </files>
  <action>
Create ProductVariant content type with full directory structure:

1. Create directories:
   - `apps/cms/src/api/product-variant/content-types/product-variant/`
   - `apps/cms/src/api/product-variant/controllers/`
   - `apps/cms/src/api/product-variant/services/`
   - `apps/cms/src/api/product-variant/routes/`

2. Create `schema.json` with fields from 02-RESEARCH.md Pattern 2:

Required fields:
- name: string, required (e.g., "6kg Powder Extinguisher")
- sku: string, unique, required
- price: integer, required, min 0 (variant-specific price in HUF)
- stock: integer, default 0, min 0

Optional fields:
- compareAtPrice: integer, min 0
- weight: decimal
- attributeLabel: string (e.g., "Size", "Type", "Capacity")
- attributeValue: string (e.g., "6kg", "Powder", "9L")
- image: media, single, allowedTypes ["images"]

Relation:
- product: manyToOne to api::product.product, inversedBy "variants"

Options:
- kind: collectionType
- draftAndPublish: true

3. Create standard controller, service, routes files (same pattern as Product):

`controllers/product-variant.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreController('api::product-variant.product-variant');
```

`services/product-variant.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreService('api::product-variant.product-variant');
```

`routes/product-variant.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreRouter('api::product-variant.product-variant');
```
  </action>
  <verify>
Files exist:
- `ls apps/cms/src/api/product-variant/content-types/product-variant/schema.json`
- `ls apps/cms/src/api/product-variant/controllers/product-variant.ts`

JSON is valid:
- `node -e "require('./apps/cms/src/api/product-variant/content-types/product-variant/schema.json')"`

Schema contains product relation:
- `grep -l "api::product.product" apps/cms/src/api/product-variant/content-types/product-variant/schema.json`
  </verify>
  <done>ProductVariant collection type exists with manyToOne relation to Product</done>
</task>

<task type="auto">
  <name>Task 2: Configure upload plugin for larger files</name>
  <files>
    apps/cms/config/plugins.ts
  </files>
  <action>
Update the upload plugin configuration to handle larger PDF certificates:

1. Read current `apps/cms/config/plugins.ts` (currently exports empty object)

2. Replace with configuration from 02-RESEARCH.md:

```typescript
export default ({ env }) => ({
  upload: {
    config: {
      provider: 'local',
      providerOptions: {
        localServer: {
          maxage: 300000,
        },
      },
      sizeLimit: 50 * 1024 * 1024, // 50MB for PDF certificates
      breakpoints: {
        xlarge: 1920,
        large: 1000,
        medium: 750,
        small: 500,
        xsmall: 64,
      },
    },
  },
});
```

This configuration:
- Sets 50MB upload limit (accommodates large technical PDFs)
- Configures responsive image breakpoints for product images
- Uses local file storage (default for development)
  </action>
  <verify>
File updated:
- `grep "sizeLimit" apps/cms/config/plugins.ts`
- `grep "breakpoints" apps/cms/config/plugins.ts`

TypeScript syntax valid:
- No syntax errors when Strapi starts
  </verify>
  <done>Upload plugin configured with 50MB limit and responsive image breakpoints</done>
</task>

<task type="auto">
  <name>Task 3: Restart Strapi and verify ProductVariant</name>
  <files>None (verification only)</files>
  <action>
1. Restart Strapi to load ProductVariant schema and plugin config:
   - Stop any running Strapi process
   - Run `pnpm dev:cms` from project root
2. Wait for full startup
3. Verify in logs:
   - ProductVariant content type registered
   - No relation errors (Product<->ProductVariant bidirectional should work now)
   - Upload plugin loaded with custom config
4. Test API endpoint:
   - `curl http://localhost:1337/api/product-variants` should return 200 or 403
  </action>
  <verify>
Strapi starts successfully:
- No fatal errors in logs
- Both Product and ProductVariant registered

ProductVariant API responds:
- `curl -s -o /dev/null -w "%{http_code}" http://localhost:1337/api/product-variants` returns 200 or 403

Bidirectional relations resolved:
- No "relation target not found" warnings in Strapi logs
  </verify>
  <done>ProductVariant content type registered with working Product relation. Upload plugin configured for 50MB files. ADMN-03 (product variants) is now satisfiable in Strapi admin.</done>
</task>

</tasks>

<verification>
Phase verification for Plan 02-03:

1. ProductVariant schema contains:
   - name, sku, price, stock fields
   - attributeLabel, attributeValue for variant description
   - image media field
   - manyToOne relation to Product

2. Upload plugin configured with:
   - 50MB size limit
   - Responsive image breakpoints

3. Strapi loads both content types without relation errors

4. Product-to-Variant bidirectional relation is functional
</verification>

<success_criteria>
- ProductVariant collection type exists with all required fields
- ProductVariant has manyToOne relation to Product (inversedBy variants)
- Upload plugin allows 50MB files
- Strapi shows ProductVariant in Content Manager
- Product variants relation now functional (both directions)
- Satisfies ADMN-03 (Admin can create product variants)
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-catalog-backend/02-03-SUMMARY.md`
</output>
