---
phase: 05-authentication-user-accounts
plan: 04
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - apps/web/src/middleware.ts
  - apps/web/src/components/layout/Header.tsx
  - apps/web/src/components/layout/UserMenu.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected from /fiok to login"
    - "Authenticated users are redirected from /auth/* to /fiok"
    - "Header shows login link when not authenticated"
    - "Header shows user menu when authenticated"
  artifacts:
    - path: "apps/web/src/middleware.ts"
      provides: "Route protection middleware"
      contains: "protectedRoutes"
    - path: "apps/web/src/components/layout/UserMenu.tsx"
      provides: "Dropdown menu for authenticated users"
      contains: "logoutAction"
  key_links:
    - from: "apps/web/src/middleware.ts"
      to: "apps/web/src/lib/auth/session.ts"
      via: "decrypt import"
      pattern: "import.*decrypt"
    - from: "apps/web/src/components/layout/UserMenu.tsx"
      to: "apps/web/src/lib/auth/actions.ts"
      via: "logoutAction import"
      pattern: "import.*logoutAction"
---

<objective>
Create Next.js middleware for route protection and update Header with auth-aware navigation

Purpose: Protect account pages from unauthenticated access and provide user-friendly auth state in header
Output: Middleware.ts with route protection, UserMenu component, updated Header with conditional auth links
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication-user-accounts/05-RESEARCH.md
@.planning/phases/05-authentication-user-accounts/05-02-SUMMARY.md

# Existing Header component
@apps/web/src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js middleware for route protection</name>
  <files>
    - apps/web/src/middleware.ts
  </files>
  <action>
Create middleware.ts at the src level (not in app directory) for route protection.

Create `apps/web/src/middleware.ts`:
```typescript
import { NextRequest, NextResponse } from "next/server";
import { decrypt } from "@/lib/auth/session";

// Routes that require authentication
const protectedRoutes = ["/fiok", "/penztar"];

// Auth routes that authenticated users shouldn't access
const authRoutes = [
  "/auth/bejelentkezes",
  "/auth/regisztracio",
  "/auth/elfelejtett-jelszo",
];

// Routes to skip entirely (API, static, etc.)
const skipRoutes = ["/api", "/_next", "/favicon.ico"];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Skip middleware for API routes and static files
  if (skipRoutes.some((route) => pathname.startsWith(route))) {
    return NextResponse.next();
  }

  // Remove locale prefix for route matching (e.g., /hu/fiok -> /fiok)
  const pathWithoutLocale = pathname.replace(/^\/(hu|en)/, "") || "/";

  // Check if this is a protected or auth route
  const isProtectedRoute = protectedRoutes.some(
    (route) =>
      pathWithoutLocale === route || pathWithoutLocale.startsWith(`${route}/`)
  );
  const isAuthRoute = authRoutes.some(
    (route) =>
      pathWithoutLocale === route || pathWithoutLocale.startsWith(`${route}/`)
  );

  // Only check auth for protected/auth routes (performance optimization)
  if (!isProtectedRoute && !isAuthRoute) {
    return NextResponse.next();
  }

  // Get session from cookie
  const sessionCookie = request.cookies.get("csz-session")?.value;
  const session = await decrypt(sessionCookie);
  const isAuthenticated = session && session.expiresAt > new Date();

  // Redirect unauthenticated users from protected routes to login
  if (isProtectedRoute && !isAuthenticated) {
    const loginUrl = new URL("/hu/auth/bejelentkezes", request.url);
    // Save original URL for post-login redirect
    loginUrl.searchParams.set("redirect", pathname);
    return NextResponse.redirect(loginUrl);
  }

  // Redirect authenticated users from auth routes to account
  if (isAuthRoute && isAuthenticated) {
    return NextResponse.redirect(new URL("/hu/fiok", request.url));
  }

  return NextResponse.next();
}

export const config = {
  // Match all paths except static files
  matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\..*).*)", "/"],
};
```

Important notes:
- Middleware runs on Edge runtime, so session.ts must be Edge-compatible (jose is)
- Cookie name must match COOKIE_NAME in session.ts ("csz-session")
- Remove locale prefix before matching routes since routes are defined without locale
- Performance: only decrypt session for protected/auth routes
  </action>
  <verify>
1. Start dev server: `cd apps/web && pnpm dev`
2. Visit http://localhost:3000/hu/fiok while not logged in - should redirect to /hu/auth/bejelentkezes?redirect=/hu/fiok
3. Check that public pages like /hu/termekek still work without redirect
  </verify>
  <done>
Middleware created with route protection for /fiok and /penztar routes, with post-login redirect support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserMenu dropdown component</name>
  <files>
    - apps/web/src/components/layout/UserMenu.tsx
  </files>
  <action>
Create a dropdown menu component for authenticated users.

First, ensure dropdown menu component is available. If not installed:
```bash
npx shadcn@latest add dropdown-menu
```

Create `apps/web/src/components/layout/UserMenu.tsx`:
```tsx
"use client";

import { User, LogOut, Package, MapPin, Settings } from "lucide-react";
import { Link } from "@/i18n/navigation";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { logoutAction } from "@/lib/auth/actions";

interface UserMenuProps {
  username: string;
  email: string;
}

export function UserMenu({ username, email }: UserMenuProps) {
  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <User className="h-5 w-5" />
          <span className="sr-only">Felhasznaloi menu</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium">{username}</p>
            <p className="text-xs text-muted-foreground truncate">{email}</p>
          </div>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem asChild>
          <Link href="/fiok" className="cursor-pointer">
            <Settings className="mr-2 h-4 w-4" />
            Fiokom
          </Link>
        </DropdownMenuItem>
        <DropdownMenuItem asChild>
          <Link href="/fiok/rendelesek" className="cursor-pointer">
            <Package className="mr-2 h-4 w-4" />
            Rendeleseim
          </Link>
        </DropdownMenuItem>
        <DropdownMenuItem asChild>
          <Link href="/fiok/cimek" className="cursor-pointer">
            <MapPin className="mr-2 h-4 w-4" />
            Szallitasi cimek
          </Link>
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem asChild>
          <form action={logoutAction} className="w-full">
            <button
              type="submit"
              className="flex w-full items-center text-destructive cursor-pointer"
            >
              <LogOut className="mr-2 h-4 w-4" />
              Kijelentkezes
            </button>
          </form>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

Note: The logout is wrapped in a form to use Server Action. Clicking the button submits the form.
  </action>
  <verify>
Component file exists at apps/web/src/components/layout/UserMenu.tsx and exports UserMenu.
  </verify>
  <done>
UserMenu dropdown component created with links to account pages and logout action.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Header component with auth-aware navigation</name>
  <files>
    - apps/web/src/components/layout/Header.tsx
  </files>
  <action>
Update the Header component to show either login link or UserMenu based on auth state.

First, read the current Header.tsx to understand its structure, then modify it.

The Header component needs to:
1. Import verifySession from DAL
2. Check auth state (async Server Component)
3. Show login link if not authenticated
4. Show UserMenu if authenticated

Update `apps/web/src/components/layout/Header.tsx`:
- Add import for verifySession from "@/lib/auth/dal"
- Add import for UserMenu from "./UserMenu"
- Add import for Link from "@/i18n/navigation"
- In the component, call `const { isAuth, session } = await verifySession();`
- Replace any existing user/login links with conditional rendering:

```tsx
{/* Auth section - replace existing or add before cart */}
{isAuth && session ? (
  <UserMenu username={session.username} email={session.email} />
) : (
  <Link href="/auth/bejelentkezes">
    <Button variant="ghost" size="sm">
      Bejelentkezes
    </Button>
  </Link>
)}
```

Also add UserMenu to the mobile navigation menu if there is one, with similar conditional logic.

Important: The Header is likely a Server Component (async function). Keep it that way - UserMenu is the only client component ("use client").
  </action>
  <verify>
1. Start dev server and visit any page
2. When not logged in, header shows "Bejelentkezes" button
3. After logging in, header shows user icon with dropdown menu
4. Clicking dropdown shows Fiokom, Rendeleseim, Szallitasi cimek, and Kijelentkezes options
  </verify>
  <done>
Header updated to show login button when not authenticated, UserMenu dropdown when authenticated.
  </done>
</task>

</tasks>

<verification>
1. Middleware protects routes:
   - /hu/fiok redirects to login when not authenticated
   - /hu/auth/bejelentkezes redirects to /hu/fiok when authenticated
2. Header displays correctly:
   - Shows "Bejelentkezes" button when not logged in
   - Shows user dropdown menu when logged in
3. UserMenu dropdown works:
   - Shows username and email
   - Links to account pages work
   - Logout action works and redirects to home
4. Run `pnpm build` in apps/web - no errors
</verification>

<success_criteria>
1. Middleware.ts created with protectedRoutes and authRoutes arrays
2. Unauthenticated users redirected from /fiok to /auth/bejelentkezes with redirect param
3. Authenticated users redirected from /auth/* to /fiok
4. Header shows login button when not authenticated
5. Header shows UserMenu dropdown when authenticated
6. UserMenu has links to account pages and working logout
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication-user-accounts/05-04-SUMMARY.md`
</output>
