---
phase: 05-authentication-user-accounts
plan: 08
type: execute
wave: 5
depends_on: ["05-01", "05-02", "05-03", "05-04", "05-05", "05-06", "05-07"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can create account, log out, and log back in"
    - "User can reset password via email link"
    - "User can update profile and company info"
    - "User can manage shipping addresses"
    - "User can view order history (empty until checkout works)"
  artifacts: []
  key_links: []
---

<objective>
Verify complete authentication and user account functionality

Purpose: Ensure all Phase 5 requirements are met before proceeding to Phase 6 (Checkout)
Output: Verification report confirming all auth and account features work correctly
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication-user-accounts/05-RESEARCH.md
@.planning/phases/05-authentication-user-accounts/05-01-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-02-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-03-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-04-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-05-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-06-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Strapi API permissions for authenticated users</name>
  <files>
    - apps/cms/src/index.ts (bootstrap)
  </files>
  <action>
Before verification, ensure Strapi permissions are configured for authenticated users.

In Strapi admin (http://localhost:1337/admin):
1. Go to Settings > Users & Permissions plugin > Roles
2. Select "Authenticated" role
3. Enable permissions for shipping-address:
   - find
   - findOne
   - create
   - update
   - delete

If programmatic configuration preferred, add to bootstrap in apps/cms/src/index.ts:
```typescript
export default {
  async bootstrap({ strapi }) {
    // Configure authenticated role permissions
    const authenticatedRole = await strapi.query('plugin::users-permissions.role').findOne({
      where: { type: 'authenticated' },
    });

    if (authenticatedRole) {
      await strapi.query('plugin::users-permissions.permission').updateMany({
        where: {
          role: authenticatedRole.id,
          action: {
            $in: [
              'api::shipping-address.shipping-address.find',
              'api::shipping-address.shipping-address.findOne',
              'api::shipping-address.shipping-address.create',
              'api::shipping-address.shipping-address.update',
              'api::shipping-address.shipping-address.delete',
            ],
          },
        },
        data: { enabled: true },
      });
    }
  },
};
```

Also configure password reset URL in Strapi:
1. Go to Settings > Users & Permissions plugin > Advanced settings
2. Set "Reset password page" to: http://localhost:3000/hu/auth/jelszo-visszaallitas

For email testing, ensure SMTP env vars are set in apps/cms/.env:
```
SMTP_HOST=sandbox.smtp.mailtrap.io
SMTP_PORT=587
SMTP_USERNAME=your_mailtrap_username
SMTP_PASSWORD=your_mailtrap_password
SMTP_FROM=noreply@csz-webshop.hu
```
  </action>
  <verify>
Strapi authenticated role has shipping-address CRUD permissions. Reset password URL is configured.
  </verify>
  <done>
Strapi permissions and password reset URL configured for authenticated users.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication and user account system including registration, login, logout, password reset, profile management, and address management</what-built>
  <how-to-verify>
Follow this verification checklist:

**Prerequisites:**
1. Start all services:
   ```bash
   pnpm dev
   ```
   This should start Strapi (1337), API (4000), and Web (3000)

2. Ensure Docker is running for PostgreSQL

**AUTH-01: User Registration**
1. Navigate to http://localhost:3000/hu/auth/regisztracio
2. Fill in:
   - Felhasznalonev: testuser
   - Email: test@example.com
   - Jelszo: password123
   - Jelszo megerositese: password123
3. Click "Fiok letrehozasa"
4. Verify: Redirected to /hu/fiok and see welcome message

**AUTH-02: User Login**
1. Click "Kijelentkezes" to logout
2. Navigate to http://localhost:3000/hu/auth/bejelentkezes
3. Enter test@example.com and password123
4. Click "Bejelentkezes"
5. Verify: Redirected to /hu/fiok

**AUTH-03: User Logout**
1. Click "Kijelentkezes" button on account page
2. Verify: Redirected to home page, header shows "Bejelentkezes" button

**AUTH-04: Session Persistence**
1. Log back in with test@example.com
2. Close browser tab completely
3. Open new tab and navigate to http://localhost:3000/hu/fiok
4. Verify: Still logged in, see account dashboard

**AUTH-05: Password Reset**
(Only if SMTP is configured - skip if using Mailtrap without inbox access)
1. Go to http://localhost:3000/hu/auth/elfelejtett-jelszo
2. Enter test@example.com
3. Click "Jelszo visszaallitas kerese"
4. Verify: Success message shown
5. (If Mailtrap access): Check email, click link, set new password

**ACCT-03: Profile Update**
1. Navigate to http://localhost:3000/hu/fiok/profil
2. Fill in Vezeteknev, Keresztnev, Telefonszam
3. Click "Valtozasok mentese"
4. Verify: Success message "Profil sikeresen frissitve!"
5. Refresh page - values persisted

**ACCT-05: Company Information**
1. On profile page, fill in Cegnev and Adoszam
2. Click "Valtozasok mentese"
3. Verify: Company fields saved

**ACCT-04: Shipping Address Management**
1. Navigate to http://localhost:3000/hu/fiok/cimek
2. Verify: Empty state shows "Nincsenek mentett cimek"
3. Click "Cim hozzaadasa"
4. Fill in all required fields:
   - Cim cimkeje: Otthon
   - Cimzett neve: Test User
   - Utca, hazszam: Test utca 1
   - Iranyitoszam: 1234
   - Varos: Budapest
   - Check "Beallitas alapertelmezett cimkent"
5. Click "Cim mentese"
6. Verify: Address card appears with "Alapertelmezett" badge
7. Add a second address without default
8. Click "Szerkesztes" on first address, change city to "Debrecen"
9. Click "Cim frissitese"
10. Verify: Address updated
11. Click "Torles" on second address
12. Confirm in dialog
13. Verify: Second address removed

**ACCT-01 & ACCT-02: Order History (Empty State)**
1. Navigate to http://localhost:3000/hu/fiok/rendelesek
2. Verify: Empty state shows "Meg nincsenek rendeleseid"
3. Click "Termekek bongeszese"
4. Verify: Navigates to /hu/termekek

**Route Protection**
1. Log out
2. Try to navigate to http://localhost:3000/hu/fiok
3. Verify: Redirected to /hu/auth/bejelentkezes?redirect=/hu/fiok
4. Log in
5. Verify: Redirected back to /hu/fiok

**Header Auth State**
1. When logged out: Header shows "Bejelentkezes" button
2. When logged in: Header shows user icon with dropdown
3. Dropdown shows Fiokom, Rendeleseim, Szallitasi cimek, Kijelentkezes

Report any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All Phase 5 requirements verified through manual testing:
- AUTH-01: User can create account with email and password
- AUTH-02: User can log in with email and password
- AUTH-03: User can log out
- AUTH-04: User session persists across browser refresh
- AUTH-05: User can reset password via email link (if SMTP configured)
- ACCT-01: User can view order history (empty state)
- ACCT-02: User can view order details (not-found until Phase 6)
- ACCT-03: User can update profile information
- ACCT-04: User can manage shipping addresses
- ACCT-05: User can add company information
</verification>

<success_criteria>
1. All AUTH-* requirements pass verification
2. All ACCT-* requirements pass verification
3. Route protection working correctly
4. Session persistence verified
5. Header auth state reflects login status
6. All Hungarian text displays correctly
7. No JavaScript errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication-user-accounts/05-08-SUMMARY.md`

Include in summary:
- Verification results for each requirement
- Any issues found and resolutions
- Screenshots or notes if relevant
- Confirmation phase is ready for Phase 6
</output>
