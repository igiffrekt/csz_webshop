---
phase: 05-authentication-user-accounts
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - apps/web/src/app/[locale]/fiok/page.tsx
  - apps/web/src/app/[locale]/fiok/profil/page.tsx
  - apps/web/src/components/account/ProfileForm.tsx
  - apps/web/src/lib/auth/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can view account dashboard at /fiok"
    - "User can view and edit profile at /fiok/profil"
    - "User can update personal info and company details"
  artifacts:
    - path: "apps/web/src/app/[locale]/fiok/page.tsx"
      provides: "Account dashboard page"
      min_lines: 30
    - path: "apps/web/src/app/[locale]/fiok/profil/page.tsx"
      provides: "Profile settings page"
      min_lines: 20
    - path: "apps/web/src/components/account/ProfileForm.tsx"
      provides: "Profile edit form component"
      contains: "updateProfileAction"
  key_links:
    - from: "apps/web/src/app/[locale]/fiok/page.tsx"
      to: "apps/web/src/lib/auth/dal.ts"
      via: "requireAuth import"
      pattern: "import.*requireAuth"
    - from: "apps/web/src/components/account/ProfileForm.tsx"
      to: "apps/web/src/lib/auth/actions.ts"
      via: "updateProfileAction import"
      pattern: "import.*updateProfileAction"
---

<objective>
Create account dashboard and profile management pages

Purpose: Allow users to view account overview and update their personal and company information
Output: Account dashboard at /fiok, profile settings at /fiok/profil with editable form
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication-user-accounts/05-RESEARCH.md
@.planning/phases/05-authentication-user-accounts/05-03-SUMMARY.md
@.planning/phases/05-authentication-user-accounts/05-04-SUMMARY.md

# Existing patterns
@apps/web/src/lib/auth/actions.ts
@apps/web/src/lib/auth/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account dashboard page</name>
  <files>
    - apps/web/src/app/[locale]/fiok/page.tsx
  </files>
  <action>
Create the main account dashboard page that shows user info and links to account sections.

Create `apps/web/src/app/[locale]/fiok/page.tsx`:
```tsx
import { Metadata } from "next";
import { Link } from "@/i18n/navigation";
import { requireAuth } from "@/lib/auth/dal";
import { Button } from "@/components/ui/button";
import { logoutAction } from "@/lib/auth/actions";
import { User, Package, MapPin, Building2 } from "lucide-react";

export const metadata: Metadata = {
  title: "Fiokom | CSZ Tuzvedelmi Webaruhaz",
  description: "A fiok beallitasaid es rendeleseid",
};

export default async function AccountPage() {
  const session = await requireAuth();

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-2xl font-bold">Fiokom</h1>
        <p className="text-muted-foreground mt-1">
          Udvozollek, {session.username}!
        </p>
      </div>

      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <Link
          href="/fiok/profil"
          className="group p-6 border rounded-lg hover:bg-muted/50 transition-colors"
        >
          <div className="flex items-center gap-4">
            <div className="p-2 bg-primary/10 rounded-lg group-hover:bg-primary/20 transition-colors">
              <User className="h-6 w-6 text-primary" />
            </div>
            <div>
              <h2 className="font-semibold">Profil beallitasok</h2>
              <p className="text-sm text-muted-foreground">
                Szemelyes adatok modositasa
              </p>
            </div>
          </div>
        </Link>

        <Link
          href="/fiok/cimek"
          className="group p-6 border rounded-lg hover:bg-muted/50 transition-colors"
        >
          <div className="flex items-center gap-4">
            <div className="p-2 bg-primary/10 rounded-lg group-hover:bg-primary/20 transition-colors">
              <MapPin className="h-6 w-6 text-primary" />
            </div>
            <div>
              <h2 className="font-semibold">Szallitasi cimek</h2>
              <p className="text-sm text-muted-foreground">
                Mentett cimek kezelese
              </p>
            </div>
          </div>
        </Link>

        <Link
          href="/fiok/rendelesek"
          className="group p-6 border rounded-lg hover:bg-muted/50 transition-colors"
        >
          <div className="flex items-center gap-4">
            <div className="p-2 bg-primary/10 rounded-lg group-hover:bg-primary/20 transition-colors">
              <Package className="h-6 w-6 text-primary" />
            </div>
            <div>
              <h2 className="font-semibold">Rendeleseim</h2>
              <p className="text-sm text-muted-foreground">
                Korabbi rendelesek megtekintese
              </p>
            </div>
          </div>
        </Link>
      </div>

      <div className="mt-8 p-6 border rounded-lg bg-muted/30">
        <div className="flex items-center gap-4 mb-4">
          <Building2 className="h-5 w-5 text-muted-foreground" />
          <h3 className="font-semibold">Fiok informaciok</h3>
        </div>
        <dl className="grid gap-2 text-sm">
          <div className="flex gap-2">
            <dt className="text-muted-foreground">Email:</dt>
            <dd>{session.email}</dd>
          </div>
          <div className="flex gap-2">
            <dt className="text-muted-foreground">Felhasznalonev:</dt>
            <dd>{session.username}</dd>
          </div>
        </dl>
      </div>

      <div className="mt-8">
        <form action={logoutAction}>
          <Button variant="outline" type="submit">
            Kijelentkezes
          </Button>
        </form>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
Navigate to http://localhost:3000/hu/fiok when logged in - dashboard displays with user info and navigation cards.
  </verify>
  <done>
Account dashboard page created at /fiok with welcome message, navigation cards to profile/addresses/orders, and logout button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add updateProfileAction to auth actions</name>
  <files>
    - apps/web/src/lib/auth/actions.ts
  </files>
  <action>
Add a new Server Action for updating user profile information.

Add to `apps/web/src/lib/auth/actions.ts`:
```typescript
// Add to existing imports
import { getSession, createSession } from "./session";

// Add new schema
const updateProfileSchema = z.object({
  firstName: z.string().max(100).optional(),
  lastName: z.string().max(100).optional(),
  phone: z.string().max(50).optional(),
  companyName: z.string().max(255).optional(),
  vatNumber: z.string().max(50).optional(),
});

// Add new action
/**
 * Update user profile information
 */
export async function updateProfileAction(
  prevState: AuthState,
  formData: FormData
): Promise<AuthState> {
  // Get current session to get JWT for authenticated request
  const session = await getSession();
  if (!session) {
    return { error: "Nincs bejelentkezve" };
  }

  const validatedFields = updateProfileSchema.safeParse({
    firstName: formData.get("firstName") || undefined,
    lastName: formData.get("lastName") || undefined,
    phone: formData.get("phone") || undefined,
    companyName: formData.get("companyName") || undefined,
    vatNumber: formData.get("vatNumber") || undefined,
  });

  if (!validatedFields.success) {
    return {
      fieldErrors: validatedFields.error.flatten().fieldErrors,
    };
  }

  try {
    // Update user via Strapi Users & Permissions API
    const res = await fetch(
      `${STRAPI_URL}/api/users/${session.userId}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.jwt}`,
        },
        body: JSON.stringify(validatedFields.data),
      }
    );

    if (!res.ok) {
      const error = await res.json();
      return {
        error: error.error?.message || "Profil frissitese sikertelen",
      };
    }

    return { success: true };
  } catch {
    return {
      error: "Hiba tortent a profil frissitese soran. Probald ujra kesobb.",
    };
  }
}

/**
 * Get current user's full profile from Strapi
 */
export async function getCurrentUserProfile(): Promise<{
  user: User | null;
  error?: string;
}> {
  const session = await getSession();
  if (!session) {
    return { user: null, error: "Nincs bejelentkezve" };
  }

  try {
    const res = await fetch(
      `${STRAPI_URL}/api/users/me`,
      {
        headers: {
          Authorization: `Bearer ${session.jwt}`,
        },
        cache: "no-store",
      }
    );

    if (!res.ok) {
      return { user: null, error: "Profil betoltese sikertelen" };
    }

    const user = await res.json();
    return { user };
  } catch {
    return { user: null, error: "Hiba tortent" };
  }
}
```

Also add import for User type at the top:
```typescript
import type { User } from "@csz/types";
```

Make sure to export the new functions.
  </action>
  <verify>
Check that updateProfileAction and getCurrentUserProfile are exported from actions.ts.
  </verify>
  <done>
updateProfileAction and getCurrentUserProfile added to auth actions for profile management.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ProfileForm component and profile page</name>
  <files>
    - apps/web/src/components/account/ProfileForm.tsx
    - apps/web/src/app/[locale]/fiok/profil/page.tsx
  </files>
  <action>
Create the profile editing form component and page.

1. Create `apps/web/src/components/account/ProfileForm.tsx`:
```tsx
"use client";

import { useActionState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { updateProfileAction, type AuthState } from "@/lib/auth/actions";
import type { User } from "@csz/types";

interface ProfileFormProps {
  user: User;
}

export function ProfileForm({ user }: ProfileFormProps) {
  const [state, formAction, isPending] = useActionState<AuthState, FormData>(
    updateProfileAction,
    {}
  );

  return (
    <form action={formAction} className="space-y-6">
      {state.error && (
        <div className="bg-destructive/15 text-destructive px-4 py-3 rounded-md text-sm">
          {state.error}
        </div>
      )}

      {state.success && (
        <div className="bg-green-100 text-green-800 px-4 py-3 rounded-md text-sm">
          Profil sikeresen frissitve!
        </div>
      )}

      <div className="space-y-4">
        <h2 className="text-lg font-semibold">Szemelyes adatok</h2>

        <div className="grid gap-4 sm:grid-cols-2">
          <div className="space-y-2">
            <Label htmlFor="firstName">Vezeteknev</Label>
            <Input
              id="firstName"
              name="firstName"
              type="text"
              defaultValue={user.firstName || ""}
              autoComplete="given-name"
              disabled={isPending}
            />
            {state.fieldErrors?.firstName && (
              <p className="text-sm text-destructive">
                {state.fieldErrors.firstName[0]}
              </p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="lastName">Keresztnev</Label>
            <Input
              id="lastName"
              name="lastName"
              type="text"
              defaultValue={user.lastName || ""}
              autoComplete="family-name"
              disabled={isPending}
            />
            {state.fieldErrors?.lastName && (
              <p className="text-sm text-destructive">
                {state.fieldErrors.lastName[0]}
              </p>
            )}
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="phone">Telefonszam</Label>
          <Input
            id="phone"
            name="phone"
            type="tel"
            defaultValue={user.phone || ""}
            placeholder="+36 20 123 4567"
            autoComplete="tel"
            disabled={isPending}
          />
          {state.fieldErrors?.phone && (
            <p className="text-sm text-destructive">
              {state.fieldErrors.phone[0]}
            </p>
          )}
        </div>
      </div>

      <div className="space-y-4 pt-4 border-t">
        <h2 className="text-lg font-semibold">Ceges adatok (B2B)</h2>
        <p className="text-sm text-muted-foreground">
          Toltsd ki, ha ceges szamlat szeretnel kerni
        </p>

        <div className="space-y-2">
          <Label htmlFor="companyName">Cegnev</Label>
          <Input
            id="companyName"
            name="companyName"
            type="text"
            defaultValue={user.companyName || ""}
            autoComplete="organization"
            disabled={isPending}
          />
          {state.fieldErrors?.companyName && (
            <p className="text-sm text-destructive">
              {state.fieldErrors.companyName[0]}
            </p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="vatNumber">Adoszam</Label>
          <Input
            id="vatNumber"
            name="vatNumber"
            type="text"
            defaultValue={user.vatNumber || ""}
            placeholder="12345678-1-23"
            disabled={isPending}
          />
          {state.fieldErrors?.vatNumber && (
            <p className="text-sm text-destructive">
              {state.fieldErrors.vatNumber[0]}
            </p>
          )}
        </div>
      </div>

      <div className="pt-4">
        <Button type="submit" disabled={isPending}>
          {isPending ? "Mentes..." : "Valtozasok mentese"}
        </Button>
      </div>
    </form>
  );
}
```

2. Create `apps/web/src/app/[locale]/fiok/profil/page.tsx`:
```tsx
import { Metadata } from "next";
import { Link } from "@/i18n/navigation";
import { requireAuth } from "@/lib/auth/dal";
import { getCurrentUserProfile } from "@/lib/auth/actions";
import { ProfileForm } from "@/components/account/ProfileForm";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";

export const metadata: Metadata = {
  title: "Profil beallitasok | CSZ Tuzvedelmi Webaruhaz",
  description: "Szemelyes es ceges adatok szerkesztese",
};

export default async function ProfilePage() {
  // Ensure user is authenticated
  await requireAuth();

  // Get full user profile from Strapi
  const { user, error } = await getCurrentUserProfile();

  if (error || !user) {
    return (
      <div className="container py-8">
        <div className="text-center">
          <p className="text-destructive">{error || "Profil betoltese sikertelen"}</p>
          <Link href="/fiok">
            <Button variant="outline" className="mt-4">
              Vissza a fiokhoz
            </Button>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="container max-w-2xl py-8">
      <div className="mb-6">
        <Link
          href="/fiok"
          className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground mb-4"
        >
          <ArrowLeft className="h-4 w-4 mr-1" />
          Vissza a fiokhoz
        </Link>
        <h1 className="text-2xl font-bold">Profil beallitasok</h1>
        <p className="text-muted-foreground mt-1">
          Frissitsd a szemelyes es ceges adataidat
        </p>
      </div>

      <div className="border rounded-lg p-6">
        <div className="mb-6 pb-4 border-b">
          <p className="text-sm text-muted-foreground">
            <span className="font-medium">Email:</span> {user.email}
          </p>
          <p className="text-sm text-muted-foreground">
            <span className="font-medium">Felhasznalonev:</span> {user.username}
          </p>
          <p className="text-xs text-muted-foreground mt-2">
            Az email cim es felhasznalonev nem modosithato.
          </p>
        </div>

        <ProfileForm user={user} />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
Navigate to http://localhost:3000/hu/fiok/profil when logged in - profile form displays with user data and can be edited.
  </verify>
  <done>
ProfileForm component and profile page created at /fiok/profil with editable fields for personal and company information.
  </done>
</task>

</tasks>

<verification>
1. Account dashboard at /hu/fiok shows user info and navigation cards
2. Profile page at /hu/fiok/profil loads user data from Strapi
3. Profile form shows current values as defaults
4. Submitting form updates user data in Strapi
5. Success message shows after successful update
6. All text is in Hungarian
</verification>

<success_criteria>
1. Account dashboard page created at /fiok with navigation to profile, addresses, orders
2. Profile page created at /fiok/profil with editable form
3. updateProfileAction calls Strapi API with JWT authorization
4. getCurrentUserProfile fetches full user data from Strapi
5. ProfileForm shows current user data as defaults and handles updates
6. All requirements covered: ACCT-03 (update profile), ACCT-05 (company info)
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication-user-accounts/05-05-SUMMARY.md`
</output>
