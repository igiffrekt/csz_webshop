---
phase: 05-authentication-user-accounts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/cms/src/extensions/users-permissions/content-types/user/schema.json
  - apps/cms/src/api/shipping-address/content-types/shipping-address/schema.json
  - apps/cms/src/api/shipping-address/controllers/shipping-address.ts
  - apps/cms/src/api/shipping-address/services/shipping-address.ts
  - apps/cms/src/api/shipping-address/routes/shipping-address.ts
  - apps/cms/config/plugins.ts
  - apps/cms/.env.example
  - packages/types/src/index.ts
autonomous: true
user_setup:
  - service: smtp
    why: "Password reset emails require SMTP provider"
    env_vars:
      - name: SMTP_HOST
        source: "Email provider (Mailtrap for dev, SendGrid/Mailgun for prod)"
      - name: SMTP_PORT
        source: "Usually 587 for TLS"
      - name: SMTP_USERNAME
        source: "Provider dashboard"
      - name: SMTP_PASSWORD
        source: "Provider dashboard"
      - name: SMTP_FROM
        source: "Verified sender email address"
    dashboard_config:
      - task: "Create Mailtrap account for development testing"
        location: "https://mailtrap.io"

must_haves:
  truths:
    - "User model has company and VAT fields accessible via API"
    - "ShippingAddress content type exists and relates to users"
    - "Email provider configured and test email can be sent"
  artifacts:
    - path: "apps/cms/src/extensions/users-permissions/content-types/user/schema.json"
      provides: "Extended user schema with firstName, lastName, phone, companyName, vatNumber"
      contains: "companyName"
    - path: "apps/cms/src/api/shipping-address/content-types/shipping-address/schema.json"
      provides: "ShippingAddress collection type"
      contains: "shipping-address"
    - path: "apps/cms/config/plugins.ts"
      provides: "Email and users-permissions configuration"
      contains: "nodemailer"
    - path: "packages/types/src/index.ts"
      provides: "User, ShippingAddress TypeScript interfaces"
      contains: "ShippingAddress"
  key_links:
    - from: "apps/cms/src/api/shipping-address/content-types/shipping-address/schema.json"
      to: "plugin::users-permissions.user"
      via: "manyToOne relation"
      pattern: "users-permissions.user"
    - from: "apps/cms/src/extensions/users-permissions/content-types/user/schema.json"
      to: "api::shipping-address.shipping-address"
      via: "oneToMany relation"
      pattern: "shipping-address"
---

<objective>
Extend Strapi user model with B2B fields and create ShippingAddress content type

Purpose: Enable user profile storage and shipping address management for checkout
Output: Extended user model, ShippingAddress collection type, email provider configuration, TypeScript interfaces
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication-user-accounts/05-RESEARCH.md

# Existing Strapi patterns
@apps/cms/src/api/coupon/content-types/coupon/schema.json
@apps/cms/config/plugins.ts
@packages/types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Strapi user model with profile and B2B fields</name>
  <files>
    - apps/cms/src/extensions/users-permissions/content-types/user/schema.json
  </files>
  <action>
Create the user schema extension file to add custom fields to Strapi's built-in user model.

Create directory structure: `apps/cms/src/extensions/users-permissions/content-types/user/`

Create `schema.json` with these additional attributes (merges with default user):
```json
{
  "kind": "collectionType",
  "collectionName": "up_users",
  "info": {
    "name": "user",
    "description": "",
    "singularName": "user",
    "pluralName": "users",
    "displayName": "User"
  },
  "options": {
    "draftAndPublish": false
  },
  "attributes": {
    "firstName": {
      "type": "string",
      "maxLength": 100
    },
    "lastName": {
      "type": "string",
      "maxLength": 100
    },
    "phone": {
      "type": "string",
      "maxLength": 50
    },
    "companyName": {
      "type": "string",
      "maxLength": 255
    },
    "vatNumber": {
      "type": "string",
      "maxLength": 50
    },
    "shippingAddresses": {
      "type": "relation",
      "relation": "oneToMany",
      "target": "api::shipping-address.shipping-address",
      "mappedBy": "user"
    }
  }
}
```

Note: This extends the default user model, keeping all built-in fields (username, email, password, provider, confirmed, blocked, role).
  </action>
  <verify>
File exists at `apps/cms/src/extensions/users-permissions/content-types/user/schema.json` and is valid JSON.
  </verify>
  <done>
User schema extension file created with firstName, lastName, phone, companyName, vatNumber fields and shippingAddresses relation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ShippingAddress content type in Strapi</name>
  <files>
    - apps/cms/src/api/shipping-address/content-types/shipping-address/schema.json
    - apps/cms/src/api/shipping-address/controllers/shipping-address.ts
    - apps/cms/src/api/shipping-address/services/shipping-address.ts
    - apps/cms/src/api/shipping-address/routes/shipping-address.ts
  </files>
  <action>
Create the ShippingAddress content type following existing patterns from coupon and product.

Create directory structure: `apps/cms/src/api/shipping-address/`

1. Create `content-types/shipping-address/schema.json`:
```json
{
  "kind": "collectionType",
  "collectionName": "shipping_addresses",
  "info": {
    "singularName": "shipping-address",
    "pluralName": "shipping-addresses",
    "displayName": "Shipping Address",
    "description": "User shipping addresses for checkout"
  },
  "options": {
    "draftAndPublish": false
  },
  "attributes": {
    "label": {
      "type": "string",
      "required": true,
      "maxLength": 100
    },
    "recipientName": {
      "type": "string",
      "required": true,
      "maxLength": 255
    },
    "street": {
      "type": "string",
      "required": true,
      "maxLength": 255
    },
    "city": {
      "type": "string",
      "required": true,
      "maxLength": 100
    },
    "postalCode": {
      "type": "string",
      "required": true,
      "maxLength": 20
    },
    "country": {
      "type": "string",
      "default": "Magyarorszag",
      "maxLength": 100
    },
    "phone": {
      "type": "string",
      "maxLength": 50
    },
    "isDefault": {
      "type": "boolean",
      "default": false
    },
    "user": {
      "type": "relation",
      "relation": "manyToOne",
      "target": "plugin::users-permissions.user",
      "inversedBy": "shippingAddresses"
    }
  }
}
```

2. Create `controllers/shipping-address.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreController('api::shipping-address.shipping-address');
```

3. Create `services/shipping-address.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreService('api::shipping-address.shipping-address');
```

4. Create `routes/shipping-address.ts`:
```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreRouter('api::shipping-address.shipping-address');
```
  </action>
  <verify>
All files exist in `apps/cms/src/api/shipping-address/` directory. Schema JSON is valid.
  </verify>
  <done>
ShippingAddress content type created with label, recipientName, street, city, postalCode, country, phone, isDefault fields and user relation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure email provider and users-permissions plugin</name>
  <files>
    - apps/cms/config/plugins.ts
    - apps/cms/.env.example
  </files>
  <action>
Update the Strapi plugins configuration to add email provider and users-permissions settings.

1. Update `apps/cms/config/plugins.ts` to include email and users-permissions config:
```typescript
export default ({ env }) => ({
  upload: {
    config: {
      provider: 'local',
      providerOptions: {
        localServer: {
          maxage: 300000,
        },
      },
      sizeLimit: 50 * 1024 * 1024, // 50MB for PDF certificates
      breakpoints: {
        xlarge: 1920,
        large: 1000,
        medium: 750,
        small: 500,
        xsmall: 64,
      },
    },
  },
  email: {
    config: {
      provider: 'nodemailer',
      providerOptions: {
        host: env('SMTP_HOST', 'sandbox.smtp.mailtrap.io'),
        port: env.int('SMTP_PORT', 587),
        auth: {
          user: env('SMTP_USERNAME'),
          pass: env('SMTP_PASSWORD'),
        },
      },
      settings: {
        defaultFrom: env('SMTP_FROM', 'noreply@csz-webshop.hu'),
        defaultReplyTo: env('SMTP_REPLY_TO', 'info@csz-webshop.hu'),
      },
    },
  },
  'users-permissions': {
    config: {
      jwt: {
        expiresIn: '7d',
      },
      register: {
        allowedFields: ['firstName', 'lastName', 'phone', 'companyName', 'vatNumber'],
      },
      ratelimit: {
        enabled: true,
        interval: { min: 5 },
        max: 5,
      },
    },
  },
});
```

2. Update `apps/cms/.env.example` to add SMTP variables:
```
# SMTP Configuration (use Mailtrap for development)
SMTP_HOST=sandbox.smtp.mailtrap.io
SMTP_PORT=587
SMTP_USERNAME=your_mailtrap_username
SMTP_PASSWORD=your_mailtrap_password
SMTP_FROM=noreply@csz-webshop.hu
SMTP_REPLY_TO=info@csz-webshop.hu
```

3. Install nodemailer provider in apps/cms:
```bash
cd apps/cms && pnpm add @strapi/provider-email-nodemailer
```
  </action>
  <verify>
Run `pnpm --filter @csz/cms exec strapi build` to verify configuration is valid. Check that @strapi/provider-email-nodemailer is in apps/cms/package.json dependencies.
  </verify>
  <done>
Email provider configured with nodemailer, users-permissions configured with 7-day JWT, allowed registration fields, and rate limiting.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add User and ShippingAddress TypeScript interfaces</name>
  <files>
    - packages/types/src/index.ts
  </files>
  <action>
Add TypeScript interfaces for User and ShippingAddress to the shared types package.

Add to `packages/types/src/index.ts` after the existing types:

```typescript
// User profile from Strapi users-permissions
export interface User {
  id: number;
  documentId: string;
  username: string;
  email: string;
  provider: string;
  confirmed: boolean;
  blocked: boolean;
  firstName?: string;
  lastName?: string;
  phone?: string;
  companyName?: string;
  vatNumber?: string;
  shippingAddresses?: ShippingAddress[];
  createdAt: string;
  updatedAt: string;
}

// Shipping address for user account
export interface ShippingAddress {
  id: number;
  documentId: string;
  label: string;
  recipientName: string;
  street: string;
  city: string;
  postalCode: string;
  country: string;
  phone?: string;
  isDefault: boolean;
  user?: User;
  createdAt: string;
  updatedAt: string;
}

// Auth response from Strapi login/register
export interface AuthResponse {
  jwt: string;
  user: User;
}

// Session payload for encrypted cookie
export interface SessionPayload {
  jwt: string;
  userId: number;
  userDocumentId: string;
  email: string;
  username: string;
  expiresAt: Date;
}
```
  </action>
  <verify>
Run `pnpm --filter @csz/types build` to verify types compile. Check that User, ShippingAddress, AuthResponse, SessionPayload are exported.
  </verify>
  <done>
TypeScript interfaces added for User, ShippingAddress, AuthResponse, and SessionPayload to shared types package.
  </done>
</task>

</tasks>

<verification>
1. Strapi starts successfully with new content types: `cd apps/cms && pnpm dev`
2. User model shows custom fields in Strapi admin: Settings > Users & Permissions plugin > Roles > Edit (should see extended fields)
3. ShippingAddress appears in Content-Type Builder
4. Run `pnpm build` at monorepo root - all packages compile
5. Check apps/cms/package.json includes @strapi/provider-email-nodemailer
</verification>

<success_criteria>
1. User model extended with firstName, lastName, phone, companyName, vatNumber fields
2. ShippingAddress content type created with all address fields and user relation
3. Email provider configured with nodemailer
4. Users-permissions configured with allowedFields including custom fields
5. TypeScript interfaces available in @csz/types for User, ShippingAddress, AuthResponse, SessionPayload
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication-user-accounts/05-01-SUMMARY.md`
</output>
