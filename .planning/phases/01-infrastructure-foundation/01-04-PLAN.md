---
phase: 01-infrastructure-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/api/package.json
  - apps/api/tsconfig.json
  - apps/api/src/index.ts
  - apps/api/.env
autonomous: true

must_haves:
  truths:
    - "API server starts on port 4000"
    - "Health check endpoint returns 200 OK"
    - "CORS is configured for frontend origin"
  artifacts:
    - path: "apps/api/package.json"
      provides: "Fastify API package configuration"
      contains: "fastify"
    - path: "apps/api/src/index.ts"
      provides: "Fastify server entry point"
      contains: "fastify.listen"
    - path: "apps/api/tsconfig.json"
      provides: "TypeScript configuration for API"
      contains: "NodeNext"
  key_links:
    - from: "apps/api/src/index.ts"
      to: "/health endpoint"
      via: "fastify-healthcheck plugin"
      pattern: "healthcheck"
---

<objective>
Scaffold Fastify 5 API backend with health check endpoint

Purpose: Establish the API backend that will handle business logic (cart calculations, checkout, payments) separate from Strapi's CMS responsibilities. Fastify provides high performance and excellent TypeScript support.

Output: Running Fastify 5 server with /health endpoint accessible at http://localhost:4000
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md
@.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Fastify project with dependencies</name>
  <files>apps/api/package.json, apps/api/tsconfig.json</files>
  <action>
Create apps/api directory and initialize:

```bash
mkdir -p apps/api/src
cd apps/api
pnpm init
```

Create apps/api/package.json with full configuration:
```json
{
  "name": "@csz/api",
  "version": "0.0.1",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "fastify": "^5.0.0",
    "@fastify/cors": "^10.0.0",
    "@fastify/helmet": "^12.0.0",
    "fastify-healthcheck": "^5.0.0"
  },
  "devDependencies": {
    "typescript": "^5.7.0",
    "@types/node": "^22.0.0",
    "tsx": "^4.0.0"
  }
}
```

Create apps/api/tsconfig.json:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

Install dependencies:
```bash
cd apps/api && pnpm install
```
  </action>
  <verify>Run `pnpm --filter @csz/api exec tsc --version` to confirm TypeScript is installed</verify>
  <done>Fastify project initialized with all dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Fastify server with health check</name>
  <files>apps/api/src/index.ts, apps/api/.env</files>
  <action>
Create apps/api/src/index.ts with the server setup:

```typescript
import Fastify from 'fastify';
import cors from '@fastify/cors';
import helmet from '@fastify/helmet';
import healthcheck from 'fastify-healthcheck';

const fastify = Fastify({
  logger: {
    level: process.env.LOG_LEVEL || 'info',
  },
});

// Register plugins
await fastify.register(cors, {
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,
});

await fastify.register(helmet, {
  contentSecurityPolicy: false, // Disable CSP for development
});

await fastify.register(healthcheck, {
  healthcheckUrl: '/health',
});

// Root route for basic info
fastify.get('/', async () => {
  return {
    name: 'CSZ Webshop API',
    version: '0.0.1',
    status: 'running',
  };
});

// Start server
const start = async () => {
  try {
    const port = parseInt(process.env.PORT || '4000', 10);
    const host = process.env.HOST || '0.0.0.0';
    await fastify.listen({ port, host });
    console.log(`API running at http://${host}:${port}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};

start();
```

Create apps/api/.env:
```bash
# Server
HOST=0.0.0.0
PORT=4000
LOG_LEVEL=info

# CORS
FRONTEND_URL=http://localhost:3000

# Add database connection later when needed
# DATABASE_URL=postgresql://strapi:strapi@localhost:5432/csz_api
```
  </action>
  <verify>Check that apps/api/src/index.ts exists and contains fastify.listen</verify>
  <done>Fastify server code created with health check, CORS, and security headers</done>
</task>

<task type="auto">
  <name>Task 3: Add API scripts to root and verify server starts</name>
  <files>package.json</files>
  <action>
Update root package.json to add API scripts:
```json
{
  "scripts": {
    "dev:api": "pnpm --filter @csz/api dev",
    "build:api": "pnpm --filter @csz/api build",
    "dev": "pnpm run --parallel dev:cms dev:api"
  }
}
```

Start the API server:
```bash
pnpm dev:api
```

Verify health check endpoint:
```bash
curl http://localhost:4000/health
```

Expected response: `{"statusCode":200,"status":"ok"}`

Also verify root endpoint:
```bash
curl http://localhost:4000/
```

Expected response: `{"name":"CSZ Webshop API","version":"0.0.1","status":"running"}`

Stop the server (Ctrl+C) after verification. The combined `pnpm dev` script can now start both CMS and API together.
  </action>
  <verify>Run `curl http://localhost:4000/health` and confirm 200 response with status "ok"</verify>
  <done>API server starts and /health endpoint returns 200 OK</done>
</task>

</tasks>

<verification>
1. `apps/api/package.json` contains fastify and related dependencies
2. `apps/api/src/index.ts` exists with healthcheck plugin registered
3. `pnpm dev:api` starts server without errors
4. `curl http://localhost:4000/health` returns 200 with status "ok"
5. `curl http://localhost:4000/` returns API info JSON
6. `pnpm dev` from root starts both CMS and API in parallel
</verification>

<success_criteria>
- Fastify 5 installed with TypeScript configuration
- Health check endpoint at /health returns 200
- CORS configured for frontend origin
- Security headers via @fastify/helmet
- Workspace scripts (dev:api, build:api) work from root
- Combined dev script runs CMS and API together
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-04-SUMMARY.md`
</output>
