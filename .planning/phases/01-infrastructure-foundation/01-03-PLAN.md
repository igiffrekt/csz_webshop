---
phase: 01-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - apps/cms/package.json
  - apps/cms/config/database.ts
  - apps/cms/.env
  - apps/cms/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Strapi admin panel loads at http://localhost:1337/admin"
    - "Strapi connects to PostgreSQL database"
    - "Super Admin account can be created on first visit"
  artifacts:
    - path: "apps/cms/package.json"
      provides: "Strapi CMS package configuration"
      contains: "@strapi/strapi"
    - path: "apps/cms/config/database.ts"
      provides: "PostgreSQL database configuration"
      contains: "client: 'postgres'"
    - path: "apps/cms/.env"
      provides: "Environment variables for Strapi"
      contains: "DATABASE_HOST"
  key_links:
    - from: "apps/cms/config/database.ts"
      to: "PostgreSQL container"
      via: "pg driver connection"
      pattern: "host.*localhost.*5432"
---

<objective>
Install and configure Strapi 5 CMS with PostgreSQL connection

Purpose: Establish the headless CMS that will manage all content (products, categories, pages) for the webshop. Strapi provides the admin interface for Store Managers and Content Managers.

Output: Running Strapi 5 instance connected to PostgreSQL, accessible at http://localhost:1337/admin
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md
@.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md
@.planning/phases/01-infrastructure-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Strapi 5 project with PostgreSQL</name>
  <files>apps/cms/*</files>
  <action>
Ensure PostgreSQL is running first:
```bash
pnpm db:start
```

Create Strapi 5 project in apps/cms using the CLI with all flags to avoid interactive prompts:

```bash
npx create-strapi@latest apps/cms --typescript --skip-cloud --dbclient=postgres --dbhost=localhost --dbport=5432 --dbname=csz_strapi --dbusername=strapi --dbpassword=strapi --no-run
```

Flag explanations:
- --typescript: Use TypeScript (required for type safety)
- --skip-cloud: Skip Strapi Cloud signup prompt
- --dbclient=postgres: Use PostgreSQL instead of SQLite
- --dbhost/port/name/username/password: Match Docker Compose config
- --no-run: Don't start Strapi immediately (we need to install pg first)

After creation, install the PostgreSQL driver (REQUIRED - Strapi doesn't include it):
```bash
cd apps/cms && pnpm add pg
```
  </action>
  <verify>Check `apps/cms/package.json` contains @strapi/strapi and pg dependencies</verify>
  <done>Strapi 5 project created with TypeScript and PostgreSQL configuration</done>
</task>

<task type="auto">
  <name>Task 2: Configure Strapi environment and update root scripts</name>
  <files>apps/cms/.env, package.json</files>
  <action>
Verify apps/cms/.env has correct database configuration. If create-strapi didn't generate it properly, create/update it:

```bash
# apps/cms/.env
HOST=0.0.0.0
PORT=1337

# Security keys (these are generated by create-strapi, keep them)
APP_KEYS=toBeModified1,toBeModified2,toBeModified3,toBeModified4
API_TOKEN_SALT=tobemodified
ADMIN_JWT_SECRET=tobemodified
TRANSFER_TOKEN_SALT=tobemodified
JWT_SECRET=tobemodified

# Database (must match docker-compose.yml)
DATABASE_CLIENT=postgres
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=csz_strapi
DATABASE_USERNAME=strapi
DATABASE_PASSWORD=strapi
DATABASE_SSL=false
```

IMPORTANT: The security keys (APP_KEYS, *_SALT, *_SECRET) should be auto-generated. If they show placeholder values, generate random strings (32+ characters) for each.

Update root package.json to add CMS scripts:
```json
{
  "scripts": {
    "dev:cms": "pnpm --filter @csz/cms develop",
    "build:cms": "pnpm --filter @csz/cms build"
  }
}
```

Update apps/cms/package.json to set the package name:
```json
{
  "name": "@csz/cms"
}
```
  </action>
  <verify>Run `cat apps/cms/.env | grep DATABASE_HOST` to confirm database config exists</verify>
  <done>Strapi environment configured with correct PostgreSQL connection and workspace scripts added</done>
</task>

<task type="auto">
  <name>Task 3: Start Strapi and verify admin panel</name>
  <files>apps/cms/*</files>
  <action>
Start Strapi in development mode:
```bash
pnpm dev:cms
```

This will:
1. Connect to PostgreSQL
2. Run database migrations
3. Start the Strapi server on port 1337
4. Build the admin panel (first run takes 1-2 minutes)

Wait for the message: "Admin panel: http://localhost:1337/admin"

On first access to /admin, Strapi will prompt to create a Super Admin account. This is expected behavior - do NOT create the account in this task. Just verify the page loads.

Note: Leave Strapi running for Plan 05 (Role Configuration). If this plan is run independently, Strapi can be stopped with Ctrl+C.
  </action>
  <verify>Open http://localhost:1337/admin in browser - should show Super Admin registration form OR login page</verify>
  <done>Strapi is running and admin panel is accessible at http://localhost:1337/admin</done>
</task>

</tasks>

<verification>
1. `apps/cms/package.json` contains @strapi/strapi and pg
2. `apps/cms/.env` has DATABASE_HOST=localhost
3. `pnpm dev:cms` starts without database connection errors
4. http://localhost:1337/admin loads (registration or login page)
5. No "Cannot find module 'pg'" errors in console
</verification>

<success_criteria>
- Strapi 5 installed with TypeScript configuration
- PostgreSQL driver (pg) installed
- Database connection works (no connection errors on startup)
- Admin panel accessible at http://localhost:1337/admin
- Workspace scripts (dev:cms, build:cms) work from root
- Ready for Super Admin creation and role configuration
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-03-SUMMARY.md`
</output>
