---
phase: 10-design-migration-launch
task: 14
total_tasks: 14
status: architecture_migrated_all_committed
last_updated: 2026-02-07
---

<current_state>
MAJOR ARCHITECTURE CHANGE: The project migrated from Strapi/Fastify/PostgreSQL to Sanity/NextAuth/Prisma/MariaDB. All code is committed on branch `csz-webshop-sanity`. Working tree is clean. The original Phase 10 (design, migration, launch) plans from the Strapi era are complete but the STATE.md and PROJECT.md are stale and still reference the old Strapi architecture.

Key commits on this branch (newest first):
- 48b5e92 chore: update .gitignore and remove abandoned files
- 77a8f9d fix(web): frontend query, layout, and migration artifact fixes
- ece81cf fix: remove case-insensitive coupon lookup for MySQL compatibility
- 4bd391e feat: sync orders from Prisma to Sanity on checkout
- 51f8528 feat(studio): add order schemas and hierarchical content structure
- f416845 feat: switch database from PostgreSQL to MariaDB
- 2780d59 feat: Phase 4 - Sanity project setup, data migration & Prisma init
- c6120d3 feat: migrate from Strapi/Fastify to Sanity/NextAuth/Prisma (Phases 1-3, 5)
</current_state>

<completed_work>

**Architecture migration (previous sessions):**
- Strapi CMS replaced with Sanity (apps/studio)
- Fastify API backend removed, business logic moved to Next.js API routes
- PostgreSQL replaced with MariaDB 11 via Docker
- Strapi auth replaced with NextAuth + Prisma
- WooCommerce product data migrated to Sanity (146 products, 60 categories, 143 images)

**This session (2026-02-07):**
- Committed all uncommitted changes as 6 clean commits:
  1. Switch database from PostgreSQL to MariaDB
  2. Add order schemas and hierarchical content structure to Sanity Studio
  3. Add Sanity order sync from Prisma on checkout
  4. Fix coupon queries for MySQL compatibility (remove mode: 'insensitive')
  5. Frontend fixes: parent category queries, CategoryCard styling, masonry layout, cloudinary image fallback, portable-text migration artifact cleanup
  6. Update .gitignore, delete abandoned apps/vendure/ and temp scripts

</completed_work>

<remaining_work>

**Documentation updates needed:**
- STATE.md is stale — still references Strapi/Fastify architecture
- PROJECT.md key decisions table still says "Strapi for CMS"
- .continue-here.md decisions section referenced Strapi

**Functional work remaining:**
1. Visual testing — review site at http://localhost:3000
2. Production deployment — MariaDB, Sanity, Stripe live keys, SMTP, DNS/SSL
3. Background removal for product images — rembg incompatible with Python 3.14
4. Stripe live credentials needed
5. Domain/SSL setup needed

**Current architecture:**
- Frontend: Next.js (apps/web) at localhost:3000
- CMS: Sanity Studio (apps/studio) — sanity.io hosted
- Database: MariaDB 11 via Docker (localhost:3306)
- Auth: NextAuth with Prisma adapter
- Payments: Stripe (dev keys)
- Orders: Prisma (source of truth) → synced to Sanity for admin visibility

</remaining_work>

<decisions_made>

- PostgreSQL → MariaDB 11 (this session, committed)
- Prisma coupon lookups use default collation instead of mode: 'insensitive' (MySQL compat)
- Orders sync to Sanity fire-and-forget after Prisma write (non-blocking)
- Sanity Studio structure uses hierarchical category browsing with GROQ queries
- Abandoned Vendure migration attempt deleted (was in apps/vendure/)
- apps/studio/.sanity/ and nul added to .gitignore

</decisions_made>

<blockers>
- Production infrastructure not provisioned
- Stripe live keys not available
- STATE.md/PROJECT.md out of date (cosmetic, not blocking)
</blockers>

<context>
The project went through multiple CMS attempts: Strapi → Vendure → Sanity. The Sanity migration is now stable and committed. All 10 original phases of work are implemented. The codebase is on branch `csz-webshop-sanity` and the working tree is clean. The main remaining work is deployment and production configuration — no major feature development left.
</context>

<next_action>
1. Update STATE.md and PROJECT.md to reflect Sanity/NextAuth/Prisma/MariaDB architecture
2. Visual testing at localhost:3000 (docker compose up for MariaDB first)
3. Plan production deployment
4. Configure Stripe live keys and deploy
</next_action>

<environment>
- Branch: csz-webshop-sanity
- Next.js: http://localhost:3000 (needs `pnpm dev` in apps/web)
- Sanity Studio: http://localhost:3333 (needs `pnpm dev` in apps/studio)
- MariaDB: Docker container at localhost:3306 (needs `docker compose -f docker/docker-compose.yml up -d`)
- Working tree: CLEAN
</environment>
