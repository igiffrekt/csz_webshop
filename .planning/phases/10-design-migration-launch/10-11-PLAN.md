---
phase: 10-design-migration-launch
plan: 11
type: implement
wave: 6
depends_on: [10-10]
files_modified:
  - scripts/migration/woocommerce-import.ts
  - scripts/migration/README.md
autonomous: false

must_haves:
  truths:
    - "WooCommerce data can be imported"
    - "Products migrated to Strapi"
  artifacts:
    - scripts/migration/woocommerce-import.ts
---

<objective>
Create WooCommerce migration scripts to import existing data.

Purpose: Migrate products, categories, and customers from WooCommerce.

Output: Migration scripts for data import.
</objective>

<tasks>

<task type="manual">
  <name>Task 1: Export WooCommerce data</name>
  <action>
Export data from WooCommerce:

1. **Products Export**
   - WooCommerce > Products > Export
   - Export all fields as CSV
   - Save as `data/woocommerce-products.csv`

2. **Categories Export**
   - WooCommerce > Products > Categories
   - Export or manually document category hierarchy

3. **Customers Export** (optional)
   - WooCommerce > Users > Export
   - Or use plugin for customer export

4. **Orders Export** (optional)
   - WooCommerce > Orders > Export
   - For order history preservation
  </action>
  <verify>
    - CSV files exported
    - Data looks complete
  </verify>
  <done>WooCommerce data exported</done>
</task>

<task type="auto">
  <name>Task 2: Create migration script</name>
  <files>
    scripts/migration/woocommerce-import.ts
  </files>
  <action>
Create migration script:

```typescript
import fs from 'fs';
import path from 'path';
import { parse } from 'csv-parse/sync';

const STRAPI_URL = process.env.STRAPI_URL || 'http://localhost:1337';
const STRAPI_TOKEN = process.env.STRAPI_ADMIN_TOKEN;

interface WooProduct {
  ID: string;
  Type: string;
  SKU: string;
  Name: string;
  Published: string;
  'Short description': string;
  Description: string;
  'Regular price': string;
  'Sale price': string;
  Categories: string;
  Images: string;
  Stock: string;
  // Add more fields as needed
}

async function importCategories(products: WooProduct[]) {
  // Extract unique categories
  const categoriesSet = new Set<string>();
  products.forEach((p) => {
    if (p.Categories) {
      p.Categories.split(',').forEach((cat) => {
        categoriesSet.add(cat.trim());
      });
    }
  });

  const categories = Array.from(categoriesSet);
  console.log(`Found ${categories.length} unique categories`);

  // Create categories in Strapi
  for (const categoryName of categories) {
    const slug = categoryName
      .toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');

    try {
      const response = await fetch(`${STRAPI_URL}/api/categories`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${STRAPI_TOKEN}`,
        },
        body: JSON.stringify({
          data: {
            name: categoryName,
            slug,
          },
        }),
      });

      if (response.ok) {
        console.log(`✓ Created category: ${categoryName}`);
      } else {
        const error = await response.json();
        console.log(`⚠ Category exists or error: ${categoryName}`, error);
      }
    } catch (error) {
      console.error(`✗ Failed to create category: ${categoryName}`, error);
    }
  }
}

async function importProducts(products: WooProduct[]) {
  console.log(`\nImporting ${products.length} products...`);

  // First, get category mapping
  const categoriesRes = await fetch(`${STRAPI_URL}/api/categories`);
  const categoriesData = await categoriesRes.json();
  const categoryMap = new Map(
    categoriesData.data.map((c: any) => [c.attributes.name, c.id])
  );

  for (const product of products) {
    // Skip variable products (handle variations separately)
    if (product.Type === 'variable') continue;

    const slug = product.Name
      .toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');

    // Find category ID
    const categoryName = product.Categories?.split(',')[0]?.trim();
    const categoryId = categoryMap.get(categoryName);

    try {
      const response = await fetch(`${STRAPI_URL}/api/products`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${STRAPI_TOKEN}`,
        },
        body: JSON.stringify({
          data: {
            name: product.Name,
            slug,
            sku: product.SKU || `SKU-${product.ID}`,
            shortDescription: product['Short description'],
            description: product.Description,
            basePrice: parseFloat(product['Regular price']) || 0,
            compareAtPrice: product['Sale price']
              ? parseFloat(product['Regular price'])
              : null,
            stock: parseInt(product.Stock) || 0,
            isActive: product.Published === '1',
            category: categoryId || null,
          },
        }),
      });

      if (response.ok) {
        console.log(`✓ Created product: ${product.Name}`);
      } else {
        const error = await response.json();
        console.log(`⚠ Product error: ${product.Name}`, error);
      }
    } catch (error) {
      console.error(`✗ Failed to create product: ${product.Name}`, error);
    }
  }
}

async function main() {
  const csvPath = process.argv[2] || 'data/woocommerce-products.csv';

  if (!fs.existsSync(csvPath)) {
    console.error(`CSV file not found: ${csvPath}`);
    process.exit(1);
  }

  if (!STRAPI_TOKEN) {
    console.error('STRAPI_ADMIN_TOKEN environment variable required');
    process.exit(1);
  }

  const csvContent = fs.readFileSync(csvPath, 'utf-8');
  const products: WooProduct[] = parse(csvContent, {
    columns: true,
    skip_empty_lines: true,
  });

  console.log(`Loaded ${products.length} products from CSV`);

  // Import in order
  await importCategories(products);
  await importProducts(products);

  console.log('\nMigration complete!');
}

main().catch(console.error);
```
  </action>
  <verify>
    - Script parses CSV
    - Creates categories
    - Creates products
  </verify>
  <done>Migration script created</done>
</task>

<task type="auto">
  <name>Task 3: Create migration README</name>
  <files>
    scripts/migration/README.md
  </files>
  <action>
Create migration documentation:

```markdown
# WooCommerce Migration

## Prerequisites

1. Export WooCommerce data:
   - Products > Export (CSV)
   - Place in `data/woocommerce-products.csv`

2. Set environment variables:
   ```bash
   export STRAPI_URL=http://localhost:1337
   export STRAPI_ADMIN_TOKEN=your-api-token
   ```

## Running Migration

```bash
# Install dependencies
pnpm install csv-parse

# Run migration
npx tsx scripts/migration/woocommerce-import.ts data/woocommerce-products.csv
```

## Data Mapping

| WooCommerce | Strapi |
|------------|--------|
| Name | name |
| SKU | sku |
| Short description | shortDescription |
| Description | description |
| Regular price | basePrice |
| Sale price → Regular price | compareAtPrice |
| Stock | stock |
| Categories | category (first) |

## Post-Migration

1. Review imported products in Strapi
2. Upload images manually or via media upload script
3. Add certifications and specifications
4. Publish products
```
  </action>
  <verify>
    - README documents process
  </verify>
  <done>README created</done>
</task>

<task type="auto">
  <name>Task 4: Create migration folder structure</name>
  <files>
    -
  </files>
  <action>
Create folder structure:

```bash
mkdir -p scripts/migration
mkdir -p data
```
  </action>
  <verify>
    - Folders exist
  </verify>
  <done>Folders created</done>
</task>

</tasks>

<verification>
- Migration script can parse WooCommerce CSV
- Categories import correctly
- Products import correctly
</verification>

<success_criteria>
- All WooCommerce products can be migrated
- Data integrity maintained
</success_criteria>
