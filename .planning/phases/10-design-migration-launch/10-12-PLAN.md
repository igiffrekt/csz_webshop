---
phase: 10-design-migration-launch
plan: 12
type: implement
wave: 6
depends_on: [10-11]
files_modified:
  - apps/web/next.config.ts
  - scripts/migration/generate-redirects.ts
autonomous: false

must_haves:
  truths:
    - "Old URLs redirect to new URLs"
    - "SEO preserved"
  artifacts:
    - apps/web/redirects.json
---

<objective>
Implement URL redirects for SEO preservation during migration.

Purpose: Prevent 404 errors and preserve search rankings.

Output: Redirect configuration for all old WooCommerce URLs.
</objective>

<tasks>

<task type="manual">
  <name>Task 1: Crawl existing site URLs</name>
  <action>
Crawl current WooCommerce site for all URLs:

Option A - Using screaming frog or similar:
1. Crawl entire site
2. Export all URLs to CSV
3. Save as `data/old-urls.csv`

Option B - Using sitemap:
1. Download sitemap.xml from current site
2. Extract all URLs
3. Categorize: products, categories, pages

Option C - Manual inventory:
1. List all product URLs
2. List all category URLs
3. List all page URLs
  </action>
  <verify>
    - URL inventory complete
    - All URLs documented
  </verify>
  <done>URLs inventoried</done>
</task>

<task type="auto">
  <name>Task 2: Create redirect mapping script</name>
  <files>
    scripts/migration/generate-redirects.ts
  </files>
  <action>
Create script to generate redirect mappings:

```typescript
import fs from 'fs';

interface Redirect {
  source: string;
  destination: string;
  permanent: boolean;
}

// Common WooCommerce URL patterns
const urlMappings: Record<string, string> = {
  // Product URLs
  '/product/': '/termekek/',
  '/termek/': '/termekek/',

  // Category URLs
  '/product-category/': '/kategoriak/',
  '/termek-kategoria/': '/kategoriak/',

  // Page URLs (adjust based on actual pages)
  '/rolunk-2/': '/rolunk',
  '/kapcsolat-2/': '/kapcsolat',
  '/gyik-2/': '/gyik',

  // Cart/Checkout
  '/cart/': '/penztar',
  '/kosar/': '/penztar',
  '/checkout/': '/penztar',
  '/penztar-2/': '/penztar',

  // Account
  '/my-account/': '/fiok',
  '/fiokom/': '/fiok',
};

function generateRedirects(oldUrls: string[]): Redirect[] {
  const redirects: Redirect[] = [];

  for (const oldUrl of oldUrls) {
    let newUrl = oldUrl;

    // Apply URL pattern mappings
    for (const [oldPattern, newPattern] of Object.entries(urlMappings)) {
      if (oldUrl.includes(oldPattern)) {
        newUrl = oldUrl.replace(oldPattern, newPattern);
        break;
      }
    }

    // Clean up URL (remove trailing slashes, etc.)
    newUrl = newUrl.replace(/\/+$/, '');

    if (oldUrl !== newUrl) {
      redirects.push({
        source: oldUrl,
        destination: newUrl,
        permanent: true, // 301 redirect
      });
    }
  }

  return redirects;
}

// Also add catch-all redirects for common patterns
function generatePatternRedirects(): Redirect[] {
  return [
    {
      source: '/product/:slug',
      destination: '/termekek/:slug',
      permanent: true,
    },
    {
      source: '/termek/:slug',
      destination: '/termekek/:slug',
      permanent: true,
    },
    {
      source: '/product-category/:slug',
      destination: '/kategoriak/:slug',
      permanent: true,
    },
    {
      source: '/termek-kategoria/:slug',
      destination: '/kategoriak/:slug',
      permanent: true,
    },
    {
      source: '/shop',
      destination: '/termekek',
      permanent: true,
    },
    {
      source: '/bolt',
      destination: '/termekek',
      permanent: true,
    },
  ];
}

async function main() {
  // Load old URLs if available
  const urlsPath = 'data/old-urls.csv';
  let oldUrls: string[] = [];

  if (fs.existsSync(urlsPath)) {
    const content = fs.readFileSync(urlsPath, 'utf-8');
    oldUrls = content.split('\n').filter(Boolean);
    console.log(`Loaded ${oldUrls.length} URLs from ${urlsPath}`);
  }

  // Generate redirects
  const specificRedirects = generateRedirects(oldUrls);
  const patternRedirects = generatePatternRedirects();

  const allRedirects = [...patternRedirects, ...specificRedirects];

  // Output to JSON file
  const outputPath = 'apps/web/redirects.json';
  fs.writeFileSync(outputPath, JSON.stringify(allRedirects, null, 2));
  console.log(`Generated ${allRedirects.length} redirects to ${outputPath}`);

  // Also output for next.config.ts format
  console.log('\nAdd to next.config.ts:');
  console.log('async redirects() {');
  console.log('  return [');
  patternRedirects.forEach((r) => {
    console.log(`    { source: '${r.source}', destination: '${r.destination}', permanent: ${r.permanent} },`);
  });
  console.log('  ];');
  console.log('}');
}

main().catch(console.error);
```
  </action>
  <verify>
    - Script generates redirects
    - Output valid JSON
  </verify>
  <done>Redirect script created</done>
</task>

<task type="auto">
  <name>Task 3: Update next.config.ts with redirects</name>
  <files>
    apps/web/next.config.ts
  </files>
  <action>
Add redirects to Next.js config:

```typescript
// In next.config.ts
const nextConfig = {
  // ... existing config

  async redirects() {
    return [
      // Product URL redirects
      {
        source: '/product/:slug',
        destination: '/termekek/:slug',
        permanent: true,
      },
      {
        source: '/termek/:slug',
        destination: '/termekek/:slug',
        permanent: true,
      },
      // Category URL redirects
      {
        source: '/product-category/:slug',
        destination: '/kategoriak/:slug',
        permanent: true,
      },
      {
        source: '/termek-kategoria/:slug',
        destination: '/kategoriak/:slug',
        permanent: true,
      },
      // Shop page
      {
        source: '/shop',
        destination: '/termekek',
        permanent: true,
      },
      {
        source: '/bolt',
        destination: '/termekek',
        permanent: true,
      },
      // Cart
      {
        source: '/cart',
        destination: '/penztar',
        permanent: true,
      },
      {
        source: '/kosar',
        destination: '/penztar',
        permanent: true,
      },
      // Account
      {
        source: '/my-account/:path*',
        destination: '/fiok/:path*',
        permanent: true,
      },
      {
        source: '/fiokom/:path*',
        destination: '/fiok/:path*',
        permanent: true,
      },
    ];
  },
};
```
  </action>
  <verify>
    - Redirects configured
    - Build passes
  </verify>
  <done>next.config.ts updated</done>
</task>

<task type="manual">
  <name>Task 4: Test redirects</name>
  <action>
Test redirect functionality:

1. Start dev server
2. Test each redirect pattern
3. Verify 301 status codes
4. Check destination is correct

Test URLs:
- /product/test-product → /termekek/test-product
- /product-category/tuzolto → /kategoriak/tuzolto
- /shop → /termekek
- /cart → /penztar
  </action>
  <verify>
    - All redirects work
    - 301 status returned
  </verify>
  <done>Redirects tested</done>
</task>

</tasks>

<verification>
- All old URLs redirect to new URLs
- 301 permanent redirects used
- SEO rankings preserved
</verification>

<success_criteria>
- No 404 errors for old URLs
- Search engines follow redirects
</success_criteria>
