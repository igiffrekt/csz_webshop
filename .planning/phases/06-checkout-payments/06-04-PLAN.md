---
phase: 06-checkout-payments
plan: 04
type: execute
wave: 2
depends_on: [06-03]
files_modified:
  - apps/web/src/app/[locale]/penztar/page.tsx
  - apps/web/src/app/[locale]/penztar/CheckoutClient.tsx
  - apps/web/src/app/[locale]/penztar/steps/ShippingStep.tsx
  - apps/web/src/components/ui/radio-group.tsx
  - apps/web/src/i18n/messages/hu.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Anonymous users are redirected to login from /penztar"
    - "User can select from saved shipping addresses"
    - "User can enter new shipping address inline"
    - "Default address is pre-selected"
    - "Continue button disabled until address selected or entered"
  artifacts:
    - path: "apps/web/src/app/[locale]/penztar/page.tsx"
      provides: "Checkout page with auth protection"
      contains: "requireAuth"
    - path: "apps/web/src/app/[locale]/penztar/steps/ShippingStep.tsx"
      provides: "Shipping address step component"
      contains: "ShippingAddress"
    - path: "apps/web/src/app/[locale]/penztar/CheckoutClient.tsx"
      provides: "Client-side checkout orchestration"
      contains: "useCheckoutStore"
  key_links:
    - from: "page.tsx"
      to: "dal.ts requireAuth"
      via: "import and call"
      pattern: "requireAuth"
    - from: "ShippingStep.tsx"
      to: "address-api.ts"
      via: "getAddresses fetch"
      pattern: "getAddresses|addresses"
---

<objective>
Create the checkout page with authentication protection and the shipping address selection step.

Purpose: Checkout requires authentication (CHKT-01) and shipping address selection (CHKT-02, CHKT-03). This plan implements the checkout page shell and the first step of the multi-step checkout flow.

Output: Protected checkout page at /penztar with shipping address step (saved addresses list + new address option).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-checkout-payments/06-RESEARCH.md

Reference existing auth and address patterns:
@apps/web/src/lib/auth/dal.ts
@apps/web/src/lib/address-api.ts
@apps/web/src/app/[locale]/fiok/cimek/page.tsx
@apps/web/src/stores/checkout.ts (created in 06-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shadcn/ui RadioGroup component</name>
  <files>apps/web/src/components/ui/radio-group.tsx</files>
  <action>
Add the RadioGroup component from shadcn/ui for address selection:

```bash
cd apps/web
npx shadcn@latest add radio-group
```

This creates `apps/web/src/components/ui/radio-group.tsx` with:
- RadioGroup container
- RadioGroupItem with indicator

If the CLI fails, manually create the component following shadcn/ui patterns (uses @radix-ui/react-radio-group).
  </action>
  <verify>
    - radio-group.tsx exists in components/ui
    - Exports RadioGroup and RadioGroupItem
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>RadioGroup component added for address selection</done>
</task>

<task type="auto">
  <name>Task 2: Create checkout page with auth protection</name>
  <files>
    apps/web/src/app/[locale]/penztar/page.tsx
    apps/web/src/app/[locale]/penztar/CheckoutClient.tsx
  </files>
  <action>
Create checkout page at `apps/web/src/app/[locale]/penztar/page.tsx`:

```typescript
import { redirect } from 'next/navigation';
import { requireAuth } from '@/lib/auth/dal';
import { getAddresses } from '@/lib/address-api';
import { CheckoutClient } from './CheckoutClient';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Penztar | CSZ Tuzvedelmi Webshop',
  description: 'Rendelese befejezese',
};

export default async function CheckoutPage() {
  // Require authentication - redirects to login if not authenticated
  await requireAuth();

  // Fetch saved addresses
  const { data: addresses, error } = await getAddresses();

  if (error) {
    // Handle error - could redirect or show message
    console.error('Failed to fetch addresses:', error);
  }

  return (
    <main className="container mx-auto px-4 py-8 max-w-4xl">
      <h1 className="text-2xl font-bold mb-8">Penztar</h1>
      <CheckoutClient initialAddresses={addresses || []} />
    </main>
  );
}
```

Create checkout client orchestrator at `apps/web/src/app/[locale]/penztar/CheckoutClient.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useCheckoutStore, useCheckoutStep } from '@/stores/checkout';
import { useCartStore, useCartItems } from '@/stores/cart';
import { useHydration } from '@/stores/useHydration';
import { ShippingStep } from './steps/ShippingStep';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import type { ShippingAddress } from '@csz/types';

// Step indicator component
function StepIndicator({ currentStep }: { currentStep: string }) {
  const steps = [
    { key: 'shipping', label: 'Szallitas' },
    { key: 'billing', label: 'Szamlazas' },
    { key: 'summary', label: 'Osszegzes' },
    { key: 'payment', label: 'Fizetes' },
  ];

  const currentIndex = steps.findIndex(s => s.key === currentStep);

  return (
    <nav className="mb-8">
      <ol className="flex items-center gap-2">
        {steps.map((step, index) => (
          <li key={step.key} className="flex items-center">
            <span
              className={`
                flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium
                ${index <= currentIndex
                  ? 'bg-primary text-primary-foreground'
                  : 'bg-muted text-muted-foreground'
                }
              `}
            >
              {index + 1}
            </span>
            <span
              className={`ml-2 text-sm ${index === currentIndex ? 'font-medium' : 'text-muted-foreground'}`}
            >
              {step.label}
            </span>
            {index < steps.length - 1 && (
              <span className="mx-4 h-px w-8 bg-border" />
            )}
          </li>
        ))}
      </ol>
    </nav>
  );
}

interface CheckoutClientProps {
  initialAddresses: ShippingAddress[];
}

export function CheckoutClient({ initialAddresses }: CheckoutClientProps) {
  const hydrated = useHydration();
  const step = useCheckoutStep();
  const items = useCartItems();
  const cartStore = useCartStore();

  // Reset checkout if cart is empty (after hydration)
  useEffect(() => {
    if (hydrated && items.length === 0) {
      useCheckoutStore.getState().reset();
    }
  }, [hydrated, items.length]);

  // Show loading state during hydration
  if (!hydrated) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-pulse text-muted-foreground">Betoltes...</div>
      </div>
    );
  }

  // Empty cart state
  if (items.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-muted-foreground mb-4">A kosara ures.</p>
        <Button asChild>
          <Link href="/termekek">Termekek bongeszese</Link>
        </Button>
      </div>
    );
  }

  return (
    <div>
      <StepIndicator currentStep={step} />

      <div className="grid lg:grid-cols-3 gap-8">
        {/* Main checkout form */}
        <div className="lg:col-span-2">
          {step === 'shipping' && (
            <ShippingStep addresses={initialAddresses} />
          )}
          {step === 'billing' && (
            <div className="p-8 border rounded-lg">
              <p className="text-muted-foreground">Szamlazas (kovetkezo plan)</p>
            </div>
          )}
          {step === 'summary' && (
            <div className="p-8 border rounded-lg">
              <p className="text-muted-foreground">Osszegzes (kovetkezo plan)</p>
            </div>
          )}
          {step === 'payment' && (
            <div className="p-8 border rounded-lg">
              <p className="text-muted-foreground">Fizetes (kovetkezo plan)</p>
            </div>
          )}
        </div>

        {/* Order summary sidebar */}
        <div className="lg:col-span-1">
          <div className="border rounded-lg p-6 sticky top-4">
            <h2 className="font-semibold mb-4">Rendeles osszegzese</h2>

            <div className="space-y-3 mb-4">
              {items.map((item) => (
                <div key={item.id} className="flex justify-between text-sm">
                  <span className="text-muted-foreground">
                    {item.name} {item.variantName && `(${item.variantName})`} x {item.quantity}
                  </span>
                  <span>{(item.price * item.quantity).toLocaleString('hu-HU')} Ft</span>
                </div>
              ))}
            </div>

            <div className="border-t pt-4 space-y-2">
              <div className="flex justify-between text-sm">
                <span>Reszosszeg</span>
                <span>{cartStore.getSubtotal().toLocaleString('hu-HU')} Ft</span>
              </div>
              {cartStore.coupon && (
                <div className="flex justify-between text-sm text-green-600">
                  <span>Kedvezmeny ({cartStore.coupon.code})</span>
                  <span>-{cartStore.getDiscount().toLocaleString('hu-HU')} Ft</span>
                </div>
              )}
              <div className="flex justify-between text-sm">
                <span>Szallitas</span>
                <span className="text-muted-foreground">Szamolva...</span>
              </div>
              <div className="flex justify-between font-semibold pt-2 border-t">
                <span>Osszesen</span>
                <span>{cartStore.getTotal().toLocaleString('hu-HU')} Ft</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

Note: The sidebar shows cart-side totals initially. Real totals will be fetched from server in the summary step.
  </action>
  <verify>
    - page.tsx calls requireAuth() before rendering
    - page.tsx fetches addresses server-side
    - CheckoutClient shows step indicator
    - CheckoutClient handles empty cart state
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Protected checkout page created with client orchestrator and step navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create shipping address step</name>
  <files>apps/web/src/app/[locale]/penztar/steps/ShippingStep.tsx</files>
  <action>
Create shipping step at `apps/web/src/app/[locale]/penztar/steps/ShippingStep.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useCheckoutStore } from '@/stores/checkout';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { PlusCircle, MapPin } from 'lucide-react';
import type { ShippingAddress } from '@csz/types';

interface ShippingStepProps {
  addresses: ShippingAddress[];
}

export function ShippingStep({ addresses }: ShippingStepProps) {
  const {
    shippingAddressId,
    useNewShippingAddress,
    newShippingAddress,
    setShippingAddressId,
    setUseNewShippingAddress,
    setNewShippingAddress,
    nextStep,
  } = useCheckoutStore();

  // Form state for new address
  const [newAddress, setNewAddress] = useState({
    recipientName: newShippingAddress?.recipientName || '',
    street: newShippingAddress?.street || '',
    city: newShippingAddress?.city || '',
    postalCode: newShippingAddress?.postalCode || '',
    country: newShippingAddress?.country || 'Magyarorszag',
    phone: newShippingAddress?.phone || '',
  });

  // Find default address
  const defaultAddress = addresses.find(a => a.isDefault);

  // Set default address on first load if nothing selected
  useState(() => {
    if (!shippingAddressId && !useNewShippingAddress && defaultAddress) {
      setShippingAddressId(defaultAddress.documentId);
    }
  });

  const handleAddressSelect = (value: string) => {
    if (value === 'new') {
      setUseNewShippingAddress(true);
    } else {
      setShippingAddressId(value);
    }
  };

  const handleNewAddressChange = (field: string, value: string) => {
    const updated = { ...newAddress, [field]: value };
    setNewAddress(updated);
    setNewShippingAddress(updated);
  };

  const canContinue = () => {
    if (useNewShippingAddress) {
      return (
        newAddress.recipientName.trim() &&
        newAddress.street.trim() &&
        newAddress.city.trim() &&
        newAddress.postalCode.trim()
      );
    }
    return !!shippingAddressId;
  };

  const handleContinue = () => {
    if (canContinue()) {
      nextStep();
    }
  };

  const selectedValue = useNewShippingAddress ? 'new' : (shippingAddressId || '');

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold">Szallitasi cim</h2>
        {addresses.length > 0 && (
          <Button variant="ghost" size="sm" asChild>
            <Link href="/fiok/cimek">
              <MapPin className="h-4 w-4 mr-1" />
              Cimek kezelese
            </Link>
          </Button>
        )}
      </div>

      {addresses.length === 0 && !useNewShippingAddress ? (
        // No saved addresses - show new address form directly
        <div className="text-center py-8 border rounded-lg">
          <p className="text-muted-foreground mb-4">
            Nincs mentett szallitasi cime.
          </p>
          <Button onClick={() => setUseNewShippingAddress(true)}>
            <PlusCircle className="h-4 w-4 mr-2" />
            Uj cim megadasa
          </Button>
        </div>
      ) : (
        <RadioGroup value={selectedValue} onValueChange={handleAddressSelect}>
          {/* Saved addresses */}
          {addresses.map((address) => (
            <div
              key={address.documentId}
              className={`
                flex items-start space-x-3 p-4 border rounded-lg cursor-pointer
                ${selectedValue === address.documentId ? 'border-primary bg-primary/5' : 'hover:border-primary/50'}
              `}
            >
              <RadioGroupItem value={address.documentId} id={address.documentId} />
              <Label htmlFor={address.documentId} className="flex-1 cursor-pointer">
                <div className="flex items-center gap-2">
                  <span className="font-medium">{address.label}</span>
                  {address.isDefault && (
                    <span className="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded">
                      Alapertelmezett
                    </span>
                  )}
                </div>
                <div className="text-sm text-muted-foreground mt-1">
                  <p>{address.recipientName}</p>
                  <p>{address.street}</p>
                  <p>{address.postalCode} {address.city}</p>
                  {address.phone && <p>Tel: {address.phone}</p>}
                </div>
              </Label>
            </div>
          ))}

          {/* New address option */}
          <div
            className={`
              flex items-start space-x-3 p-4 border rounded-lg cursor-pointer
              ${selectedValue === 'new' ? 'border-primary bg-primary/5' : 'hover:border-primary/50'}
            `}
          >
            <RadioGroupItem value="new" id="new-address" />
            <Label htmlFor="new-address" className="flex-1 cursor-pointer">
              <div className="flex items-center gap-2">
                <PlusCircle className="h-4 w-4" />
                <span className="font-medium">Uj cim megadasa</span>
              </div>
            </Label>
          </div>
        </RadioGroup>
      )}

      {/* New address form */}
      {useNewShippingAddress && (
        <div className="border rounded-lg p-6 space-y-4 mt-4">
          <div className="grid gap-4 sm:grid-cols-2">
            <div className="sm:col-span-2">
              <Label htmlFor="recipientName">Cimzett neve *</Label>
              <Input
                id="recipientName"
                value={newAddress.recipientName}
                onChange={(e) => handleNewAddressChange('recipientName', e.target.value)}
                placeholder="Kovacs Janos"
              />
            </div>

            <div className="sm:col-span-2">
              <Label htmlFor="street">Utca, hazszam *</Label>
              <Input
                id="street"
                value={newAddress.street}
                onChange={(e) => handleNewAddressChange('street', e.target.value)}
                placeholder="Petofi utca 10."
              />
            </div>

            <div>
              <Label htmlFor="postalCode">Iranyitoszam *</Label>
              <Input
                id="postalCode"
                value={newAddress.postalCode}
                onChange={(e) => handleNewAddressChange('postalCode', e.target.value)}
                placeholder="1234"
              />
            </div>

            <div>
              <Label htmlFor="city">Varos *</Label>
              <Input
                id="city"
                value={newAddress.city}
                onChange={(e) => handleNewAddressChange('city', e.target.value)}
                placeholder="Budapest"
              />
            </div>

            <div>
              <Label htmlFor="country">Orszag</Label>
              <Input
                id="country"
                value={newAddress.country}
                onChange={(e) => handleNewAddressChange('country', e.target.value)}
                disabled
              />
              <p className="text-xs text-muted-foreground mt-1">
                Csak Magyarorszagra szallitunk
              </p>
            </div>

            <div>
              <Label htmlFor="phone">Telefonszam</Label>
              <Input
                id="phone"
                value={newAddress.phone}
                onChange={(e) => handleNewAddressChange('phone', e.target.value)}
                placeholder="+36 30 123 4567"
              />
            </div>
          </div>
        </div>
      )}

      {/* Navigation */}
      <div className="flex justify-between pt-6 border-t">
        <Button variant="outline" asChild>
          <Link href="/kosar">Vissza a kosarhoz</Link>
        </Button>
        <Button onClick={handleContinue} disabled={!canContinue()}>
          Tovabb a szamlazashoz
        </Button>
      </div>
    </div>
  );
}
```

This provides:
- List of saved addresses with radio selection
- Default address pre-selected and highlighted
- New address option with inline form
- Validation before proceeding
- Country locked to Hungary
- Back link to cart
  </action>
  <verify>
    - ShippingStep.tsx renders saved addresses as RadioGroup
    - Default address has badge and is pre-selected
    - New address form validates required fields
    - Continue button disabled until valid selection
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Shipping address step created with saved address selection and new address form</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds: `pnpm --filter @csz/web build`
2. Start dev server: `cd apps/web && pnpm dev`
3. Navigate to /penztar while not logged in - should redirect to login
4. Log in and navigate to /penztar - should see checkout page
5. Shipping step shows saved addresses (or prompts to add new)
6. Default address is pre-selected
7. New address form appears when selected

Test auth protection:
```bash
# In incognito/new session, visit:
http://localhost:3000/hu/penztar
# Should redirect to /auth/bejelentkezes?redirect=/hu/penztar
```
</verification>

<success_criteria>
- Anonymous users redirect to login from /penztar (CHKT-01)
- User can select from saved shipping addresses (CHKT-03)
- User can enter new shipping address (CHKT-02)
- Default address is pre-selected
- Country locked to Hungary (SHIP-03)
- Step indicator shows current progress
- Cart summary visible in sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/06-checkout-payments/06-04-SUMMARY.md`
</output>
