---
phase: 06-checkout-payments
plan: 05
type: execute
wave: 2
depends_on: [06-03]
files_modified:
  - apps/web/src/app/[locale]/penztar/steps/BillingStep.tsx
  - apps/web/src/app/[locale]/penztar/steps/SummaryStep.tsx
  - apps/web/src/lib/checkout-api.ts
  - apps/web/src/app/[locale]/penztar/CheckoutClient.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can use shipping address as billing address"
    - "User can enter different billing address with company info"
    - "User can enter purchase order reference number"
    - "Order summary shows itemized breakdown with VAT"
    - "Summary totals are fetched from server, not calculated client-side"
  artifacts:
    - path: "apps/web/src/app/[locale]/penztar/steps/BillingStep.tsx"
      provides: "Billing address step with B2B fields"
      contains: "vatNumber"
    - path: "apps/web/src/app/[locale]/penztar/steps/SummaryStep.tsx"
      provides: "Order summary with VAT breakdown"
      contains: "vatAmount"
    - path: "apps/web/src/lib/checkout-api.ts"
      provides: "Checkout API client functions"
      contains: "calculateTotals"
  key_links:
    - from: "SummaryStep.tsx"
      to: "checkout-api.ts"
      via: "calculateTotals fetch"
      pattern: "calculateTotals"
    - from: "checkout-api.ts"
      to: "Fastify /checkout/calculate"
      via: "fetch"
      pattern: "checkout/calculate"
---

<objective>
Create the billing address step and order summary step with server-side totals calculation.

Purpose: CHKT-04 requires billing address handling, CHKT-05 requires itemized summary with VAT, CHKT-07 requires PO reference, and CHKT-08 requires 27% VAT display. The summary step fetches server-calculated totals.

Output: Billing step with same-as-shipping option and B2B fields, Summary step with VAT breakdown from server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-checkout-payments/06-RESEARCH.md

Reference checkout patterns:
@apps/web/src/stores/checkout.ts
@apps/web/src/app/[locale]/penztar/steps/ShippingStep.tsx (created in 06-04)
@apps/api/src/routes/checkout/calculate.ts (created in 06-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create checkout API client</name>
  <files>apps/web/src/lib/checkout-api.ts</files>
  <action>
Create checkout API client at `apps/web/src/lib/checkout-api.ts`:

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000';

interface LineItem {
  productId: string;
  variantId?: string;
  quantity: number;
}

export interface CalculateTotalsRequest {
  lineItems: LineItem[];
  couponCode?: string;
  shippingCountry: string;
}

export interface CalculateTotalsResponse {
  subtotal: number;
  discount: number;
  shipping: number;
  netTotal: number;
  vatAmount: number;
  total: number;
  freeShippingThreshold: number;
  couponApplied: boolean;
  couponError?: string;
}

/**
 * Calculate order totals from server
 * CRITICAL: Never calculate VAT, shipping, or discounts client-side
 */
export async function calculateTotals(
  request: CalculateTotalsRequest
): Promise<{ data: CalculateTotalsResponse | null; error?: string }> {
  try {
    const response = await fetch(`${API_URL}/checkout/calculate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(request),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      return { data: null, error: errorData.error || 'Hiba tortent a szamitasnal' };
    }

    const data = await response.json();
    return { data };
  } catch {
    return { data: null, error: 'Kapcsolodasi hiba' };
  }
}

/**
 * Format price in Hungarian Forint
 */
export function formatHUF(amount: number): string {
  return amount.toLocaleString('hu-HU') + ' Ft';
}

/**
 * Format date in Hungarian format
 */
export function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('hu-HU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
```
  </action>
  <verify>
    - checkout-api.ts exports calculateTotals, formatHUF, formatDate
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Checkout API client created for server-side calculations</done>
</task>

<task type="auto">
  <name>Task 2: Create billing step component</name>
  <files>apps/web/src/app/[locale]/penztar/steps/BillingStep.tsx</files>
  <action>
Create billing step at `apps/web/src/app/[locale]/penztar/steps/BillingStep.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useCheckoutStore } from '@/stores/checkout';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';

export function BillingStep() {
  const {
    useSameAsBilling,
    newBillingAddress,
    poReference,
    setUseSameAsBilling,
    setNewBillingAddress,
    setPoReference,
    prevStep,
    nextStep,
  } = useCheckoutStore();

  const [billingForm, setBillingForm] = useState({
    recipientName: newBillingAddress?.recipientName || '',
    street: newBillingAddress?.street || '',
    city: newBillingAddress?.city || '',
    postalCode: newBillingAddress?.postalCode || '',
    country: newBillingAddress?.country || 'Magyarorszag',
    companyName: newBillingAddress?.companyName || '',
    vatNumber: newBillingAddress?.vatNumber || '',
  });

  const [poRef, setPoRef] = useState(poReference);

  const handleBillingChange = (field: string, value: string) => {
    const updated = { ...billingForm, [field]: value };
    setBillingForm(updated);
    setNewBillingAddress(updated);
  };

  const handlePoReferenceChange = (value: string) => {
    setPoRef(value);
    setPoReference(value);
  };

  const canContinue = () => {
    if (useSameAsBilling) {
      return true;
    }
    // Require basic billing address fields
    return (
      billingForm.recipientName.trim() &&
      billingForm.street.trim() &&
      billingForm.city.trim() &&
      billingForm.postalCode.trim()
    );
  };

  const handleContinue = () => {
    if (canContinue()) {
      nextStep();
    }
  };

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-semibold">Szamlazasi adatok</h2>

      {/* Same as shipping checkbox */}
      <div className="flex items-center space-x-2 p-4 border rounded-lg">
        <Checkbox
          id="sameAsBilling"
          checked={useSameAsBilling}
          onCheckedChange={(checked) => setUseSameAsBilling(checked === true)}
        />
        <Label htmlFor="sameAsBilling" className="cursor-pointer">
          A szamlazasi cim megegyezik a szallitasi cimmel
        </Label>
      </div>

      {/* Billing address form (only if different) */}
      {!useSameAsBilling && (
        <div className="border rounded-lg p-6 space-y-4">
          <h3 className="font-medium">Szamlazasi cim</h3>

          <div className="grid gap-4 sm:grid-cols-2">
            {/* Company fields (optional) */}
            <div className="sm:col-span-2 p-4 bg-muted/50 rounded-lg space-y-4">
              <p className="text-sm font-medium">Ceges adatok (opcionalis)</p>

              <div>
                <Label htmlFor="companyName">Cegnev</Label>
                <Input
                  id="companyName"
                  value={billingForm.companyName}
                  onChange={(e) => handleBillingChange('companyName', e.target.value)}
                  placeholder="Ceg Kft."
                />
              </div>

              <div>
                <Label htmlFor="vatNumber">Adoszam</Label>
                <Input
                  id="vatNumber"
                  value={billingForm.vatNumber}
                  onChange={(e) => handleBillingChange('vatNumber', e.target.value)}
                  placeholder="12345678-1-42"
                />
              </div>
            </div>

            <div className="sm:col-span-2">
              <Label htmlFor="billingRecipientName">Nev *</Label>
              <Input
                id="billingRecipientName"
                value={billingForm.recipientName}
                onChange={(e) => handleBillingChange('recipientName', e.target.value)}
                placeholder="Kovacs Janos"
              />
            </div>

            <div className="sm:col-span-2">
              <Label htmlFor="billingStreet">Utca, hazszam *</Label>
              <Input
                id="billingStreet"
                value={billingForm.street}
                onChange={(e) => handleBillingChange('street', e.target.value)}
                placeholder="Petofi utca 10."
              />
            </div>

            <div>
              <Label htmlFor="billingPostalCode">Iranyitoszam *</Label>
              <Input
                id="billingPostalCode"
                value={billingForm.postalCode}
                onChange={(e) => handleBillingChange('postalCode', e.target.value)}
                placeholder="1234"
              />
            </div>

            <div>
              <Label htmlFor="billingCity">Varos *</Label>
              <Input
                id="billingCity"
                value={billingForm.city}
                onChange={(e) => handleBillingChange('city', e.target.value)}
                placeholder="Budapest"
              />
            </div>

            <div className="sm:col-span-2">
              <Label htmlFor="billingCountry">Orszag</Label>
              <Input
                id="billingCountry"
                value={billingForm.country}
                disabled
              />
            </div>
          </div>
        </div>
      )}

      {/* PO Reference (B2B) */}
      <div className="border rounded-lg p-6 space-y-4">
        <h3 className="font-medium">Megrendelesi hivatkozas (opcionalis)</h3>
        <p className="text-sm text-muted-foreground">
          Ceges rendeles eseten megadhatja a belso megrendelesi szamot, ami megjelenik a szamlan.
        </p>
        <div>
          <Label htmlFor="poReference">PO szam / Hivatkozas</Label>
          <Input
            id="poReference"
            value={poRef}
            onChange={(e) => handlePoReferenceChange(e.target.value)}
            placeholder="PO-2026-001"
            maxLength={100}
          />
        </div>
      </div>

      {/* Navigation */}
      <div className="flex justify-between pt-6 border-t">
        <Button variant="outline" onClick={prevStep}>
          Vissza
        </Button>
        <Button onClick={handleContinue} disabled={!canContinue()}>
          Tovabb az osszegzeshez
        </Button>
      </div>
    </div>
  );
}
```

This provides:
- Same-as-shipping checkbox (default checked)
- Company name and VAT number fields for B2B invoicing
- PO reference field for purchase order numbers
- Validation for required fields when using different billing address
  </action>
  <verify>
    - BillingStep.tsx has companyName and vatNumber fields
    - BillingStep.tsx has poReference field
    - Same-as-shipping checkbox works
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Billing step created with same-as-shipping option and B2B fields</done>
</task>

<task type="auto">
  <name>Task 3: Create order summary step</name>
  <files>
    apps/web/src/app/[locale]/penztar/steps/SummaryStep.tsx
    apps/web/src/app/[locale]/penztar/CheckoutClient.tsx
  </files>
  <action>
Create summary step at `apps/web/src/app/[locale]/penztar/steps/SummaryStep.tsx`:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useCheckoutStore } from '@/stores/checkout';
import { useCartStore, useCartItems, useCartCoupon } from '@/stores/cart';
import { calculateTotals, formatHUF, type CalculateTotalsResponse } from '@/lib/checkout-api';
import { Button } from '@/components/ui/button';
import { Loader2, AlertCircle } from 'lucide-react';
import type { ShippingAddress } from '@csz/types';

interface SummaryStepProps {
  addresses: ShippingAddress[];
}

export function SummaryStep({ addresses }: SummaryStepProps) {
  const {
    shippingAddressId,
    useNewShippingAddress,
    newShippingAddress,
    useSameAsBilling,
    newBillingAddress,
    poReference,
    setCalculatedTotals,
    prevStep,
    nextStep,
  } = useCheckoutStore();

  const items = useCartItems();
  const coupon = useCartCoupon();

  const [totals, setTotals] = useState<CalculateTotalsResponse | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  // Get shipping address details
  const shippingAddress = useNewShippingAddress
    ? newShippingAddress
    : addresses.find(a => a.documentId === shippingAddressId);

  // Get billing address details
  const billingAddress = useSameAsBilling ? shippingAddress : newBillingAddress;

  // Fetch calculated totals from server
  useEffect(() => {
    async function fetchTotals() {
      setLoading(true);
      setError(null);

      const lineItems = items.map(item => ({
        productId: item.productDocumentId,
        variantId: item.variantDocumentId,
        quantity: item.quantity,
      }));

      const shippingCountry = shippingAddress?.country || 'Magyarorszag';

      const result = await calculateTotals({
        lineItems,
        couponCode: coupon?.code,
        shippingCountry,
      });

      if (result.error) {
        setError(result.error);
      } else if (result.data) {
        setTotals(result.data);
        setCalculatedTotals({
          subtotal: result.data.subtotal,
          discount: result.data.discount,
          shipping: result.data.shipping,
          vatAmount: result.data.vatAmount,
          total: result.data.total,
        });
      }

      setLoading(false);
    }

    fetchTotals();
  }, [items, coupon, shippingAddress, setCalculatedTotals]);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        <span className="ml-2 text-muted-foreground">Osszegzes szamitasa...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-6 border border-destructive rounded-lg">
        <div className="flex items-center gap-2 text-destructive mb-4">
          <AlertCircle className="h-5 w-5" />
          <span className="font-medium">Hiba tortent</span>
        </div>
        <p className="text-muted-foreground mb-4">{error}</p>
        <Button variant="outline" onClick={prevStep}>
          Vissza
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-semibold">Rendeles osszegzese</h2>

      {/* Addresses */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Shipping Address */}
        <div className="border rounded-lg p-4">
          <h3 className="font-medium mb-2">Szallitasi cim</h3>
          {shippingAddress && (
            <div className="text-sm text-muted-foreground">
              <p>{shippingAddress.recipientName}</p>
              <p>{shippingAddress.street}</p>
              <p>{shippingAddress.postalCode} {shippingAddress.city}</p>
              <p>{shippingAddress.country}</p>
              {shippingAddress.phone && <p>Tel: {shippingAddress.phone}</p>}
            </div>
          )}
        </div>

        {/* Billing Address */}
        <div className="border rounded-lg p-4">
          <h3 className="font-medium mb-2">Szamlazasi cim</h3>
          {billingAddress && (
            <div className="text-sm text-muted-foreground">
              {newBillingAddress?.companyName && (
                <p className="font-medium">{newBillingAddress.companyName}</p>
              )}
              {newBillingAddress?.vatNumber && (
                <p>Adoszam: {newBillingAddress.vatNumber}</p>
              )}
              <p>{billingAddress.recipientName}</p>
              <p>{billingAddress.street}</p>
              <p>{billingAddress.postalCode} {billingAddress.city}</p>
              <p>{billingAddress.country}</p>
            </div>
          )}
          {useSameAsBilling && (
            <p className="text-xs text-muted-foreground mt-2">
              (Megegyezik a szallitasi cimmel)
            </p>
          )}
        </div>
      </div>

      {/* PO Reference */}
      {poReference && (
        <div className="border rounded-lg p-4">
          <h3 className="font-medium mb-2">Megrendelesi hivatkozas</h3>
          <p className="text-sm text-muted-foreground">{poReference}</p>
        </div>
      )}

      {/* Line Items */}
      <div className="border rounded-lg p-4">
        <h3 className="font-medium mb-4">Termekek</h3>
        <div className="space-y-3">
          {items.map((item) => (
            <div key={item.id} className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                {item.image && (
                  <img
                    src={item.image}
                    alt={item.name}
                    className="w-12 h-12 object-cover rounded"
                  />
                )}
                <div>
                  <p className="font-medium">{item.name}</p>
                  {item.variantName && (
                    <p className="text-sm text-muted-foreground">{item.variantName}</p>
                  )}
                  <p className="text-sm text-muted-foreground">
                    {item.quantity} x {formatHUF(item.price)}
                  </p>
                </div>
              </div>
              <span className="font-medium">
                {formatHUF(item.price * item.quantity)}
              </span>
            </div>
          ))}
        </div>
      </div>

      {/* Totals with VAT breakdown */}
      {totals && (
        <div className="border rounded-lg p-4 space-y-3">
          <h3 className="font-medium mb-4">Fizetendo osszeg</h3>

          <div className="flex justify-between text-sm">
            <span>Reszosszeg</span>
            <span>{formatHUF(totals.subtotal)}</span>
          </div>

          {totals.discount > 0 && (
            <div className="flex justify-between text-sm text-green-600">
              <span>Kedvezmeny {coupon && `(${coupon.code})`}</span>
              <span>-{formatHUF(totals.discount)}</span>
            </div>
          )}

          <div className="flex justify-between text-sm">
            <span>Szallitasi dij</span>
            <span>
              {totals.shipping === 0 ? (
                <span className="text-green-600">Ingyenes</span>
              ) : (
                formatHUF(totals.shipping)
              )}
            </span>
          </div>

          {totals.shipping === 0 && (
            <p className="text-xs text-muted-foreground">
              Ingyenes szallitas {formatHUF(totals.freeShippingThreshold)} feletti rendeleshez
            </p>
          )}

          <div className="border-t pt-3 mt-3">
            <div className="flex justify-between text-sm text-muted-foreground">
              <span>Netto osszeg</span>
              <span>{formatHUF(totals.netTotal)}</span>
            </div>
            <div className="flex justify-between text-sm text-muted-foreground">
              <span>AFA (27%)</span>
              <span>{formatHUF(totals.vatAmount)}</span>
            </div>
          </div>

          <div className="flex justify-between font-semibold text-lg pt-3 border-t">
            <span>Vegosszeg</span>
            <span>{formatHUF(totals.total)}</span>
          </div>
        </div>
      )}

      {/* Navigation */}
      <div className="flex justify-between pt-6 border-t">
        <Button variant="outline" onClick={prevStep}>
          Vissza
        </Button>
        <Button onClick={nextStep}>
          Tovabb a fizeteshez
        </Button>
      </div>
    </div>
  );
}
```

Update `apps/web/src/app/[locale]/penztar/CheckoutClient.tsx` to import and use BillingStep and SummaryStep:

Replace the placeholder divs with the actual step components:

```typescript
// Add imports at top
import { BillingStep } from './steps/BillingStep';
import { SummaryStep } from './steps/SummaryStep';

// In the render, replace placeholders:
{step === 'billing' && <BillingStep />}
{step === 'summary' && <SummaryStep addresses={initialAddresses} />}
```
  </action>
  <verify>
    - SummaryStep.tsx calls calculateTotals from checkout-api.ts
    - SummaryStep.tsx displays vatAmount (27% breakdown)
    - SummaryStep.tsx shows addresses and line items
    - CheckoutClient.tsx renders BillingStep and SummaryStep
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Summary step created with server-calculated totals and VAT breakdown</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds: `pnpm --filter @csz/web build`
2. Start servers:
   - `cd apps/api && pnpm dev` (API for calculations)
   - `cd apps/cms && pnpm dev` (Strapi for product data)
   - `cd apps/web && pnpm dev` (Frontend)
3. Complete checkout flow to summary step:
   - Add item to cart
   - Go to /penztar
   - Select shipping address
   - Continue to billing
   - Check/uncheck same-as-shipping
   - Enter PO reference
   - Continue to summary
4. Verify summary shows:
   - Both addresses
   - Line items with prices
   - Subtotal, discount, shipping
   - Net amount and 27% VAT
   - Total amount
</verification>

<success_criteria>
- User can use shipping address as billing address (CHKT-04)
- User can enter different billing address with company info (ACCT-05)
- User can enter PO reference number (CHKT-07)
- Order summary shows itemized breakdown with VAT (CHKT-05)
- 27% Hungarian VAT displayed correctly (CHKT-08)
- Shipping cost shown before payment (CHKT-06)
- All totals from server, not client-side
</success_criteria>

<output>
After completion, create `.planning/phases/06-checkout-payments/06-05-SUMMARY.md`
</output>
