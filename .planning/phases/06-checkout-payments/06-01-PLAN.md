---
phase: 06-checkout-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/cms/src/api/order/content-types/order/schema.json
  - apps/cms/src/api/order/controllers/order.ts
  - apps/cms/src/api/order/routes/order.ts
  - apps/cms/src/api/order/services/order.ts
  - packages/types/src/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can view orders in Strapi admin panel"
    - "Order content type stores all pricing fields (subtotal, discount, shipping, VAT, total)"
    - "Order stores address snapshots as JSON (not relations)"
    - "Order stores line items as JSON array"
  artifacts:
    - path: "apps/cms/src/api/order/content-types/order/schema.json"
      provides: "Order content type definition"
      contains: "orderNumber"
    - path: "packages/types/src/index.ts"
      provides: "Extended Order interface with poReference and stripeSessionId"
      contains: "stripeSessionId"
  key_links:
    - from: "Order schema"
      to: "users-permissions.user"
      via: "manyToOne relation"
      pattern: "target.*users-permissions.user"
---

<objective>
Create Order content type in Strapi CMS with all fields required for checkout, payments, and order management.

Purpose: Orders are the core data model for the checkout phase - they store order details, line items (as JSON), address snapshots, payment info, and status tracking.

Output: Order content type in Strapi with API routes enabled, TypeScript types updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-checkout-payments/06-RESEARCH.md

Reference existing content types for patterns:
@apps/cms/src/api/coupon/content-types/coupon/schema.json
@apps/cms/src/api/shipping-address/content-types/shipping-address/schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Order content type in Strapi</name>
  <files>
    apps/cms/src/api/order/content-types/order/schema.json
    apps/cms/src/api/order/controllers/order.ts
    apps/cms/src/api/order/routes/order.ts
    apps/cms/src/api/order/services/order.ts
  </files>
  <action>
Create Order content type with these fields:

**Identification:**
- `orderNumber` (string, required, unique) - Sequential order ID like "CSZ-2026-00001"
- `status` (enumeration, required, default: "pending") - Values: pending, paid, processing, shipped, delivered, cancelled, refunded

**User relation:**
- `user` (manyToOne to plugin::users-permissions.user) - Customer who placed order

**Pricing (all integers in HUF):**
- `subtotal` (integer, required) - Sum of line items
- `discount` (integer, default: 0) - Coupon discount amount
- `shipping` (integer, required) - Shipping cost
- `vatAmount` (integer, required) - Calculated VAT amount (27%)
- `total` (integer, required) - Final total

**Addresses (JSON - snapshot at order time):**
- `shippingAddress` (json, required) - Full shipping address object
- `billingAddress` (json) - Billing address if different

**Line items:**
- `lineItems` (json, required) - Array of OrderLineItem objects

**Coupon info:**
- `couponCode` (string) - Code used if any
- `couponDiscount` (integer) - Discount from coupon

**B2B:**
- `poReference` (string, maxLength: 100) - Purchase order reference number

**Payment:**
- `paymentMethod` (string) - "card", "bank_transfer", etc.
- `paymentId` (string) - Stripe payment intent ID
- `stripeSessionId` (string) - Stripe checkout session ID for idempotency
- `paidAt` (datetime) - When payment was confirmed

**Notes:**
- `notes` (text) - Internal notes

Set `draftAndPublish: false` - orders don't need draft workflow.

Create the standard controller, routes, and service files for Strapi API generation.
  </action>
  <verify>
    - `pnpm --filter @csz/cms build` compiles without errors
    - schema.json contains orderNumber, status, subtotal, total, shippingAddress, lineItems fields
    - Content type appears in Strapi admin after restart
  </verify>
  <done>Order content type created with all checkout-required fields</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript Order interface</name>
  <files>packages/types/src/index.ts</files>
  <action>
Update the existing Order interface in @csz/types to include:

1. Add `poReference?: string` field for B2B purchase order numbers
2. Add `stripeSessionId?: string` field for Stripe session tracking
3. Ensure all fields match the Strapi schema exactly

The Order interface already exists (from 05-07 placeholder), but needs these additional fields that weren't in the placeholder.

Also verify OrderLineItem and OrderStatus types are complete and match Strapi schema.
  </action>
  <verify>
    - `pnpm build` in packages/types compiles without errors
    - Order interface includes poReference, stripeSessionId
    - All pricing fields are integers (subtotal, discount, shipping, vatAmount, total)
  </verify>
  <done>Order TypeScript interface matches Strapi schema with all fields</done>
</task>

<task type="auto">
  <name>Task 3: Configure Order API permissions</name>
  <files>apps/cms/README.md</files>
  <action>
Document the required Strapi permissions for the Order content type in README.md.

**Authenticated role permissions (for customers):**
- `find`: NO (customers should not list all orders)
- `findOne`: YES (to view own order by ID - controller must filter by user)
- `create`: YES (checkout creates orders)
- `update`: NO (only webhooks/admin update orders)
- `delete`: NO

**Store Manager role permissions:**
- All operations enabled for order management

Note: The actual permission configuration happens in Strapi admin UI. Document the steps:
1. Start Strapi: `pnpm --filter @csz/cms dev`
2. Go to Settings > Users & Permissions > Roles > Authenticated
3. Enable Order > findOne, create
4. Go to Roles > Store Manager
5. Enable all Order permissions

Add a note that a custom controller override may be needed to ensure findOne only returns orders belonging to the authenticated user.
  </action>
  <verify>
    - README.md contains Order permission instructions
    - Instructions match the permission matrix above
  </verify>
  <done>Order API permission configuration documented</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Strapi builds: `pnpm --filter @csz/cms build` succeeds
2. TypeScript compiles: `pnpm build` at root succeeds
3. Order schema exists with correct fields
4. Order interface in @csz/types matches schema

Test Order content type:
```bash
# Start Strapi
cd apps/cms && pnpm dev

# After startup, verify in admin:
# - Content Manager shows "Order" collection type
# - All fields visible in Order content type builder
```
</verification>

<success_criteria>
- Order content type created in Strapi with all pricing, address, line item, and payment fields
- Order TypeScript interface updated with poReference and stripeSessionId
- draftAndPublish disabled for orders
- Permission configuration documented
</success_criteria>

<output>
After completion, create `.planning/phases/06-checkout-payments/06-01-SUMMARY.md`
</output>
