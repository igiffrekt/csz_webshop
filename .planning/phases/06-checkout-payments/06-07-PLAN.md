---
phase: 06-checkout-payments
plan: 07
type: execute
wave: 3
depends_on: [06-01, 06-02, 06-06]
files_modified:
  - apps/web/src/app/[locale]/penztar/siker/page.tsx
  - apps/web/src/app/[locale]/penztar/siker/OrderConfirmation.tsx
  - apps/web/src/lib/order-api.ts
  - apps/web/src/app/[locale]/fiok/rendelesek/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User receives order confirmation after successful payment"
    - "Confirmation shows order number and status"
    - "Cart is cleared after successful checkout"
    - "Checkout state is reset after success"
    - "Order appears in order history"
  artifacts:
    - path: "apps/web/src/app/[locale]/penztar/siker/page.tsx"
      provides: "Success page after payment"
      contains: "session_id"
    - path: "apps/web/src/app/[locale]/penztar/siker/OrderConfirmation.tsx"
      provides: "Order confirmation display component"
      contains: "orderNumber"
    - path: "apps/web/src/lib/order-api.ts"
      provides: "Order API client functions"
      contains: "getOrder"
  key_links:
    - from: "siker/page.tsx"
      to: "Stripe API"
      via: "retrieve session"
      pattern: "sessions.retrieve"
    - from: "siker/page.tsx"
      to: "order-api.ts"
      via: "getOrder"
      pattern: "getOrder"
---

<objective>
Create the checkout success page and order confirmation flow, updating order history to show real orders.

Purpose: PAY-05 requires order confirmation after payment. The success page retrieves the Stripe session, verifies payment, and displays order details. It also clears the cart and checkout state.

Output: Success page at /penztar/siker, OrderConfirmation component, order API client, updated order history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-checkout-payments/06-RESEARCH.md

Reference existing patterns:
@apps/web/src/app/[locale]/fiok/rendelesek/page.tsx (placeholder from Phase 5)
@packages/types/src/index.ts (Order, OrderLineItem types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order API client</name>
  <files>apps/web/src/lib/order-api.ts</files>
  <action>
Create order API client at `apps/web/src/lib/order-api.ts`:

```typescript
import 'server-only';
import { getSession } from './auth/session';
import type { Order } from '@csz/types';

const STRAPI_URL = process.env.STRAPI_URL || 'http://localhost:1337';

interface ApiResponse<T> {
  data: T | null;
  error?: string;
}

/**
 * Get a single order by documentId
 * Requires authenticated user who owns the order
 */
export async function getOrder(documentId: string): Promise<ApiResponse<Order>> {
  const session = await getSession();
  if (!session) {
    return { data: null, error: 'Nincs bejelentkezve' };
  }

  try {
    const res = await fetch(
      `${STRAPI_URL}/api/orders/${documentId}`,
      {
        headers: {
          Authorization: `Bearer ${session.jwt}`,
        },
        cache: 'no-store',
      }
    );

    if (!res.ok) {
      if (res.status === 404) {
        return { data: null, error: 'Rendeles nem talalhato' };
      }
      return { data: null, error: 'Rendeles betoltese sikertelen' };
    }

    const json = await res.json();
    return { data: json.data };
  } catch {
    return { data: null, error: 'Hiba tortent' };
  }
}

/**
 * Get all orders for the current user
 */
export async function getOrders(): Promise<ApiResponse<Order[]>> {
  const session = await getSession();
  if (!session) {
    return { data: null, error: 'Nincs bejelentkezve' };
  }

  try {
    // Strapi needs a custom controller to filter by user
    // For now, fetch all and let controller filter
    const res = await fetch(
      `${STRAPI_URL}/api/orders?sort=createdAt:desc`,
      {
        headers: {
          Authorization: `Bearer ${session.jwt}`,
        },
        cache: 'no-store',
      }
    );

    if (!res.ok) {
      return { data: null, error: 'Rendelesek betoltese sikertelen' };
    }

    const json = await res.json();
    return { data: json.data || [] };
  } catch {
    return { data: null, error: 'Hiba tortent' };
  }
}

/**
 * Get order by Stripe session ID
 * Used on success page to find order from redirect
 */
export async function getOrderByStripeSession(
  sessionId: string
): Promise<ApiResponse<Order>> {
  const session = await getSession();
  if (!session) {
    return { data: null, error: 'Nincs bejelentkezve' };
  }

  try {
    const res = await fetch(
      `${STRAPI_URL}/api/orders?filters[stripeSessionId][$eq]=${sessionId}`,
      {
        headers: {
          Authorization: `Bearer ${session.jwt}`,
        },
        cache: 'no-store',
      }
    );

    if (!res.ok) {
      return { data: null, error: 'Rendeles nem talalhato' };
    }

    const json = await res.json();
    const orders = json.data || [];

    if (orders.length === 0) {
      return { data: null, error: 'Rendeles nem talalhato' };
    }

    return { data: orders[0] };
  } catch {
    return { data: null, error: 'Hiba tortent' };
  }
}

/**
 * Format order status in Hungarian
 */
export function formatOrderStatus(status: string): {
  label: string;
  variant: 'default' | 'secondary' | 'destructive' | 'outline';
} {
  const statuses: Record<string, { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline' }> = {
    pending: { label: 'Fizetesre var', variant: 'outline' },
    paid: { label: 'Fizetve', variant: 'secondary' },
    processing: { label: 'Feldolgozas alatt', variant: 'secondary' },
    shipped: { label: 'Szallitas alatt', variant: 'default' },
    delivered: { label: 'Kiszallitva', variant: 'default' },
    cancelled: { label: 'Lemondva', variant: 'destructive' },
    refunded: { label: 'Visszafizetve', variant: 'destructive' },
  };

  return statuses[status] || { label: status, variant: 'outline' };
}
```
  </action>
  <verify>
    - order-api.ts exports getOrder, getOrders, getOrderByStripeSession, formatOrderStatus
    - Uses 'server-only' import
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Order API client created for fetching orders</done>
</task>

<task type="auto">
  <name>Task 2: Create success page and order confirmation</name>
  <files>
    apps/web/src/app/[locale]/penztar/siker/page.tsx
    apps/web/src/app/[locale]/penztar/siker/OrderConfirmation.tsx
  </files>
  <action>
Create success page at `apps/web/src/app/[locale]/penztar/siker/page.tsx`:

```typescript
import { redirect } from 'next/navigation';
import { requireAuth } from '@/lib/auth/dal';
import { getOrderByStripeSession } from '@/lib/order-api';
import { OrderConfirmation } from './OrderConfirmation';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Sikeres rendeles | CSZ Tuzvedelmi Webshop',
  description: 'Koszonjuk a rendeleset!',
};

interface Props {
  searchParams: Promise<{ session_id?: string }>;
}

export default async function CheckoutSuccessPage({ searchParams }: Props) {
  // Require authentication
  await requireAuth();

  const { session_id } = await searchParams;

  if (!session_id) {
    redirect('/hu/penztar');
  }

  // Find order by Stripe session ID
  const { data: order, error } = await getOrderByStripeSession(session_id);

  if (error || !order) {
    // Order not found - might be processing, show generic success
    return (
      <main className="container mx-auto px-4 py-8 max-w-2xl text-center">
        <div className="py-12">
          <div className="w-16 h-16 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
            <svg
              className="w-8 h-8 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
          <h1 className="text-2xl font-bold mb-4">Koszonjuk a rendeleset!</h1>
          <p className="text-muted-foreground mb-6">
            A rendeleset feldolgozzuk. Hamarosan email ertesitest kuldunk a reszletekkel.
          </p>
          <a
            href="/hu/fiok/rendelesek"
            className="text-primary hover:underline"
          >
            Rendeleseim megtekintese
          </a>
        </div>
      </main>
    );
  }

  return (
    <main className="container mx-auto px-4 py-8 max-w-2xl">
      <OrderConfirmation order={order} />
    </main>
  );
}
```

Create order confirmation component at `apps/web/src/app/[locale]/penztar/siker/OrderConfirmation.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useCartStore } from '@/stores/cart';
import { useCheckoutStore } from '@/stores/checkout';
import { formatOrderStatus } from '@/lib/order-api';
import { formatHUF, formatDate } from '@/lib/checkout-api';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { CheckCircle, Package, Mail } from 'lucide-react';
import type { Order } from '@csz/types';

interface OrderConfirmationProps {
  order: Order;
}

export function OrderConfirmation({ order }: OrderConfirmationProps) {
  const clearCart = useCartStore((state) => state.clearCart);
  const resetCheckout = useCheckoutStore((state) => state.reset);

  // Clear cart and checkout state on mount
  useEffect(() => {
    clearCart();
    resetCheckout();
  }, [clearCart, resetCheckout]);

  const status = formatOrderStatus(order.status);

  return (
    <div className="space-y-8">
      {/* Success header */}
      <div className="text-center py-8">
        <div className="w-16 h-16 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
          <CheckCircle className="w-8 h-8 text-green-600" />
        </div>
        <h1 className="text-2xl font-bold mb-2">Koszonjuk a rendeleset!</h1>
        <p className="text-muted-foreground">
          A rendeles szama: <span className="font-mono font-medium">{order.orderNumber}</span>
        </p>
      </div>

      {/* Order status */}
      <div className="border rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">Rendeles allapota</h2>
          <Badge variant={status.variant}>{status.label}</Badge>
        </div>

        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <Mail className="h-4 w-4" />
          <span>Email ertesitest kuldtunk a {order.user?.email || 'megadott'} cimre</span>
        </div>
      </div>

      {/* Order details */}
      <div className="border rounded-lg p-6 space-y-4">
        <h2 className="font-semibold">Rendeles reszletei</h2>

        {/* Line items */}
        <div className="space-y-3">
          {order.lineItems.map((item, index) => (
            <div key={index} className="flex justify-between items-center text-sm">
              <div>
                <span className="font-medium">{item.name}</span>
                {item.variantName && (
                  <span className="text-muted-foreground"> - {item.variantName}</span>
                )}
                <span className="text-muted-foreground"> x {item.quantity}</span>
              </div>
              <span>{formatHUF(item.total)}</span>
            </div>
          ))}
        </div>

        {/* Totals */}
        <div className="border-t pt-4 space-y-2 text-sm">
          <div className="flex justify-between">
            <span>Reszosszeg</span>
            <span>{formatHUF(order.subtotal)}</span>
          </div>
          {order.discount > 0 && (
            <div className="flex justify-between text-green-600">
              <span>Kedvezmeny {order.couponCode && `(${order.couponCode})`}</span>
              <span>-{formatHUF(order.discount)}</span>
            </div>
          )}
          <div className="flex justify-between">
            <span>Szallitas</span>
            <span>{order.shipping === 0 ? 'Ingyenes' : formatHUF(order.shipping)}</span>
          </div>
          <div className="flex justify-between text-muted-foreground">
            <span>AFA (27%)</span>
            <span>{formatHUF(order.tax)}</span>
          </div>
          <div className="flex justify-between font-semibold text-lg pt-2 border-t">
            <span>Osszesen</span>
            <span>{formatHUF(order.total)}</span>
          </div>
        </div>
      </div>

      {/* Shipping address */}
      <div className="border rounded-lg p-6">
        <div className="flex items-center gap-2 mb-4">
          <Package className="h-5 w-5" />
          <h2 className="font-semibold">Szallitasi cim</h2>
        </div>
        <div className="text-sm text-muted-foreground">
          <p>{order.shippingAddress.recipientName}</p>
          <p>{order.shippingAddress.street}</p>
          <p>{order.shippingAddress.postalCode} {order.shippingAddress.city}</p>
          <p>{order.shippingAddress.country}</p>
          {order.shippingAddress.phone && <p>Tel: {order.shippingAddress.phone}</p>}
        </div>
      </div>

      {/* PO Reference */}
      {order.poReference && (
        <div className="border rounded-lg p-6">
          <h2 className="font-semibold mb-2">Megrendelesi hivatkozas</h2>
          <p className="text-sm text-muted-foreground font-mono">{order.poReference}</p>
        </div>
      )}

      {/* Actions */}
      <div className="flex flex-col sm:flex-row gap-4 pt-4">
        <Button asChild className="flex-1">
          <Link href="/fiok/rendelesek">Rendeleseim</Link>
        </Button>
        <Button variant="outline" asChild className="flex-1">
          <Link href="/termekek">Vasarlas folytatas</Link>
        </Button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    - siker/page.tsx retrieves order by session_id
    - OrderConfirmation.tsx clears cart and checkout state on mount
    - OrderConfirmation.tsx displays order details with VAT
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Success page and order confirmation created</done>
</task>

<task type="auto">
  <name>Task 3: Update order history page with real orders</name>
  <files>apps/web/src/app/[locale]/fiok/rendelesek/page.tsx</files>
  <action>
Update order history page at `apps/web/src/app/[locale]/fiok/rendelesek/page.tsx` to fetch real orders:

```typescript
import { requireAuth } from '@/lib/auth/dal';
import { getOrders, formatOrderStatus } from '@/lib/order-api';
import { formatHUF } from '@/lib/checkout-api';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { ArrowLeft, Package, ChevronRight } from 'lucide-react';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Rendeleseim | CSZ Tuzvedelmi Webshop',
  description: 'Korabbi rendelesek megtekintese',
};

export default async function OrderHistoryPage() {
  await requireAuth();

  const { data: orders, error } = await getOrders();

  return (
    <main className="container mx-auto px-4 py-8 max-w-4xl">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/fiok">
            <ArrowLeft className="h-5 w-5" />
          </Link>
        </Button>
        <h1 className="text-2xl font-bold">Rendeleseim</h1>
      </div>

      {error && (
        <div className="p-4 border border-destructive rounded-lg mb-6">
          <p className="text-destructive text-sm">{error}</p>
        </div>
      )}

      {orders && orders.length === 0 ? (
        <div className="text-center py-12 border rounded-lg">
          <Package className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
          <h2 className="text-lg font-medium mb-2">Meg nincs rendelese</h2>
          <p className="text-muted-foreground mb-6">
            Az elso rendelese utan itt lathatja a rendeles tortenetet.
          </p>
          <Button asChild>
            <Link href="/termekek">Termekek bongeszese</Link>
          </Button>
        </div>
      ) : (
        <div className="space-y-4">
          {orders?.map((order) => {
            const status = formatOrderStatus(order.status);
            const itemCount = order.lineItems.reduce((sum, item) => sum + item.quantity, 0);
            const orderDate = new Date(order.createdAt).toLocaleDateString('hu-HU', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            });

            return (
              <Link
                key={order.documentId}
                href={`/fiok/rendelesek/${order.documentId}`}
                className="block border rounded-lg p-6 hover:border-primary/50 transition-colors"
              >
                <div className="flex items-start justify-between">
                  <div className="space-y-1">
                    <div className="flex items-center gap-3">
                      <span className="font-mono font-medium">{order.orderNumber}</span>
                      <Badge variant={status.variant}>{status.label}</Badge>
                    </div>
                    <p className="text-sm text-muted-foreground">{orderDate}</p>
                    <p className="text-sm text-muted-foreground">
                      {itemCount} termek
                    </p>
                  </div>
                  <div className="flex items-center gap-4">
                    <span className="font-semibold">{formatHUF(order.total)}</span>
                    <ChevronRight className="h-5 w-5 text-muted-foreground" />
                  </div>
                </div>
              </Link>
            );
          })}
        </div>
      )}
    </main>
  );
}
```

The order detail page at `/fiok/rendelesek/[id]/page.tsx` should already exist from Phase 5 as a placeholder. Update it if needed to use the real order API:

```typescript
import { requireAuth } from '@/lib/auth/dal';
import { getOrder, formatOrderStatus } from '@/lib/order-api';
import { formatHUF, formatDate } from '@/lib/checkout-api';
import { notFound } from 'next/navigation';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { ArrowLeft, Package, FileText } from 'lucide-react';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Rendeles reszletei | CSZ Tuzvedelmi Webshop',
};

interface Props {
  params: Promise<{ id: string }>;
}

export default async function OrderDetailPage({ params }: Props) {
  await requireAuth();

  const { id } = await params;
  const { data: order, error } = await getOrder(id);

  if (error || !order) {
    notFound();
  }

  const status = formatOrderStatus(order.status);
  const orderDate = new Date(order.createdAt).toLocaleDateString('hu-HU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });

  return (
    <main className="container mx-auto px-4 py-8 max-w-4xl">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/fiok/rendelesek">
            <ArrowLeft className="h-5 w-5" />
          </Link>
        </Button>
        <div>
          <h1 className="text-2xl font-bold font-mono">{order.orderNumber}</h1>
          <p className="text-sm text-muted-foreground">{orderDate}</p>
        </div>
        <Badge variant={status.variant} className="ml-auto">
          {status.label}
        </Badge>
      </div>

      <div className="grid lg:grid-cols-3 gap-8">
        {/* Order details */}
        <div className="lg:col-span-2 space-y-6">
          {/* Line items */}
          <div className="border rounded-lg p-6">
            <h2 className="font-semibold mb-4 flex items-center gap-2">
              <Package className="h-5 w-5" />
              Termekek
            </h2>
            <div className="space-y-4">
              {order.lineItems.map((item, index) => (
                <div key={index} className="flex justify-between items-center">
                  <div>
                    <p className="font-medium">{item.name}</p>
                    {item.variantName && (
                      <p className="text-sm text-muted-foreground">{item.variantName}</p>
                    )}
                    <p className="text-sm text-muted-foreground">
                      {item.quantity} x {formatHUF(item.price)}
                    </p>
                  </div>
                  <span className="font-medium">{formatHUF(item.total)}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Addresses */}
          <div className="grid sm:grid-cols-2 gap-4">
            <div className="border rounded-lg p-6">
              <h2 className="font-semibold mb-2">Szallitasi cim</h2>
              <div className="text-sm text-muted-foreground">
                <p>{order.shippingAddress.recipientName}</p>
                <p>{order.shippingAddress.street}</p>
                <p>{order.shippingAddress.postalCode} {order.shippingAddress.city}</p>
              </div>
            </div>

            {order.billingAddress && (
              <div className="border rounded-lg p-6">
                <h2 className="font-semibold mb-2">Szamlazasi cim</h2>
                <div className="text-sm text-muted-foreground">
                  {order.billingAddress.companyName && (
                    <p className="font-medium">{order.billingAddress.companyName}</p>
                  )}
                  {order.billingAddress.vatNumber && (
                    <p>Adoszam: {order.billingAddress.vatNumber}</p>
                  )}
                  <p>{order.billingAddress.recipientName}</p>
                  <p>{order.billingAddress.street}</p>
                  <p>{order.billingAddress.postalCode} {order.billingAddress.city}</p>
                </div>
              </div>
            )}
          </div>

          {/* PO Reference */}
          {order.poReference && (
            <div className="border rounded-lg p-6">
              <h2 className="font-semibold mb-2 flex items-center gap-2">
                <FileText className="h-5 w-5" />
                Megrendelesi hivatkozas
              </h2>
              <p className="font-mono">{order.poReference}</p>
            </div>
          )}
        </div>

        {/* Order summary */}
        <div className="lg:col-span-1">
          <div className="border rounded-lg p-6 sticky top-4">
            <h2 className="font-semibold mb-4">Osszegzes</h2>

            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span>Reszosszeg</span>
                <span>{formatHUF(order.subtotal)}</span>
              </div>
              {order.discount > 0 && (
                <div className="flex justify-between text-green-600">
                  <span>Kedvezmeny</span>
                  <span>-{formatHUF(order.discount)}</span>
                </div>
              )}
              <div className="flex justify-between">
                <span>Szallitas</span>
                <span>{order.shipping === 0 ? 'Ingyenes' : formatHUF(order.shipping)}</span>
              </div>
              <div className="flex justify-between text-muted-foreground">
                <span>AFA (27%)</span>
                <span>{formatHUF(order.tax)}</span>
              </div>
              <div className="flex justify-between font-semibold text-lg pt-2 border-t">
                <span>Osszesen</span>
                <span>{formatHUF(order.total)}</span>
              </div>
            </div>

            {order.paidAt && (
              <p className="text-xs text-muted-foreground mt-4">
                Fizetve: {new Date(order.paidAt).toLocaleDateString('hu-HU')}
              </p>
            )}
          </div>
        </div>
      </div>
    </main>
  );
}
```
  </action>
  <verify>
    - Order history page fetches real orders from getOrders()
    - Order detail page fetches order from getOrder()
    - Both pages show order details with VAT breakdown
    - Empty state shown when no orders
    - `pnpm --filter @csz/web build` compiles
  </verify>
  <done>Order history updated to show real orders</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds: `pnpm --filter @csz/web build`
2. Complete full checkout flow:
   - Add item to cart
   - Go through checkout steps
   - Complete Stripe payment with test card
   - Verify redirect to /penztar/siker
3. Verify success page:
   - Shows order number
   - Shows order status
   - Shows line items and totals with VAT
   - Cart is cleared
4. Verify order history:
   - Order appears in /fiok/rendelesek
   - Click order to see details
   - All details match what was ordered
</verification>

<success_criteria>
- User receives order confirmation after payment (PAY-05)
- Order confirmation shows order number and status
- Cart cleared after successful checkout
- Checkout state reset after success
- Order visible in order history (ACCT-01, ACCT-02)
- Hungarian date/number formats (LANG-03)
</success_criteria>

<output>
After completion, create `.planning/phases/06-checkout-payments/06-07-SUMMARY.md`
</output>
