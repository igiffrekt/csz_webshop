---
phase: 06-checkout-payments
plan: 08
type: execute
wave: 4
depends_on: [06-01, 06-02, 06-03, 06-04, 06-05, 06-06, 06-07]
files_modified:
  - apps/api/src/routes/checkout/bank-transfer.ts
  - apps/api/src/index.ts
  - apps/web/src/app/[locale]/penztar/bankatvitel/page.tsx
  - .planning/phases/06-checkout-payments/06-VERIFICATION.md
autonomous: false
user_setup:
  - service: stripe
    why: "Webhook testing"
    dashboard_config:
      - task: "Add webhook endpoint for localhost testing"
        location: "Stripe CLI: stripe listen --forward-to localhost:4000/webhook/stripe"

must_haves:
  truths:
    - "User can select bank transfer and receive payment instructions"
    - "Order with bank transfer shows 'Fizetesre var' status"
    - "All CHKT requirements verified"
    - "All PAY requirements verified"
    - "All SHIP requirements verified"
    - "Webhook updates order status correctly"
  artifacts:
    - path: "apps/web/src/app/[locale]/penztar/bankatvitel/page.tsx"
      provides: "Bank transfer payment instructions"
      contains: "bankatvitel"
    - path: ".planning/phases/06-checkout-payments/06-VERIFICATION.md"
      provides: "Phase verification results"
      contains: "CHKT-01"
  key_links:
    - from: "webhook.ts"
      to: "Strapi Order API"
      via: "updateOrderStatus"
      pattern: "status.*paid"
---

<objective>
Add bank transfer payment option and verify the complete checkout and payments phase.

Purpose: PAY-04 requires bank transfer option. This plan also performs end-to-end verification of all Phase 6 requirements including webhook testing with Stripe CLI.

Output: Bank transfer payment flow, complete phase verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-checkout-payments/06-RESEARCH.md

All prior plans in this phase.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bank transfer payment option</name>
  <files>
    apps/api/src/routes/checkout/bank-transfer.ts
    apps/api/src/index.ts
    apps/web/src/app/[locale]/penztar/bankatvitel/page.tsx
  </files>
  <action>
Create bank transfer endpoint at `apps/api/src/routes/checkout/bank-transfer.ts`:

```typescript
import type { FastifyPluginAsync } from 'fastify';
import qs from 'qs';
import { calculateVatFromGross } from '../../lib/vat.js';
import { calculateShipping } from '../../lib/shipping.js';

const STRAPI_URL = process.env.STRAPI_URL || 'http://localhost:1337';
const STRAPI_API_TOKEN = process.env.STRAPI_API_TOKEN;

// Bank account details for bank transfer
const BANK_ACCOUNT = {
  accountHolder: 'CSZ Tuzvedelmi Kft.',
  bankName: 'OTP Bank',
  iban: 'HU12 1234 5678 9012 3456 7890 1234',
  bic: 'OTPVHUHB',
};

interface LineItemInput {
  productId: string;
  variantId?: string;
  quantity: number;
  name: string;
  variantName?: string;
  sku: string;
  price: number;
}

interface AddressInput {
  recipientName: string;
  street: string;
  city: string;
  postalCode: string;
  country: string;
  phone?: string;
  companyName?: string;
  vatNumber?: string;
}

interface BankTransferBody {
  lineItems: LineItemInput[];
  shippingAddress: AddressInput;
  billingAddress?: AddressInput;
  couponCode?: string;
  poReference?: string;
  userId: number;
}

async function generateOrderNumber(): Promise<string> {
  const year = new Date().getFullYear();
  const timestamp = Date.now().toString(36).toUpperCase();
  const random = Math.random().toString(36).substring(2, 6).toUpperCase();
  return `CSZ-${year}-${timestamp}${random}`;
}

async function fetchProductPrices(lineItems: LineItemInput[]): Promise<Map<string, { price: number; weight: number }>> {
  const prices = new Map<string, { price: number; weight: number }>();

  const productIds = [...new Set(lineItems.filter(li => !li.variantId).map(li => li.productId))];
  if (productIds.length > 0) {
    const query = qs.stringify({
      filters: { documentId: { $in: productIds } },
      fields: ['documentId', 'basePrice', 'weight'],
    });

    const res = await fetch(`${STRAPI_URL}/api/products?${query}`);
    if (res.ok) {
      const json = await res.json();
      for (const product of json.data || []) {
        prices.set(product.documentId, {
          price: product.basePrice,
          weight: product.weight || 0,
        });
      }
    }
  }

  const variantIds = [...new Set(lineItems.filter(li => li.variantId).map(li => li.variantId!))];
  if (variantIds.length > 0) {
    const query = qs.stringify({
      filters: { documentId: { $in: variantIds } },
      fields: ['documentId', 'price', 'weight'],
    });

    const res = await fetch(`${STRAPI_URL}/api/product-variants?${query}`);
    if (res.ok) {
      const json = await res.json();
      for (const variant of json.data || []) {
        prices.set(variant.documentId, {
          price: variant.price,
          weight: variant.weight || 0,
        });
      }
    }
  }

  return prices;
}

async function validateAndCalculateCoupon(
  code: string,
  subtotal: number
): Promise<{ valid: boolean; discount: number }> {
  const query = qs.stringify({
    filters: { code: { $eqi: code } },
  });

  const res = await fetch(`${STRAPI_URL}/api/coupons?${query}`);
  if (!res.ok) return { valid: false, discount: 0 };

  const json = await res.json();
  const coupons = json.data || [];
  if (coupons.length === 0) return { valid: false, discount: 0 };

  const coupon = coupons[0];

  if (!coupon.isActive) return { valid: false, discount: 0 };

  const now = new Date();
  if (coupon.validFrom && new Date(coupon.validFrom) > now) return { valid: false, discount: 0 };
  if (coupon.validUntil && new Date(coupon.validUntil) < now) return { valid: false, discount: 0 };
  if (coupon.maxUses && coupon.usedCount >= coupon.maxUses) return { valid: false, discount: 0 };
  if (coupon.minOrderValue && subtotal < coupon.minOrderValue) return { valid: false, discount: 0 };

  let discount = 0;
  if (coupon.discountType === 'percentage') {
    discount = Math.round(subtotal * (coupon.discountValue / 100));
    if (coupon.maxDiscount) discount = Math.min(discount, coupon.maxDiscount);
  } else {
    discount = coupon.discountValue;
  }

  return { valid: true, discount: Math.min(discount, subtotal) };
}

export const bankTransferRoutes: FastifyPluginAsync = async (fastify) => {
  // POST /checkout/bank-transfer - Create order for bank transfer payment
  fastify.post<{ Body: BankTransferBody }>('/checkout/bank-transfer', async (request, reply) => {
    const {
      lineItems,
      shippingAddress,
      billingAddress,
      couponCode,
      poReference,
      userId,
    } = request.body;

    if (!lineItems || lineItems.length === 0) {
      return reply.status(400).send({ error: 'A kosar ures' });
    }

    if (!shippingAddress) {
      return reply.status(400).send({ error: 'Szallitasi cim szukseges' });
    }

    if (!userId) {
      return reply.status(400).send({ error: 'Felhasznalo azonosito szukseges' });
    }

    try {
      // Fetch current prices
      const prices = await fetchProductPrices(lineItems);

      // Calculate totals
      let subtotal = 0;
      let totalWeight = 0;
      const verifiedLineItems: Array<{
        productId: string;
        variantId?: string;
        name: string;
        variantName?: string;
        sku: string;
        price: number;
        quantity: number;
        total: number;
      }> = [];

      for (const item of lineItems) {
        const key = item.variantId || item.productId;
        const priceInfo = prices.get(key);

        if (!priceInfo) {
          return reply.status(400).send({ error: `Termek nem talalhato: ${item.name}` });
        }

        subtotal += priceInfo.price * item.quantity;
        totalWeight += priceInfo.weight * item.quantity;

        verifiedLineItems.push({
          productId: item.productId,
          variantId: item.variantId,
          name: item.name,
          variantName: item.variantName,
          sku: item.sku,
          price: priceInfo.price,
          quantity: item.quantity,
          total: priceInfo.price * item.quantity,
        });
      }

      // Apply coupon
      let discount = 0;
      if (couponCode) {
        const couponResult = await validateAndCalculateCoupon(couponCode, subtotal);
        if (couponResult.valid) {
          discount = couponResult.discount;
        }
      }

      // Calculate shipping
      const discountedSubtotal = subtotal - discount;
      const shipping = calculateShipping(totalWeight, discountedSubtotal);

      // Calculate VAT and total
      const total = discountedSubtotal + shipping;
      const { vatAmount } = calculateVatFromGross(total);

      // Generate order number
      const orderNumber = await generateOrderNumber();

      // Create order with pending status
      const response = await fetch(`${STRAPI_URL}/api/orders`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${STRAPI_API_TOKEN}`,
        },
        body: JSON.stringify({
          data: {
            orderNumber,
            status: 'pending',
            user: userId,
            subtotal,
            discount,
            shipping,
            vatAmount,
            total,
            shippingAddress,
            billingAddress: billingAddress || shippingAddress,
            lineItems: verifiedLineItems,
            couponCode: discount > 0 ? couponCode : undefined,
            couponDiscount: discount > 0 ? discount : undefined,
            poReference,
            paymentMethod: 'bank_transfer',
          },
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Failed to create order: ${JSON.stringify(error)}`);
      }

      const json = await response.json();

      return reply.send({
        orderId: json.data.documentId,
        orderNumber: json.data.orderNumber,
        total,
        bankAccount: BANK_ACCOUNT,
        paymentReference: `CSZ-${json.data.orderNumber}`,
      });
    } catch (error) {
      fastify.log.error(error, 'Failed to create bank transfer order');
      return reply.status(500).send({
        error: 'Hiba tortent a rendeles letrehozasakor',
      });
    }
  });
};
```

Update `apps/api/src/index.ts`:

```typescript
// Add import
import { bankTransferRoutes } from './routes/checkout/bank-transfer.js';

// Register bank transfer routes
await fastify.register(bankTransferRoutes, { prefix: '/checkout' });
```

Create bank transfer success page at `apps/web/src/app/[locale]/penztar/bankatvitel/page.tsx`:

```typescript
import { redirect } from 'next/navigation';
import { requireAuth } from '@/lib/auth/dal';
import { getOrder } from '@/lib/order-api';
import { formatHUF } from '@/lib/checkout-api';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { Banknote, Copy, CheckCircle } from 'lucide-react';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Banki atutalas | CSZ Tuzvedelmi Webshop',
  description: 'Banki atutalas reszletei',
};

interface Props {
  searchParams: Promise<{ order_id?: string }>;
}

export default async function BankTransferPage({ searchParams }: Props) {
  await requireAuth();

  const { order_id } = await searchParams;

  if (!order_id) {
    redirect('/hu/penztar');
  }

  const { data: order, error } = await getOrder(order_id);

  if (error || !order) {
    redirect('/hu/fiok/rendelesek');
  }

  const paymentReference = `CSZ-${order.orderNumber}`;

  return (
    <main className="container mx-auto px-4 py-8 max-w-2xl">
      <div className="text-center mb-8">
        <div className="w-16 h-16 mx-auto mb-6 bg-blue-100 rounded-full flex items-center justify-center">
          <Banknote className="w-8 h-8 text-blue-600" />
        </div>
        <h1 className="text-2xl font-bold mb-2">Banki atutalas</h1>
        <p className="text-muted-foreground">
          Kerem utalja at az alabbi osszeg a megadott bankszamlara.
        </p>
      </div>

      <div className="border rounded-lg p-6 space-y-6">
        {/* Amount */}
        <div className="text-center py-4 bg-muted rounded-lg">
          <p className="text-sm text-muted-foreground mb-1">Fizetendo osszeg</p>
          <p className="text-3xl font-bold">{formatHUF(order.total)}</p>
        </div>

        {/* Bank details */}
        <div className="space-y-4">
          <h2 className="font-semibold">Bankszamla adatok</h2>

          <div className="grid gap-4">
            <div className="flex justify-between items-center p-3 bg-muted/50 rounded">
              <div>
                <p className="text-sm text-muted-foreground">Kedvezmenyezett neve</p>
                <p className="font-medium">CSZ Tuzvedelmi Kft.</p>
              </div>
            </div>

            <div className="flex justify-between items-center p-3 bg-muted/50 rounded">
              <div>
                <p className="text-sm text-muted-foreground">Bank neve</p>
                <p className="font-medium">OTP Bank</p>
              </div>
            </div>

            <div className="flex justify-between items-center p-3 bg-muted/50 rounded">
              <div>
                <p className="text-sm text-muted-foreground">IBAN</p>
                <p className="font-mono font-medium">HU12 1234 5678 9012 3456 7890 1234</p>
              </div>
              <Button variant="ghost" size="icon">
                <Copy className="h-4 w-4" />
              </Button>
            </div>

            <div className="flex justify-between items-center p-3 bg-muted/50 rounded">
              <div>
                <p className="text-sm text-muted-foreground">BIC/SWIFT</p>
                <p className="font-mono font-medium">OTPVHUHB</p>
              </div>
            </div>

            <div className="flex justify-between items-center p-3 bg-primary/10 rounded border border-primary/20">
              <div>
                <p className="text-sm text-muted-foreground">Kozlemeny (FONTOS!)</p>
                <p className="font-mono font-medium text-primary">{paymentReference}</p>
              </div>
              <Button variant="ghost" size="icon">
                <Copy className="h-4 w-4" />
              </Button>
            </div>
          </div>
        </div>

        {/* Important notes */}
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 className="font-medium text-yellow-800 mb-2">Fontos tudnivalok</h3>
          <ul className="text-sm text-yellow-700 space-y-1 list-disc list-inside">
            <li>Kerem pontosan a megadott kozlemenyt hasznaljon</li>
            <li>Az utalas utan a rendelest 24-48 oran belul feldolgozzuk</li>
            <li>Hibas kozlemeny eseten keresse ugyfelszolgalatunkat</li>
          </ul>
        </div>

        {/* Order reference */}
        <div className="pt-4 border-t">
          <p className="text-sm text-muted-foreground">
            Rendeles szama: <span className="font-mono">{order.orderNumber}</span>
          </p>
        </div>
      </div>

      <div className="flex flex-col sm:flex-row gap-4 mt-8">
        <Button asChild className="flex-1">
          <Link href="/fiok/rendelesek">Rendeleseim megtekintese</Link>
        </Button>
        <Button variant="outline" asChild className="flex-1">
          <Link href="/termekek">Vasarlas folytatas</Link>
        </Button>
      </div>
    </main>
  );
}
```

Note: The actual selection of bank transfer as payment method would be added to the PaymentStep component as an alternative to Stripe card payment. For now, this creates the backend support and success page.
  </action>
  <verify>
    - bank-transfer.ts creates order with paymentMethod: 'bank_transfer'
    - bankatvitel/page.tsx shows bank account details
    - Bank account IBAN and payment reference displayed
    - `pnpm --filter @csz/api build` and `pnpm --filter @csz/web build` compile
  </verify>
  <done>Bank transfer payment option created</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete checkout and payment flow including:
- Multi-step checkout (shipping, billing, summary, payment)
- Stripe Embedded Checkout for card payments
- Bank transfer payment option
- Order creation in Strapi
- Webhook-based order status updates
- Order confirmation and history
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Start all services:
   - `cd apps/cms && pnpm dev` (Strapi at :1337)
   - `cd apps/api && pnpm dev` (API at :4000)
   - `cd apps/web && pnpm dev` (Web at :3000)
2. Start Stripe CLI for webhook testing:
   - `stripe listen --forward-to localhost:4000/webhook/stripe`
   - Copy the webhook signing secret to STRIPE_WEBHOOK_SECRET

**Test CHKT-01: Login required**
1. Open incognito window
2. Navigate to http://localhost:3000/hu/penztar
3. Verify redirect to login page
4. Log in and verify redirect back to checkout

**Test CHKT-02/03: Shipping addresses**
1. Go through checkout with logged in user
2. Verify saved addresses appear with default selected
3. Test adding a new shipping address inline
4. Verify country locked to Hungary

**Test CHKT-04: Billing address**
1. Continue to billing step
2. Test "same as shipping" checkbox
3. Test entering different billing address with company/VAT

**Test CHKT-05/06/08: Order summary with VAT**
1. Continue to summary step
2. Verify subtotal, discount (if coupon), shipping displayed
3. Verify 27% VAT breakdown (net amount + AFA)
4. Verify total matches calculation

**Test CHKT-07: PO Reference**
1. In billing step, enter a PO reference
2. Verify it appears in order summary
3. After order, verify it appears in order details

**Test PAY-01/02/03: Card payment**
1. Continue to payment step
2. Verify Stripe Embedded Checkout loads
3. Use test card 4242 4242 4242 4242
4. Complete payment
5. Verify redirect to success page

**Test PAY-04: Bank transfer**
1. (If bank transfer option visible in payment step)
2. Select bank transfer
3. Verify redirect to bank transfer instructions page
4. Verify IBAN, BIC, and payment reference displayed

**Test PAY-05: Order confirmation**
1. After successful payment, verify success page shows:
   - Order number
   - Order status
   - Line items with prices
   - VAT breakdown
   - Shipping address

**Test PAY-06: Webhook order update**
1. Check Stripe CLI output for webhook delivery
2. Check order in Strapi admin - status should be "paid"
3. Check order in /fiok/rendelesek - status should be "Fizetve"

**Test SHIP-01/02/03/04: Shipping calculation**
1. Verify shipping cost in summary
2. Test order over 50,000 Ft - should show free shipping
3. Verify shipping only available for Hungary

**Test LANG-03: Hungarian formatting**
1. Verify prices in Hungarian format (space thousands, Ft suffix)
2. Verify dates in Hungarian format
  </how-to-verify>
  <resume-signal>Type "verified" with any issues found, or "verified - all pass" if complete</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create phase verification document</name>
  <files>.planning/phases/06-checkout-payments/06-VERIFICATION.md</files>
  <action>
Create verification document at `.planning/phases/06-checkout-payments/06-VERIFICATION.md`:

```markdown
# Phase 6: Checkout & Payments - Verification

**Verified:** [DATE]
**Status:** [PASS/FAIL]

## Requirements Verification

### Checkout Requirements (CHKT)

| ID | Requirement | Status | Notes |
|----|-------------|--------|-------|
| CHKT-01 | User must be logged in to checkout | [x] | requireAuth() on checkout page |
| CHKT-02 | User can enter shipping address | [x] | ShippingStep with new address form |
| CHKT-03 | User can select from saved addresses | [x] | RadioGroup with saved addresses |
| CHKT-04 | User can enter billing address | [x] | BillingStep with same-as-shipping option |
| CHKT-05 | User can see itemized order summary with VAT breakdown | [x] | SummaryStep with net/VAT/total |
| CHKT-06 | User can see shipping cost before payment | [x] | Shipping shown in summary |
| CHKT-07 | User can enter purchase order reference number | [x] | BillingStep PO field |
| CHKT-08 | User sees 27% Hungarian VAT calculated correctly | [x] | Server-side VAT calculation |

### Payment Requirements (PAY)

| ID | Requirement | Status | Notes |
|----|-------------|--------|-------|
| PAY-01 | User can pay with credit/debit card via Stripe | [x] | Stripe Embedded Checkout |
| PAY-02 | User can pay with Apple Pay | [x] | Available via Embedded Checkout |
| PAY-03 | User can pay with Google Pay | [x] | Available via Embedded Checkout |
| PAY-04 | User can select bank transfer | [x] | Bank transfer endpoint and page |
| PAY-05 | User receives order confirmation after payment | [x] | Success page with order details |
| PAY-06 | Order status updates when webhook confirms payment | [x] | Webhook handler updates order |

### Shipping Requirements (SHIP)

| ID | Requirement | Status | Notes |
|----|-------------|--------|-------|
| SHIP-01 | Shipping calculated as flat rate base | [x] | 1,990 Ft base |
| SHIP-02 | Weight-based surcharge when applicable | [x] | +500 Ft/kg over 5kg |
| SHIP-03 | Shipping restricted to Hungarian addresses | [x] | Country validation |
| SHIP-04 | Shipping cost displayed during checkout | [x] | Shown in summary step |

### Localization Requirements (LANG)

| ID | Requirement | Status | Notes |
|----|-------------|--------|-------|
| LANG-03 | Date and number formats follow Hungarian conventions | [x] | formatHUF, toLocaleDateString('hu-HU') |

## Technical Verification

### API Endpoints

| Endpoint | Method | Status | Notes |
|----------|--------|--------|-------|
| /checkout/calculate | POST | [x] | Server-side totals calculation |
| /checkout/create-session | POST | [x] | Creates order + Stripe session |
| /checkout/bank-transfer | POST | [x] | Creates order for bank transfer |
| /webhook/stripe | POST | [x] | Stripe webhook handler |

### Security Checks

| Check | Status | Notes |
|-------|--------|-------|
| Auth protection on checkout | [x] | requireAuth() middleware |
| Server-side price verification | [x] | Never trust client prices |
| Webhook signature verification | [x] | stripe.webhooks.constructEvent |
| No client-side calculations | [x] | All totals from /checkout/calculate |

### Data Flow

1. Cart -> Checkout: Cart items passed to checkout flow
2. Checkout -> API: Calculate totals via POST /checkout/calculate
3. Payment -> Strapi: Order created before Stripe session
4. Stripe -> API: Webhook updates order status
5. Success -> UI: Order confirmation displayed

## Issues Found

[List any issues discovered during verification]

## Sign-off

- [ ] All CHKT requirements verified
- [ ] All PAY requirements verified
- [ ] All SHIP requirements verified
- [ ] LANG-03 verified
- [ ] End-to-end checkout flow tested
- [ ] Webhook flow tested with Stripe CLI
```

Update the document with actual verification results based on the checkpoint feedback.
  </action>
  <verify>
    - VERIFICATION.md created with all requirement IDs
    - Status fields filled based on testing
    - Any issues documented
  </verify>
  <done>Phase verification document created</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. All builds pass
2. Checkpoint verification passes
3. VERIFICATION.md documents all requirements
4. No blocking issues remain

Requirements covered in this phase:
- CHKT-01 through CHKT-08 (8 requirements)
- PAY-01 through PAY-06 (6 requirements)
- SHIP-01 through SHIP-04 (4 requirements)
- LANG-03 (1 requirement)

Total: 19 requirements
</verification>

<success_criteria>
- Bank transfer payment option works (PAY-04)
- All checkout requirements verified (CHKT-01 through CHKT-08)
- All payment requirements verified (PAY-01 through PAY-06)
- All shipping requirements verified (SHIP-01 through SHIP-04)
- Hungarian formatting verified (LANG-03)
- VERIFICATION.md documents all test results
</success_criteria>

<output>
After completion, create `.planning/phases/06-checkout-payments/06-08-SUMMARY.md`
</output>
