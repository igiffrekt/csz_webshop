---
phase: 09-content-polish
plan: 09
type: execute
wave: 5
depends_on: [09-08]
files_modified:
  - apps/web/src/app/[locale]/layout.tsx
  - apps/web/src/app/[locale]/termekek/[slug]/page.tsx
  - apps/web/src/lib/structured-data.ts
  - apps/web/next.config.ts
autonomous: true

must_haves:
  truths:
    - "Product pages have meta tags"
    - "Structured data for products"
    - "Images optimized"
    - "Lighthouse score 80+"
  artifacts:
    - path: "apps/web/src/lib/structured-data.ts"
      provides: "JSON-LD helpers"
      contains: "Product"
---

<objective>
Optimize SEO and verify Lighthouse scores.

Purpose: PERF-01 (SEO optimization), PERF-02 (Lighthouse scores).

Output: SEO-optimized pages with structured data.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create structured data helpers</name>
  <files>
    apps/web/src/lib/structured-data.ts
  </files>
  <action>
Create structured data helpers at `apps/web/src/lib/structured-data.ts`:

```typescript
import type { Product } from '@csz/types';

const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://csz-tuzvedelmi.hu';

export function generateProductJsonLd(product: Product) {
  const image = product.images?.[0];

  return {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: product.title,
    description: product.description || product.shortDescription,
    image: image ? `${SITE_URL}${image.url}` : undefined,
    sku: product.sku,
    brand: {
      '@type': 'Brand',
      name: 'CSZ Tűzvédelem',
    },
    offers: {
      '@type': 'Offer',
      url: `${SITE_URL}/termekek/${product.slug}`,
      priceCurrency: 'HUF',
      price: product.price,
      availability: product.stockQuantity && product.stockQuantity > 0
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
      seller: {
        '@type': 'Organization',
        name: 'CSZ Tűzvédelmi Kft.',
      },
    },
    ...(product.certifications?.length && {
      additionalProperty: product.certifications.map((cert) => ({
        '@type': 'PropertyValue',
        name: 'Tanúsítvány',
        value: cert.name,
      })),
    }),
  };
}

export function generateBreadcrumbJsonLd(
  items: { name: string; url: string }[]
) {
  return {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: items.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.name,
      item: `${SITE_URL}${item.url}`,
    })),
  };
}

export function generateOrganizationJsonLd() {
  return {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: 'CSZ Tűzvédelmi Kft.',
    url: SITE_URL,
    logo: `${SITE_URL}/logo.png`,
    contactPoint: {
      '@type': 'ContactPoint',
      telephone: '+36-1-234-5678',
      contactType: 'customer service',
      availableLanguage: 'Hungarian',
    },
    address: {
      '@type': 'PostalAddress',
      streetAddress: 'Példa utca 123.',
      addressLocality: 'Budapest',
      postalCode: '1234',
      addressCountry: 'HU',
    },
  };
}

export function generateFAQJsonLd(
  faqs: { question: string; answer: string }[]
) {
  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqs.map((faq) => ({
      '@type': 'Question',
      name: faq.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: faq.answer.replace(/<[^>]*>/g, ''), // Strip HTML
      },
    })),
  };
}
```
  </action>
  <verify>
    - Product JSON-LD generated
    - Breadcrumb JSON-LD generated
    - Organization JSON-LD generated
    - FAQ JSON-LD generated
  </verify>
  <done>Structured data helpers created</done>
</task>

<task type="auto">
  <name>Task 2: Add structured data to product page</name>
  <files>
    apps/web/src/app/[locale]/termekek/[slug]/page.tsx
  </files>
  <action>
Update product page to include JSON-LD structured data.

Import helpers and add to page:

```typescript
import { generateProductJsonLd, generateBreadcrumbJsonLd } from '@/lib/structured-data';
```

Add script tag in the page component before closing:

```tsx
export default async function ProductPage({ params }: Props) {
  // ... existing code to fetch product

  const productJsonLd = generateProductJsonLd(product);
  const breadcrumbJsonLd = generateBreadcrumbJsonLd([
    { name: 'Főoldal', url: '/' },
    { name: 'Termékek', url: '/termekek' },
    { name: product.category?.name || 'Kategória', url: `/kategoriak/${product.category?.slug}` },
    { name: product.title, url: `/termekek/${product.slug}` },
  ]);

  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(productJsonLd) }}
      />
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(breadcrumbJsonLd) }}
      />
      {/* ... rest of page content */}
    </>
  );
}
```

Also update generateMetadata to include Open Graph and Twitter cards:

```typescript
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const product = await getProductBySlug(params.slug);

  if (!product) {
    return { title: 'Termék nem található' };
  }

  const image = product.images?.[0];

  return {
    title: `${product.title} | CSZ Tűzvédelem`,
    description: product.shortDescription || product.description?.substring(0, 160),
    openGraph: {
      title: product.title,
      description: product.shortDescription || product.description?.substring(0, 160),
      type: 'product',
      images: image ? [{ url: image.url, alt: product.title }] : undefined,
    },
    twitter: {
      card: 'summary_large_image',
      title: product.title,
      description: product.shortDescription || product.description?.substring(0, 160),
      images: image ? [image.url] : undefined,
    },
  };
}
```
  </action>
  <verify>
    - JSON-LD in page source
    - Open Graph meta tags
    - Twitter card meta tags
    - Breadcrumb structured data
  </verify>
  <done>Structured data added to product page</done>
</task>

<task type="auto">
  <name>Task 3: Add organization schema to layout</name>
  <files>
    apps/web/src/app/[locale]/layout.tsx
  </files>
  <action>
Add organization schema to root layout.

Import and add to layout:

```typescript
import { generateOrganizationJsonLd } from '@/lib/structured-data';
```

Add in the body before children:

```tsx
export default function RootLayout({ children }: { children: React.ReactNode }) {
  const organizationJsonLd = generateOrganizationJsonLd();

  return (
    <html lang="hu">
      <body>
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(organizationJsonLd) }}
        />
        {/* ... rest of layout */}
        {children}
      </body>
    </html>
  );
}
```
  </action>
  <verify>
    - Organization schema in every page
    - Proper Hungarian locale
    - Contact info included
  </verify>
  <done>Organization schema added to layout</done>
</task>

<task type="auto">
  <name>Task 4: Optimize Next.js config for performance</name>
  <files>
    apps/web/next.config.ts
  </files>
  <action>
Update Next.js config for performance optimizations:

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // Existing config...

  // Image optimization
  images: {
    formats: ['image/avif', 'image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    minimumCacheTTL: 60 * 60 * 24 * 30, // 30 days
    remotePatterns: [
      {
        protocol: 'http',
        hostname: 'localhost',
        port: '1337',
        pathname: '/uploads/**',
      },
      // Add production Strapi URL pattern here
    ],
  },

  // Compression
  compress: true,

  // Headers for caching
  async headers() {
    return [
      {
        source: '/:all*(svg|jpg|png|webp|avif)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
      {
        source: '/:all*(js|css)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ];
  },

  // Experimental features for performance
  experimental: {
    // Enable if using Next.js 16+
    // viewTransition: true,
  },
};

export default nextConfig;
```
  </action>
  <verify>
    - Image optimization configured
    - Compression enabled
    - Cache headers set
    - AVIF and WebP formats
  </verify>
  <done>Next.js config optimized</done>
</task>

<task type="manual">
  <name>Task 5: Run Lighthouse audit</name>
  <action>
Run Lighthouse audit to verify performance:

1. Build production version:
```bash
pnpm --filter @csz/web build
```

2. Start production server:
```bash
pnpm --filter @csz/web start
```

3. Open Chrome DevTools > Lighthouse tab
4. Run audit on:
   - Home page
   - Product listing page
   - Product detail page

Target scores:
- Performance: 80+
- Accessibility: 90+
- Best Practices: 90+
- SEO: 90+

Common issues to address:
- Missing alt text on images
- Missing meta descriptions
- Render-blocking resources
- Large images without lazy loading
  </action>
  <verify>
    - Lighthouse scores meet targets
    - No critical SEO issues
    - No critical accessibility issues
  </verify>
  <done>Lighthouse audit complete</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Product pages have structured data
2. Open Graph and Twitter cards configured
3. Organization schema on all pages
4. Lighthouse scores 80+ on performance

Requirements completed:
- PERF-01: SEO-optimized product pages
- PERF-02: Good Lighthouse scores
</verification>

<success_criteria>
- JSON-LD validates in testing tools
- Social sharing shows preview cards
- Lighthouse performance 80+
- SEO score 90+
</success_criteria>
