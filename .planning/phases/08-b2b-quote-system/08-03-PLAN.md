---
phase: 08-b2b-quote-system
plan: 03
type: execute
wave: 2
depends_on: [08-01, 08-02]
files_modified:
  - apps/web/src/app/[locale]/fiok/ajanlatkeres/page.tsx
  - apps/web/src/app/[locale]/fiok/ajanlatkeres/[id]/page.tsx
  - apps/web/src/components/quotes/QuoteCard.tsx
  - apps/web/src/components/quotes/QuoteStatusBadge.tsx
autonomous: true

must_haves:
  truths:
    - "Quote history page exists at /fiok/ajanlatkeres"
    - "Quote detail page exists at /fiok/ajanlatkeres/[id]"
    - "User can see all their quote requests"
    - "User can view details of a specific quote"
  artifacts:
    - path: "apps/web/src/app/[locale]/fiok/ajanlatkeres/page.tsx"
      provides: "Quote history page"
      contains: "getQuoteRequests"
    - path: "apps/web/src/app/[locale]/fiok/ajanlatkeres/[id]/page.tsx"
      provides: "Quote detail page"
      contains: "getQuoteRequest"
---

<objective>
Create quote history pages in the user account section.

Purpose: QUOT-04 (view quote request history). Users can track their quote requests.

Output: Quote history list page and detail page with status display.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create QuoteStatusBadge component</name>
  <files>
    apps/web/src/components/quotes/QuoteStatusBadge.tsx
  </files>
  <action>
Create the status badge component at `apps/web/src/components/quotes/QuoteStatusBadge.tsx`:

```typescript
import { Badge } from '@/components/ui/badge';
import type { QuoteStatus } from '@csz/types';

interface QuoteStatusBadgeProps {
  status: QuoteStatus;
}

const statusConfig: Record<QuoteStatus, { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline' }> = {
  pending: { label: 'Függőben', variant: 'secondary' },
  quoted: { label: 'Árajánlat kész', variant: 'default' },
  converted: { label: 'Elfogadva', variant: 'default' },
  declined: { label: 'Elutasítva', variant: 'destructive' },
  expired: { label: 'Lejárt', variant: 'outline' },
};

export function QuoteStatusBadge({ status }: QuoteStatusBadgeProps) {
  const config = statusConfig[status];
  return <Badge variant={config.variant}>{config.label}</Badge>;
}
```
  </action>
  <verify>
    - Component renders correct Hungarian labels
    - Badge variants match status meaning
  </verify>
  <done>QuoteStatusBadge component created</done>
</task>

<task type="auto">
  <name>Task 2: Create QuoteCard component</name>
  <files>
    apps/web/src/components/quotes/QuoteCard.tsx
  </files>
  <action>
Create the quote card component at `apps/web/src/components/quotes/QuoteCard.tsx`:

```typescript
import Link from 'next/link';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { QuoteStatusBadge } from './QuoteStatusBadge';
import type { QuoteRequest } from '@csz/types';

interface QuoteCardProps {
  quote: QuoteRequest;
  locale: string;
}

export function QuoteCard({ quote, locale }: QuoteCardProps) {
  const itemCount = quote.items.length;
  const createdDate = new Date(quote.createdAt).toLocaleDateString('hu-HU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  return (
    <Link href={`/${locale}/fiok/ajanlatkeres/${quote.documentId}`}>
      <Card className="hover:border-primary transition-colors">
        <CardHeader className="flex flex-row items-center justify-between pb-2">
          <CardTitle className="text-base font-medium">
            {quote.requestNumber}
          </CardTitle>
          <QuoteStatusBadge status={quote.status} />
        </CardHeader>
        <CardContent>
          <div className="text-sm text-muted-foreground space-y-1">
            <p>{itemCount} termék</p>
            <p>Beküldve: {createdDate}</p>
            {quote.companyName && <p>{quote.companyName}</p>}
          </div>
          {quote.quotedAmount && (
            <p className="mt-2 font-semibold">
              Árajánlat: {quote.quotedAmount.toLocaleString('hu-HU')} Ft
            </p>
          )}
        </CardContent>
      </Card>
    </Link>
  );
}
```
  </action>
  <verify>
    - Card displays quote number, status, item count
    - Card is clickable and links to detail page
    - Quoted amount shows when available
  </verify>
  <done>QuoteCard component created</done>
</task>

<task type="auto">
  <name>Task 3: Create quotes index component</name>
  <files>
    apps/web/src/components/quotes/index.ts
  </files>
  <action>
Create index export at `apps/web/src/components/quotes/index.ts`:

```typescript
export { QuoteCard } from './QuoteCard';
export { QuoteStatusBadge } from './QuoteStatusBadge';
```
  </action>
  <verify>
    - Components exported from index
  </verify>
  <done>Quote components index created</done>
</task>

<task type="auto">
  <name>Task 4: Create quote history page</name>
  <files>
    apps/web/src/app/[locale]/fiok/ajanlatkeres/page.tsx
  </files>
  <action>
Create the quote history page at `apps/web/src/app/[locale]/fiok/ajanlatkeres/page.tsx`:

```typescript
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { getSession } from '@/lib/session';
import { getQuoteRequests } from '@/lib/quote-api';
import { QuoteCard } from '@/components/quotes';
import { Button } from '@/components/ui/button';
import { FileText, Plus } from 'lucide-react';

export const metadata = {
  title: 'Árajánlat kérések - CSZ Tűzvédelem',
};

interface PageProps {
  params: Promise<{ locale: string }>;
}

export default async function QuoteHistoryPage({ params }: PageProps) {
  const { locale } = await params;
  const session = await getSession();

  if (!session?.user) {
    redirect(`/${locale}/bejelentkezes?redirect=/fiok/ajanlatkeres`);
  }

  const { data: quotes, error } = await getQuoteRequests(session.jwt);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Árajánlat kérések</h1>
          <p className="text-muted-foreground">
            Korábbi árajánlat kéréseinek áttekintése
          </p>
        </div>
        <Button asChild>
          <Link href={`/${locale}/ajanlatkeres`}>
            <Plus className="mr-2 h-4 w-4" />
            Új árajánlat kérés
          </Link>
        </Button>
      </div>

      {error && (
        <div className="rounded-md bg-destructive/10 p-4 text-destructive">
          {error}
        </div>
      )}

      {quotes && quotes.length === 0 && (
        <div className="text-center py-12">
          <FileText className="mx-auto h-12 w-12 text-muted-foreground" />
          <h3 className="mt-4 text-lg font-medium">Nincs árajánlat kérés</h3>
          <p className="mt-2 text-muted-foreground">
            Még nem küldött be árajánlat kérést.
          </p>
          <Button asChild className="mt-4">
            <Link href={`/${locale}/ajanlatkeres`}>
              Árajánlat kérés indítása
            </Link>
          </Button>
        </div>
      )}

      {quotes && quotes.length > 0 && (
        <div className="grid gap-4 md:grid-cols-2">
          {quotes.map((quote) => (
            <QuoteCard key={quote.documentId} quote={quote} locale={locale} />
          ))}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    - Page requires authentication
    - Shows list of user's quotes
    - Empty state when no quotes
    - Link to create new quote
  </verify>
  <done>Quote history page created</done>
</task>

<task type="auto">
  <name>Task 5: Create quote detail page</name>
  <files>
    apps/web/src/app/[locale]/fiok/ajanlatkeres/[id]/page.tsx
  </files>
  <action>
Create the quote detail page at `apps/web/src/app/[locale]/fiok/ajanlatkeres/[id]/page.tsx`:

```typescript
import { redirect, notFound } from 'next/navigation';
import Link from 'next/link';
import { getSession } from '@/lib/session';
import { getQuoteRequest } from '@/lib/quote-api';
import { QuoteStatusBadge } from '@/components/quotes';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { ArrowLeft } from 'lucide-react';

export const metadata = {
  title: 'Árajánlat részletei - CSZ Tűzvédelem',
};

interface PageProps {
  params: Promise<{ locale: string; id: string }>;
}

export default async function QuoteDetailPage({ params }: PageProps) {
  const { locale, id } = await params;
  const session = await getSession();

  if (!session?.user) {
    redirect(`/${locale}/bejelentkezes?redirect=/fiok/ajanlatkeres/${id}`);
  }

  const { data: quote, error } = await getQuoteRequest(id, session.jwt);

  if (error || !quote) {
    notFound();
  }

  const createdDate = new Date(quote.createdAt).toLocaleDateString('hu-HU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });

  const validUntilDate = quote.validUntil
    ? new Date(quote.validUntil).toLocaleDateString('hu-HU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      })
    : null;

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link href={`/${locale}/fiok/ajanlatkeres`}>
            <ArrowLeft className="h-4 w-4" />
          </Link>
        </Button>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold">{quote.requestNumber}</h1>
            <QuoteStatusBadge status={quote.status} />
          </div>
          <p className="text-muted-foreground">Beküldve: {createdDate}</p>
        </div>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        {/* Contact Information */}
        <Card>
          <CardHeader>
            <CardTitle>Kapcsolattartási adatok</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            {quote.companyName && (
              <div>
                <span className="text-muted-foreground">Cégnév:</span>{' '}
                {quote.companyName}
              </div>
            )}
            <div>
              <span className="text-muted-foreground">Email:</span>{' '}
              {quote.contactEmail}
            </div>
            {quote.contactPhone && (
              <div>
                <span className="text-muted-foreground">Telefon:</span>{' '}
                {quote.contactPhone}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Quote Status */}
        {quote.quotedAmount && (
          <Card>
            <CardHeader>
              <CardTitle>Árajánlat</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              <div className="text-2xl font-bold">
                {quote.quotedAmount.toLocaleString('hu-HU')} Ft
              </div>
              {quote.quotedAt && (
                <div className="text-sm text-muted-foreground">
                  Árajánlat dátuma:{' '}
                  {new Date(quote.quotedAt).toLocaleDateString('hu-HU')}
                </div>
              )}
              {validUntilDate && (
                <div className="text-sm text-muted-foreground">
                  Érvényes: {validUntilDate}-ig
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </div>

      {/* Items */}
      <Card>
        <CardHeader>
          <CardTitle>Kért termékek</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {quote.items.map((item, index) => (
              <div key={index}>
                {index > 0 && <Separator className="my-4" />}
                <div className="flex justify-between">
                  <div>
                    <p className="font-medium">{item.productName}</p>
                    {item.variantName && (
                      <p className="text-sm text-muted-foreground">
                        {item.variantName}
                      </p>
                    )}
                    <p className="text-sm text-muted-foreground">
                      SKU: {item.sku}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="font-medium">{item.quantity} db</p>
                    {item.unitPrice && (
                      <p className="text-sm text-muted-foreground">
                        {item.unitPrice.toLocaleString('hu-HU')} Ft/db
                      </p>
                    )}
                    {item.totalPrice && (
                      <p className="font-medium">
                        {item.totalPrice.toLocaleString('hu-HU')} Ft
                      </p>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Delivery Notes */}
      {quote.deliveryNotes && (
        <Card>
          <CardHeader>
            <CardTitle>Szállítási megjegyzések</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="whitespace-pre-wrap">{quote.deliveryNotes}</p>
          </CardContent>
        </Card>
      )}

      {/* Admin Response */}
      {quote.adminResponse && (
        <Card>
          <CardHeader>
            <CardTitle>Válasz</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="whitespace-pre-wrap">{quote.adminResponse}</p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    - Page requires authentication
    - Shows quote details with items
    - Displays quoted amount when available
    - Shows admin response when available
  </verify>
  <done>Quote detail page created</done>
</task>

<task type="auto">
  <name>Task 6: Add account navigation link</name>
  <files>
    apps/web/src/app/[locale]/fiok/layout.tsx
  </files>
  <action>
Update the account layout to include quote requests link. Find the navigation items array and add:

```typescript
{
  href: `/${locale}/fiok/ajanlatkeres`,
  label: 'Árajánlat kérések',
  icon: FileText, // Import from lucide-react
},
```

Add the import for FileText icon if not present.
  </action>
  <verify>
    - Quote requests link appears in account navigation
    - Icon displays correctly
  </verify>
  <done>Account navigation updated</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Quote history page shows user's quotes
2. Quote detail page shows full quote information
3. Status badges display with correct Hungarian labels
4. Navigation link in account sidebar
5. Authentication required for all pages

Requirements completed:
- QUOT-04: User can view quote request history in account
</verification>

<success_criteria>
- Quote history page at /fiok/ajanlatkeres
- Quote detail page at /fiok/ajanlatkeres/[id]
- QuoteStatusBadge with Hungarian labels
- QuoteCard with summary info
- Account navigation includes quotes link
</success_criteria>
