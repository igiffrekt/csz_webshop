---
phase: 08-b2b-quote-system
plan: 01
type: execute
wave: 1
depends_on: [07-03]
files_modified:
  - apps/cms/src/api/quote-request/content-types/quote-request/schema.json
  - apps/cms/src/api/quote-request/controllers/quote-request.ts
  - apps/cms/src/api/quote-request/services/quote-request.ts
  - apps/cms/src/api/quote-request/routes/quote-request.ts
  - packages/types/src/quote.ts
autonomous: true

must_haves:
  truths:
    - "QuoteRequest content type exists in Strapi"
    - "Quote requests have status enum with pending, quoted, converted, declined, expired"
    - "Quote requests relate to users"
    - "TypeScript interfaces defined for quotes"
  artifacts:
    - path: "apps/cms/src/api/quote-request/content-types/quote-request/schema.json"
      provides: "QuoteRequest content type"
      contains: "quote-request"
    - path: "packages/types/src/quote.ts"
      provides: "Quote TypeScript interfaces"
      contains: "QuoteRequest"
---

<objective>
Create QuoteRequest content type in Strapi for B2B bulk order quotes.

Purpose: QUOT-01 (request quote), ADMN-20 (admin view quotes). Foundation for quote system.

Output: QuoteRequest content type with all fields, TypeScript interfaces, API permissions.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create QuoteRequest content type</name>
  <files>
    apps/cms/src/api/quote-request/content-types/quote-request/schema.json
  </files>
  <action>
Create the QuoteRequest content type directory structure and schema.

Create directory: `apps/cms/src/api/quote-request/content-types/quote-request/`

Create schema at `apps/cms/src/api/quote-request/content-types/quote-request/schema.json`:

```json
{
  "kind": "collectionType",
  "collectionName": "quote_requests",
  "info": {
    "singularName": "quote-request",
    "pluralName": "quote-requests",
    "displayName": "Quote Request",
    "description": "B2B bulk order quote requests"
  },
  "options": {
    "draftAndPublish": false
  },
  "attributes": {
    "requestNumber": {
      "type": "string",
      "required": true,
      "unique": true,
      "maxLength": 50
    },
    "status": {
      "type": "enumeration",
      "enum": ["pending", "quoted", "converted", "declined", "expired"],
      "required": true,
      "default": "pending"
    },
    "user": {
      "type": "relation",
      "relation": "manyToOne",
      "target": "plugin::users-permissions.user"
    },
    "items": {
      "type": "json",
      "required": true
    },
    "deliveryNotes": {
      "type": "text"
    },
    "companyName": {
      "type": "string",
      "maxLength": 255
    },
    "contactEmail": {
      "type": "email",
      "required": true
    },
    "contactPhone": {
      "type": "string",
      "maxLength": 50
    },
    "adminNotes": {
      "type": "text"
    },
    "adminResponse": {
      "type": "text"
    },
    "quotedAmount": {
      "type": "integer",
      "min": 0
    },
    "quotedAt": {
      "type": "datetime"
    },
    "validUntil": {
      "type": "datetime"
    }
  }
}
```
  </action>
  <verify>
    - Schema file exists with all fields
    - Status enum includes all required values
    - User relation configured
  </verify>
  <done>QuoteRequest schema created</done>
</task>

<task type="auto">
  <name>Task 2: Create QuoteRequest controller</name>
  <files>
    apps/cms/src/api/quote-request/controllers/quote-request.ts
  </files>
  <action>
Create controller with ownership filtering at `apps/cms/src/api/quote-request/controllers/quote-request.ts`:

```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreController('api::quote-request.quote-request', ({ strapi }) => ({
  /**
   * Find quote requests - filtered by authenticated user
   */
  async find(ctx) {
    const user = ctx.state.user;
    if (!user) {
      return ctx.unauthorized('Bejelentkezés szükséges');
    }

    const quoteRequests = await strapi.documents('api::quote-request.quote-request').findMany({
      filters: {
        user: { id: user.id },
      },
      sort: ctx.query.sort || 'createdAt:desc',
    });

    const sanitizedResults = await Promise.all(
      quoteRequests.map((qr) => this.sanitizeOutput(qr, ctx))
    );

    return { data: sanitizedResults, meta: { pagination: { total: quoteRequests.length } } };
  },

  /**
   * Find one quote request - verify ownership
   */
  async findOne(ctx) {
    const user = ctx.state.user;
    if (!user) {
      return ctx.unauthorized('Bejelentkezés szükséges');
    }

    const { id } = ctx.params;
    const quoteRequest = await strapi.documents('api::quote-request.quote-request').findOne({
      documentId: id,
      populate: ['user'],
    });

    if (!quoteRequest) {
      return ctx.notFound('Árajánlat kérés nem található');
    }

    if (quoteRequest.user?.id !== user.id) {
      return ctx.forbidden('Nincs hozzáférése ehhez az árajánlat kéréshez');
    }

    const sanitizedResult = await this.sanitizeOutput(quoteRequest, ctx);
    return { data: sanitizedResult };
  },

  /**
   * Create quote request
   */
  async create(ctx) {
    const user = ctx.state.user;
    if (!user) {
      return ctx.unauthorized('Bejelentkezés szükséges');
    }

    // Generate request number
    const year = new Date().getFullYear();
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substring(2, 4).toUpperCase();
    const requestNumber = `QR-${year}-${timestamp}${random}`;

    // Add user and request number to data
    ctx.request.body.data = {
      ...ctx.request.body.data,
      user: user.id,
      requestNumber,
      status: 'pending',
      contactEmail: ctx.request.body.data.contactEmail || user.email,
    };

    return super.create(ctx);
  },

  /**
   * Update not allowed for users (admin only via Content Manager)
   */
  async update(ctx) {
    // Only allow updates via API token (admin)
    if (!ctx.state.auth?.credentials?.type === 'api-token') {
      return ctx.forbidden('Árajánlat kérés módosítása nem engedélyezett');
    }
    return super.update(ctx);
  },

  /**
   * Delete not allowed
   */
  async delete(ctx) {
    return ctx.forbidden('Árajánlat kérés törlése nem engedélyezett');
  },
}));
```
  </action>
  <verify>
    - Controller filters by user ownership
    - Create generates request number
    - Update/delete restricted
  </verify>
  <done>QuoteRequest controller created</done>
</task>

<task type="auto">
  <name>Task 3: Create QuoteRequest service and routes</name>
  <files>
    apps/cms/src/api/quote-request/services/quote-request.ts
    apps/cms/src/api/quote-request/routes/quote-request.ts
  </files>
  <action>
Create service at `apps/cms/src/api/quote-request/services/quote-request.ts`:

```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreService('api::quote-request.quote-request');
```

Create routes at `apps/cms/src/api/quote-request/routes/quote-request.ts`:

```typescript
import { factories } from '@strapi/strapi';

export default factories.createCoreRouter('api::quote-request.quote-request');
```
  </action>
  <verify>
    - Service file exists
    - Routes file exists
  </verify>
  <done>QuoteRequest service and routes created</done>
</task>

<task type="auto">
  <name>Task 4: Create TypeScript interfaces</name>
  <files>
    packages/types/src/quote.ts
    packages/types/src/index.ts
  </files>
  <action>
Create quote types at `packages/types/src/quote.ts`:

```typescript
export type QuoteStatus = 'pending' | 'quoted' | 'converted' | 'declined' | 'expired';

export interface QuoteItem {
  productId: string;
  productName: string;
  variantId?: string;
  variantName?: string;
  sku: string;
  quantity: number;
  unitPrice?: number;
  totalPrice?: number;
}

export interface QuoteRequest {
  id: number;
  documentId: string;
  requestNumber: string;
  status: QuoteStatus;
  items: QuoteItem[];
  deliveryNotes?: string;
  companyName?: string;
  contactEmail: string;
  contactPhone?: string;
  adminNotes?: string;
  adminResponse?: string;
  quotedAmount?: number;
  quotedAt?: string;
  validUntil?: string;
  createdAt: string;
  updatedAt: string;
}

export interface CreateQuoteRequestInput {
  items: QuoteItem[];
  deliveryNotes?: string;
  companyName?: string;
  contactEmail?: string;
  contactPhone?: string;
}
```

Update `packages/types/src/index.ts` to export quote types:

```typescript
// Add to existing exports
export * from './quote.js';
```
  </action>
  <verify>
    - Quote types file exists
    - Types exported from index
    - `pnpm --filter @csz/types build` succeeds
  </verify>
  <done>TypeScript interfaces created</done>
</task>

<task type="auto">
  <name>Task 5: Build and verify</name>
  <files>none</files>
  <action>
Build all packages to verify no TypeScript errors:

```bash
pnpm --filter @csz/types build
pnpm --filter @csz/cms build
```

Start Strapi and verify:
1. QuoteRequest appears in Content Manager
2. Can create a test quote request via admin
3. Status dropdown works
4. User relation works
  </action>
  <verify>
    - Types package builds
    - CMS builds
    - QuoteRequest visible in Strapi admin
  </verify>
  <done>Build verification complete</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. QuoteRequest content type exists in Strapi
2. Schema has all required fields
3. Controller filters by user ownership
4. TypeScript interfaces defined
5. All builds pass

Requirements started:
- QUOT-01: Foundation for quote requests
- ADMN-20: Admin can view in Content Manager
</verification>

<success_criteria>
- QuoteRequest content type in Strapi
- Status enum: pending, quoted, converted, declined, expired
- User relation for ownership
- TypeScript interfaces for QuoteRequest and QuoteItem
- CMS and types build successfully
</success_criteria>
