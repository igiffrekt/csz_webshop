---
phase: 08-b2b-quote-system
plan: 02
type: execute
wave: 1
depends_on: [08-01]
files_modified:
  - apps/web/src/lib/quote-api.ts
  - apps/web/src/app/[locale]/ajanlatkeres/page.tsx
  - apps/web/src/app/[locale]/ajanlatkeres/QuoteRequestForm.tsx
  - apps/web/src/app/[locale]/ajanlatkeres/ProductSelector.tsx
  - apps/web/src/app/[locale]/ajanlatkeres/sikeres/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can access quote request form at /ajanlatkeres"
    - "User can search and add products with quantities"
    - "User can add delivery notes"
    - "Form submits to Strapi API"
    - "Success page shows after submission"
  artifacts:
    - path: "apps/web/src/app/[locale]/ajanlatkeres/page.tsx"
      provides: "Quote request page"
      contains: "ajanlatkeres"
    - path: "apps/web/src/lib/quote-api.ts"
      provides: "Quote API client"
      contains: "createQuoteRequest"
---

<objective>
Create quote request form and submission flow.

Purpose: QUOT-01 (request quote), QUOT-02 (specify products, quantities, notes).

Output: Quote request page with product selector, quantity inputs, notes field.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create quote API client</name>
  <files>
    apps/web/src/lib/quote-api.ts
  </files>
  <action>
Create quote API client at `apps/web/src/lib/quote-api.ts`:

```typescript
'use server';

import { getSession } from '@/lib/auth/session';
import type { QuoteRequest, CreateQuoteRequestInput } from '@csz/types';

const STRAPI_URL = process.env.STRAPI_URL || 'http://localhost:1337';

async function getAuthHeaders() {
  const session = await getSession();
  if (!session?.strapiToken) {
    throw new Error('Bejelentkezés szükséges');
  }
  return {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${session.strapiToken}`,
  };
}

export async function createQuoteRequest(
  input: CreateQuoteRequestInput
): Promise<{ data: QuoteRequest | null; error?: string }> {
  try {
    const headers = await getAuthHeaders();

    const response = await fetch(`${STRAPI_URL}/api/quote-requests`, {
      method: 'POST',
      headers,
      body: JSON.stringify({ data: input }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      return { data: null, error: errorData.error?.message || 'Hiba történt az árajánlat kérés küldésekor' };
    }

    const json = await response.json();
    return { data: json.data };
  } catch (error) {
    return { data: null, error: 'Kapcsolódási hiba' };
  }
}

export async function getQuoteRequests(): Promise<{ data: QuoteRequest[]; error?: string }> {
  try {
    const headers = await getAuthHeaders();

    const response = await fetch(`${STRAPI_URL}/api/quote-requests`, {
      headers,
    });

    if (!response.ok) {
      return { data: [], error: 'Hiba történt az árajánlat kérések lekérésekor' };
    }

    const json = await response.json();
    return { data: json.data || [] };
  } catch (error) {
    return { data: [], error: 'Kapcsolódási hiba' };
  }
}

export async function getQuoteRequest(
  documentId: string
): Promise<{ data: QuoteRequest | null; error?: string }> {
  try {
    const headers = await getAuthHeaders();

    const response = await fetch(`${STRAPI_URL}/api/quote-requests/${documentId}`, {
      headers,
    });

    if (!response.ok) {
      return { data: null, error: 'Árajánlat kérés nem található' };
    }

    const json = await response.json();
    return { data: json.data };
  } catch (error) {
    return { data: null, error: 'Kapcsolódási hiba' };
  }
}
```
  </action>
  <verify>
    - API client functions exist
    - Uses server-side session for auth
    - Proper Hungarian error messages
  </verify>
  <done>Quote API client created</done>
</task>

<task type="auto">
  <name>Task 2: Create ProductSelector component</name>
  <files>
    apps/web/src/app/[locale]/ajanlatkeres/ProductSelector.tsx
  </files>
  <action>
Create product selector component at `apps/web/src/app/[locale]/ajanlatkeres/ProductSelector.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Search, Plus, Minus, X } from 'lucide-react';
import type { QuoteItem } from '@csz/types';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000';
const STRAPI_URL = process.env.NEXT_PUBLIC_STRAPI_URL || 'http://localhost:1337';

interface Product {
  documentId: string;
  name: string;
  sku: string;
  basePrice: number;
}

interface ProductSelectorProps {
  items: QuoteItem[];
  onItemsChange: (items: QuoteItem[]) => void;
}

export function ProductSelector({ items, onItemsChange }: ProductSelectorProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<Product[]>([]);
  const [isSearching, setIsSearching] = useState(false);

  const handleSearch = async () => {
    if (!searchQuery.trim()) return;

    setIsSearching(true);
    try {
      const params = new URLSearchParams({
        'filters[name][$containsi]': searchQuery,
        'fields[0]': 'name',
        'fields[1]': 'sku',
        'fields[2]': 'basePrice',
        'pagination[limit]': '10',
      });

      const response = await fetch(`${STRAPI_URL}/api/products?${params}`);
      if (response.ok) {
        const json = await response.json();
        setSearchResults(json.data || []);
      }
    } catch (error) {
      console.error('Search failed:', error);
    } finally {
      setIsSearching(false);
    }
  };

  const addProduct = (product: Product) => {
    const existingIndex = items.findIndex(item => item.productId === product.documentId);

    if (existingIndex >= 0) {
      // Increase quantity if already in list
      const newItems = [...items];
      newItems[existingIndex].quantity += 1;
      onItemsChange(newItems);
    } else {
      // Add new item
      const newItem: QuoteItem = {
        productId: product.documentId,
        productName: product.name,
        sku: product.sku,
        quantity: 1,
      };
      onItemsChange([...items, newItem]);
    }

    // Clear search
    setSearchQuery('');
    setSearchResults([]);
  };

  const updateQuantity = (index: number, delta: number) => {
    const newItems = [...items];
    newItems[index].quantity = Math.max(1, newItems[index].quantity + delta);
    onItemsChange(newItems);
  };

  const setQuantity = (index: number, quantity: number) => {
    const newItems = [...items];
    newItems[index].quantity = Math.max(1, quantity);
    onItemsChange(newItems);
  };

  const removeItem = (index: number) => {
    onItemsChange(items.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-4">
      {/* Search */}
      <div className="flex gap-2">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            type="text"
            placeholder="Termék keresése..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
            className="pl-10"
          />
        </div>
        <Button onClick={handleSearch} disabled={isSearching}>
          Keresés
        </Button>
      </div>

      {/* Search Results */}
      {searchResults.length > 0 && (
        <div className="border rounded-lg divide-y">
          {searchResults.map((product) => (
            <div
              key={product.documentId}
              className="p-3 flex justify-between items-center hover:bg-muted/50"
            >
              <div>
                <p className="font-medium">{product.name}</p>
                <p className="text-sm text-muted-foreground">SKU: {product.sku}</p>
              </div>
              <Button size="sm" onClick={() => addProduct(product)}>
                <Plus className="h-4 w-4 mr-1" />
                Hozzáadás
              </Button>
            </div>
          ))}
        </div>
      )}

      {/* Selected Items */}
      {items.length > 0 && (
        <div className="border rounded-lg divide-y">
          <div className="p-3 bg-muted/50 font-medium">
            Kiválasztott termékek ({items.length})
          </div>
          {items.map((item, index) => (
            <div key={index} className="p-3 flex justify-between items-center">
              <div className="flex-1">
                <p className="font-medium">{item.productName}</p>
                <p className="text-sm text-muted-foreground">SKU: {item.sku}</p>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="icon"
                  className="h-8 w-8"
                  onClick={() => updateQuantity(index, -1)}
                >
                  <Minus className="h-4 w-4" />
                </Button>
                <Input
                  type="number"
                  min={1}
                  value={item.quantity}
                  onChange={(e) => setQuantity(index, parseInt(e.target.value) || 1)}
                  className="w-20 text-center"
                />
                <Button
                  variant="outline"
                  size="icon"
                  className="h-8 w-8"
                  onClick={() => updateQuantity(index, 1)}
                >
                  <Plus className="h-4 w-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8 text-destructive"
                  onClick={() => removeItem(index)}
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            </div>
          ))}
        </div>
      )}

      {items.length === 0 && searchResults.length === 0 && (
        <div className="text-center py-8 text-muted-foreground border rounded-lg border-dashed">
          Keressen termékeket a fenti mezőben
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    - Product search works
    - Can add products to list
    - Quantity controls work
    - Can remove items
  </verify>
  <done>ProductSelector component created</done>
</task>

<task type="auto">
  <name>Task 3: Create QuoteRequestForm component</name>
  <files>
    apps/web/src/app/[locale]/ajanlatkeres/QuoteRequestForm.tsx
  </files>
  <action>
Create form component at `apps/web/src/app/[locale]/ajanlatkeres/QuoteRequestForm.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { AlertCircle, Loader2, Send } from 'lucide-react';
import { ProductSelector } from './ProductSelector';
import { createQuoteRequest } from '@/lib/quote-api';
import type { QuoteItem } from '@csz/types';

interface QuoteRequestFormProps {
  userEmail: string;
  companyName?: string;
  phone?: string;
}

export function QuoteRequestForm({ userEmail, companyName, phone }: QuoteRequestFormProps) {
  const router = useRouter();
  const [items, setItems] = useState<QuoteItem[]>([]);
  const [deliveryNotes, setDeliveryNotes] = useState('');
  const [contactEmail, setContactEmail] = useState(userEmail);
  const [contactPhone, setContactPhone] = useState(phone || '');
  const [company, setCompany] = useState(companyName || '');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (items.length === 0) {
      setError('Kérem adjon hozzá legalább egy terméket');
      return;
    }

    setIsSubmitting(true);
    setError(null);

    const { data, error: apiError } = await createQuoteRequest({
      items,
      deliveryNotes: deliveryNotes || undefined,
      companyName: company || undefined,
      contactEmail,
      contactPhone: contactPhone || undefined,
    });

    if (apiError || !data) {
      setError(apiError || 'Hiba történt az árajánlat kérés küldésekor');
      setIsSubmitting(false);
      return;
    }

    // Redirect to success page
    router.push(`/hu/ajanlatkeres/sikeres?id=${data.documentId}`);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Products Section */}
      <div className="space-y-2">
        <Label className="text-base font-semibold">Termékek *</Label>
        <p className="text-sm text-muted-foreground">
          Keresse meg és adja hozzá a kívánt termékeket a mennyiséggel
        </p>
        <ProductSelector items={items} onItemsChange={setItems} />
      </div>

      {/* Delivery Notes */}
      <div className="space-y-2">
        <Label htmlFor="deliveryNotes">Megjegyzések a szállításhoz</Label>
        <Textarea
          id="deliveryNotes"
          placeholder="Speciális igények, szállítási határidő, stb."
          value={deliveryNotes}
          onChange={(e) => setDeliveryNotes(e.target.value)}
          rows={4}
        />
      </div>

      {/* Contact Info */}
      <div className="grid gap-4 sm:grid-cols-2">
        <div className="space-y-2">
          <Label htmlFor="companyName">Cégnév</Label>
          <Input
            id="companyName"
            value={company}
            onChange={(e) => setCompany(e.target.value)}
            placeholder="Cég neve"
          />
        </div>
        <div className="space-y-2">
          <Label htmlFor="contactEmail">Kapcsolattartó email *</Label>
          <Input
            id="contactEmail"
            type="email"
            required
            value={contactEmail}
            onChange={(e) => setContactEmail(e.target.value)}
          />
        </div>
        <div className="space-y-2 sm:col-span-2 sm:w-1/2">
          <Label htmlFor="contactPhone">Telefonszám</Label>
          <Input
            id="contactPhone"
            type="tel"
            value={contactPhone}
            onChange={(e) => setContactPhone(e.target.value)}
            placeholder="+36 ..."
          />
        </div>
      </div>

      {/* Error */}
      {error && (
        <div className="flex items-center gap-2 text-destructive text-sm">
          <AlertCircle className="h-4 w-4" />
          <span>{error}</span>
        </div>
      )}

      {/* Submit */}
      <div className="pt-4 border-t">
        <Button
          type="submit"
          disabled={isSubmitting || items.length === 0}
          size="lg"
          className="w-full sm:w-auto"
        >
          {isSubmitting ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              Küldés...
            </>
          ) : (
            <>
              <Send className="mr-2 h-4 w-4" />
              Árajánlat kérés küldése
            </>
          )}
        </Button>
      </div>
    </form>
  );
}
```
  </action>
  <verify>
    - Form renders all fields
    - Validation for items
    - Submit calls API
    - Redirects on success
  </verify>
  <done>QuoteRequestForm component created</done>
</task>

<task type="auto">
  <name>Task 4: Create quote request page</name>
  <files>
    apps/web/src/app/[locale]/ajanlatkeres/page.tsx
  </files>
  <action>
Create page at `apps/web/src/app/[locale]/ajanlatkeres/page.tsx`:

```typescript
import { requireAuth } from '@/lib/auth/dal';
import { getCurrentUserProfile } from '@/lib/auth/actions';
import { QuoteRequestForm } from './QuoteRequestForm';
import { FileText } from 'lucide-react';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Árajánlat kérés | CSZ Tűzvédelmi Webshop',
  description: 'Kérjen árajánlatot nagyobb mennyiségű rendeléshez',
};

export default async function QuoteRequestPage() {
  const session = await requireAuth();
  const { data: profile } = await getCurrentUserProfile();

  return (
    <main className="container mx-auto px-4 py-8 max-w-3xl">
      <div className="text-center mb-8">
        <div className="w-16 h-16 mx-auto mb-4 bg-primary/10 rounded-full flex items-center justify-center">
          <FileText className="w-8 h-8 text-primary" />
        </div>
        <h1 className="text-2xl font-bold mb-2">Árajánlat kérés</h1>
        <p className="text-muted-foreground">
          Nagyobb mennyiségű rendeléshez kérjen egyedi árajánlatot.
          Munkatársunk hamarosan felveszi Önnel a kapcsolatot.
        </p>
      </div>

      <div className="border rounded-lg p-6">
        <QuoteRequestForm
          userEmail={profile?.email || ''}
          companyName={profile?.companyName}
          phone={profile?.phone}
        />
      </div>
    </main>
  );
}
```
  </action>
  <verify>
    - Page requires auth
    - Pre-fills user info
    - Renders form
  </verify>
  <done>Quote request page created</done>
</task>

<task type="auto">
  <name>Task 5: Create success page</name>
  <files>
    apps/web/src/app/[locale]/ajanlatkeres/sikeres/page.tsx
  </files>
  <action>
Create success page at `apps/web/src/app/[locale]/ajanlatkeres/sikeres/page.tsx`:

```typescript
import { redirect } from 'next/navigation';
import { requireAuth } from '@/lib/auth/dal';
import { getQuoteRequest } from '@/lib/quote-api';
import { Button } from '@/components/ui/button';
import { Link } from '@/i18n/navigation';
import { CheckCircle, FileText, Home } from 'lucide-react';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Árajánlat kérés elküldve | CSZ Tűzvédelmi Webshop',
  description: 'Az árajánlat kérését megkaptuk',
};

interface Props {
  searchParams: Promise<{ id?: string }>;
}

export default async function QuoteSuccessPage({ searchParams }: Props) {
  await requireAuth();

  const { id } = await searchParams;

  if (!id) {
    redirect('/hu/ajanlatkeres');
  }

  const { data: quoteRequest, error } = await getQuoteRequest(id);

  return (
    <main className="container mx-auto px-4 py-8 max-w-2xl text-center">
      <div className="py-12">
        <div className="w-20 h-20 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
          <CheckCircle className="w-10 h-10 text-green-600" />
        </div>

        <h1 className="text-2xl font-bold mb-4">Köszönjük az árajánlat kérését!</h1>

        {quoteRequest && (
          <p className="text-lg text-muted-foreground mb-2">
            Kérés azonosító: <span className="font-mono font-medium">{quoteRequest.requestNumber}</span>
          </p>
        )}

        <p className="text-muted-foreground mb-8">
          Munkatársunk hamarosan felveszi Önnel a kapcsolatot a megadott elérhetőségeken.
          Az árajánlat kéréseit megtekintheti a fiókjában.
        </p>

        {quoteRequest && quoteRequest.items.length > 0 && (
          <div className="border rounded-lg p-4 mb-8 text-left">
            <h2 className="font-semibold mb-3">Kért termékek:</h2>
            <ul className="space-y-2">
              {quoteRequest.items.map((item, index) => (
                <li key={index} className="flex justify-between text-sm">
                  <span>{item.productName}</span>
                  <span className="text-muted-foreground">{item.quantity} db</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Button asChild>
            <Link href="/fiok/ajanlatkeres">
              <FileText className="mr-2 h-4 w-4" />
              Árajánlat kéréseim
            </Link>
          </Button>
          <Button variant="outline" asChild>
            <Link href="/">
              <Home className="mr-2 h-4 w-4" />
              Vissza a főoldalra
            </Link>
          </Button>
        </div>
      </div>
    </main>
  );
}
```
  </action>
  <verify>
    - Shows confirmation
    - Displays request number
    - Shows requested items
    - Links to history and home
  </verify>
  <done>Success page created</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Navigate to /ajanlatkeres
2. Search for products and add with quantities
3. Fill in contact info
4. Submit form
5. Verify redirect to success page
6. Verify quote request created in Strapi

QUOT-01: ✓ User can request quote
QUOT-02: ✓ User can specify products, quantities, notes
</verification>

<success_criteria>
- Quote request form accessible at /ajanlatkeres
- Product search and selection works
- Quantity controls work
- Form submits to Strapi API
- Success page shows confirmation
- Quote request visible in Strapi admin
</success_criteria>
