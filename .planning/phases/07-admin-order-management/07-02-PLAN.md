---
phase: 07-admin-order-management
plan: 02
type: execute
wave: 1
depends_on: [07-01]
files_modified:
  - apps/cms/src/api/order/content-types/order/lifecycles.ts
autonomous: true

must_haves:
  truths:
    - "Status change triggers lifecycle hook"
    - "Email sent to customer when order ships"
    - "Admin can update order status"
  artifacts:
    - path: "apps/cms/src/api/order/content-types/order/lifecycles.ts"
      provides: "Order lifecycle hooks"
      contains: "beforeUpdate"
---

<objective>
Add lifecycle hooks for Order status changes to notify customers.

Purpose: ADMN-13 (update order status) with customer notification. When admin changes status to "shipped", customer receives email notification.

Output: Order lifecycle hooks with email notification on status change.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create Order lifecycle hooks</name>
  <files>
    apps/cms/src/api/order/content-types/order/lifecycles.ts
  </files>
  <action>
Create lifecycle hooks file at `apps/cms/src/api/order/content-types/order/lifecycles.ts`:

```typescript
import type { Core } from '@strapi/strapi';

const lifecycles = {
  async afterUpdate(event: { params: { data: any; where: { id: number } }; result: any }) {
    const { result } = event;

    // Check if status changed to shipped
    if (result.status === 'shipped') {
      try {
        // Get the order with user relation populated
        const order = await strapi.db.query('api::order.order').findOne({
          where: { id: result.id },
          populate: ['user'],
        });

        if (!order?.user?.email) {
          strapi.log.warn(`Order ${order?.orderNumber}: No user email for shipping notification`);
          return;
        }

        // Send shipping notification email
        await strapi.plugins['email'].services.email.send({
          to: order.user.email,
          subject: `Rendelése úton van! - ${order.orderNumber}`,
          html: `
            <h1>Kedves ${order.user.firstName || 'Vásárló'}!</h1>
            <p>Örömmel értesítjük, hogy a <strong>${order.orderNumber}</strong> számú rendelése feladásra került.</p>
            <p>A csomag hamarosan megérkezik a megadott szállítási címre.</p>
            <h2>Szállítási cím:</h2>
            <p>
              ${order.shippingAddress?.recipientName}<br>
              ${order.shippingAddress?.street}<br>
              ${order.shippingAddress?.postalCode} ${order.shippingAddress?.city}
            </p>
            <p>Köszönjük, hogy nálunk vásárolt!</p>
            <p>Üdvözlettel,<br>CSZ Tűzvédelmi Webshop</p>
          `,
        });

        strapi.log.info(`Shipping notification sent for order ${order.orderNumber}`);
      } catch (error) {
        strapi.log.error(`Failed to send shipping notification: ${error}`);
      }
    }

    // Log status changes for audit
    if (result.status) {
      strapi.log.info(`Order ${result.orderNumber} status changed to: ${result.status}`);
    }
  },
};

export default lifecycles;
```

This lifecycle hook:
1. Triggers after order update
2. Checks if status changed to "shipped"
3. Sends email notification to customer
4. Logs all status changes for audit trail
  </action>
  <verify>
    - Lifecycle file created
    - CMS builds without errors: `pnpm --filter @csz/cms build`
    - Log message appears when status changes
  </verify>
  <done>Order lifecycle hooks created</done>
</task>

<task type="auto">
  <name>Task 2: Test status change notification</name>
  <files>none (testing only)</files>
  <action>
Test the lifecycle hook:

1. Start Strapi: `cd apps/cms && pnpm dev`
2. Log in to admin panel
3. Find an existing order (or create a test one via checkout)
4. Change status from any value to "shipped"
5. Check Strapi console logs for "Shipping notification sent"
6. If using Mailtrap, check email received

Note: Email sending depends on SMTP configuration from Phase 5.
If email fails, the status change still succeeds (non-blocking).
  </action>
  <verify>
    - Status change works in admin
    - Log message shows notification attempt
    - Email sent (or logged if SMTP not configured)
  </verify>
  <done>Status change notification tested</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build CMS: `pnpm --filter @csz/cms build`
2. Start services and log in to admin
3. Update an order status to "shipped"
4. Verify email notification sent (check logs/Mailtrap)
5. Verify customer can see updated status in their order history

ADMN-13: ✓ Admin can update order status (with notification)
</verification>

<success_criteria>
- Lifecycle hooks file exists and compiles
- Status change to "shipped" triggers email
- Email contains order number and shipping address
- Status changes are logged
- Non-shipped status changes don't trigger email
</success_criteria>
