---
phase: 04-shopping-cart
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/stores/cart.ts
  - apps/web/src/stores/useHydration.ts
  - apps/web/package.json
  - packages/types/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Cart state persists across browser sessions"
    - "Cart items can be added, removed, and updated"
    - "Cart totals calculate correctly"
    - "No hydration mismatch errors on page load"
  artifacts:
    - path: "apps/web/src/stores/cart.ts"
      provides: "Zustand cart store with persistence"
      exports: ["useCartStore", "useCartItems", "useCartItemCount"]
      min_lines: 80
    - path: "apps/web/src/stores/useHydration.ts"
      provides: "Hydration hook for SSR safety"
      exports: ["useHydration"]
  key_links:
    - from: "apps/web/src/stores/cart.ts"
      to: "localStorage"
      via: "zustand persist middleware"
      pattern: "persist.*localStorage"
    - from: "apps/web/src/stores/cart.ts"
      to: "@csz/types"
      via: "CartItem interface"
      pattern: "import.*@csz/types"
---

<objective>
Create Zustand cart store with localStorage persistence and hydration safety.

Purpose: The cart store is the foundation for all cart functionality. It manages cart items, quantities, and coupon state with automatic persistence to localStorage so carts survive browser sessions.

Output: Zustand store with addItem, removeItem, updateQuantity, clearCart, and coupon actions. Hydration hook to prevent SSR mismatches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shopping-cart/04-RESEARCH.md
@packages/types/src/index.ts
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zustand dependency</name>
  <files>apps/web/package.json</files>
  <action>
Install Zustand for state management in the web app:

```bash
cd apps/web && pnpm add zustand
```

Zustand 5.x will be installed. No additional configuration needed - it works with Next.js App Router out of the box.
  </action>
  <verify>
Check apps/web/package.json contains zustand in dependencies.
Run `pnpm install` from root to update lockfile.
  </verify>
  <done>
Zustand installed and available for import in web app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CartItem and AppliedCoupon types to shared types</name>
  <files>packages/types/src/index.ts</files>
  <action>
Add cart-specific interfaces after the Coupon interface (or after ProductVariant if Coupon not yet added):

```typescript
// Cart item for client-side cart state
export interface CartItem {
  id: string;                    // Unique cart line item ID (productDocId-variantDocId or just productDocId)
  productId: number;             // Strapi product ID
  productDocumentId: string;     // Strapi documentId for API calls
  variantId?: number;            // Optional variant ID
  variantDocumentId?: string;    // Variant documentId
  name: string;                  // Product name for display
  variantName?: string;          // Variant name (e.g., "6kg")
  sku: string;                   // SKU for the specific item
  price: number;                 // Price at time of adding (in HUF)
  quantity: number;              // Quantity in cart
  image?: string;                // Product image URL (full URL)
  maxStock: number;              // Max available for quantity validation
}

// Applied coupon in cart
export interface AppliedCoupon {
  code: string;
  discountType: 'percentage' | 'fixed';
  discountValue: number;
  discountAmount: number;        // Calculated discount in HUF
}
```
  </action>
  <verify>
Run `pnpm build` from root to verify TypeScript compilation.
  </verify>
  <done>
CartItem and AppliedCoupon interfaces available for cart store and components.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand cart store with persist middleware</name>
  <files>apps/web/src/stores/cart.ts</files>
  <action>
Create the cart store following the pattern from 04-RESEARCH.md:

```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import type { Product, ProductVariant, CartItem, AppliedCoupon } from '@csz/types';
import { getStrapiMediaUrl } from '@/lib/formatters';

interface CartState {
  items: CartItem[];
  coupon: AppliedCoupon | null;

  // Actions
  addItem: (product: Product, variant?: ProductVariant, quantity?: number) => void;
  removeItem: (id: string) => void;
  updateQuantity: (id: string, quantity: number) => void;
  clearCart: () => void;
  applyCoupon: (coupon: AppliedCoupon) => void;
  removeCoupon: () => void;

  // Computed (implemented as getters)
  getItemCount: () => number;
  getSubtotal: () => number;
  getDiscount: () => number;
  getTotal: () => number;
}

export const useCartStore = create<CartState>()(
  persist(
    (set, get) => ({
      items: [],
      coupon: null,

      addItem: (product, variant, quantity = 1) => {
        const itemId = variant
          ? `${product.documentId}-${variant.documentId}`
          : product.documentId;

        set((state) => {
          const existingItem = state.items.find(item => item.id === itemId);

          if (existingItem) {
            const newQuantity = Math.min(
              existingItem.quantity + quantity,
              existingItem.maxStock
            );
            return {
              items: state.items.map(item =>
                item.id === itemId ? { ...item, quantity: newQuantity } : item
              ),
            };
          }

          const imageUrl = product.images?.[0]?.url
            ? getStrapiMediaUrl(product.images[0].url)
            : undefined;

          const newItem: CartItem = {
            id: itemId,
            productId: product.id,
            productDocumentId: product.documentId,
            variantId: variant?.id,
            variantDocumentId: variant?.documentId,
            name: product.name,
            variantName: variant?.name,
            sku: variant?.sku ?? product.sku,
            price: variant?.price ?? product.basePrice,
            quantity,
            image: imageUrl,
            maxStock: variant?.stock ?? product.stock,
          };

          return { items: [...state.items, newItem] };
        });
      },

      removeItem: (id) => set((state) => ({
        items: state.items.filter(item => item.id !== id),
      })),

      updateQuantity: (id, quantity) => set((state) => {
        if (quantity <= 0) {
          return { items: state.items.filter(item => item.id !== id) };
        }
        return {
          items: state.items.map(item =>
            item.id === id
              ? { ...item, quantity: Math.min(quantity, item.maxStock) }
              : item
          ),
        };
      }),

      clearCart: () => set({ items: [], coupon: null }),

      applyCoupon: (coupon) => set({ coupon }),

      removeCoupon: () => set({ coupon: null }),

      getItemCount: () => get().items.reduce((sum, item) => sum + item.quantity, 0),

      getSubtotal: () => get().items.reduce(
        (sum, item) => sum + (item.price * item.quantity), 0
      ),

      getDiscount: () => {
        const { coupon } = get();
        return coupon ? coupon.discountAmount : 0;
      },

      getTotal: () => Math.max(0, get().getSubtotal() - get().getDiscount()),
    }),
    {
      name: 'csz-cart',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        items: state.items,
        coupon: state.coupon,
      }),
    }
  )
);

// Selectors for optimized re-renders
export const useCartItems = () => useCartStore((state) => state.items);
export const useCartItemCount = () => useCartStore((state) => state.getItemCount());
export const useCartSubtotal = () => useCartStore((state) => state.getSubtotal());
export const useCartDiscount = () => useCartStore((state) => state.getDiscount());
export const useCartTotal = () => useCartStore((state) => state.getTotal());
export const useCartCoupon = () => useCartStore((state) => state.coupon);
```

Create `stores` directory if it doesn't exist.
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
Verify file exists at apps/web/src/stores/cart.ts.
  </verify>
  <done>
Cart store created with all CRUD operations, coupon support, and localStorage persistence.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create hydration hook for SSR safety</name>
  <files>apps/web/src/stores/useHydration.ts</files>
  <action>
Create hydration hook to prevent "Hydration failed" errors when server renders empty cart but client loads from localStorage:

```typescript
'use client';

import { useEffect, useState } from 'react';

/**
 * Hook to detect when client-side hydration is complete.
 * Use this to conditionally render cart count/items that differ
 * between server (empty) and client (localStorage).
 *
 * @returns true when component is hydrated and safe to show client state
 */
export function useHydration() {
  const [hydrated, setHydrated] = useState(false);

  useEffect(() => {
    setHydrated(true);
  }, []);

  return hydrated;
}
```
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
  </verify>
  <done>
Hydration hook available for cart components to safely render client-side state.
  </done>
</task>

</tasks>

<verification>
Test cart store functionality:

1. Start dev server: `pnpm dev:web`
2. Open browser console and test store:
```javascript
// In browser console
const { useCartStore } = await import('/src/stores/cart.ts');
const store = useCartStore.getState();
console.log(store.items); // Should be []

// Test add (mock product)
store.addItem({
  id: 1,
  documentId: 'test-1',
  name: 'Test Product',
  sku: 'TEST-001',
  basePrice: 15000,
  stock: 10,
  isFeatured: false,
  isOnSale: false
});
console.log(store.items); // Should have 1 item

// Test persistence - refresh page and check localStorage
localStorage.getItem('csz-cart'); // Should contain cart data
```

3. Verify production build: `cd apps/web && pnpm build` (no TypeScript errors)
</verification>

<success_criteria>
- Zustand installed in web app
- CartItem and AppliedCoupon types in @csz/types
- Cart store exports useCartStore and selector hooks
- addItem creates new items or increments existing quantity
- removeItem deletes items by ID
- updateQuantity changes quantity or removes if <= 0
- clearCart empties cart and removes coupon
- Cart persists to localStorage under 'csz-cart' key
- useHydration hook returns false on server, true after mount
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-cart/04-02-SUMMARY.md`
</output>
