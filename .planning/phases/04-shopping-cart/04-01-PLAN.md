---
phase: 04-shopping-cart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/cms/src/api/coupon/content-types/coupon/schema.json
  - apps/cms/src/api/coupon/controllers/coupon.ts
  - apps/cms/src/api/coupon/routes/coupon.ts
  - apps/cms/src/api/coupon/services/coupon.ts
  - packages/types/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create a coupon with code, discount type, and value"
    - "Admin can set coupon usage limit and expiration date"
    - "Admin can enable or disable a coupon"
    - "Coupon data is accessible via Strapi API"
  artifacts:
    - path: "apps/cms/src/api/coupon/content-types/coupon/schema.json"
      provides: "Coupon content type definition"
      contains: "discountType"
    - path: "packages/types/src/index.ts"
      provides: "Coupon TypeScript interface"
      contains: "interface Coupon"
  key_links:
    - from: "apps/cms/src/api/coupon/content-types/coupon/schema.json"
      to: "Strapi Admin"
      via: "Strapi content type registration"
      pattern: "collectionType"
---

<objective>
Create the Coupon content type in Strapi CMS for admin coupon management.

Purpose: Admins need to create and manage discount coupons with percentage or fixed discounts, usage limits, and expiration dates. This enables the user-facing coupon application in cart.

Output: Strapi Coupon collection type with all ADMN-15 through ADMN-19 fields, plus TypeScript type definition.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shopping-cart/04-RESEARCH.md
@apps/cms/src/api/product/content-types/product/schema.json
@packages/types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Coupon content type in Strapi</name>
  <files>
    apps/cms/src/api/coupon/content-types/coupon/schema.json
    apps/cms/src/api/coupon/controllers/coupon.ts
    apps/cms/src/api/coupon/routes/coupon.ts
    apps/cms/src/api/coupon/services/coupon.ts
  </files>
  <action>
Create the Coupon collection type following Strapi 5 patterns from existing content types.

Schema fields (schema.json):
- code: string, required, unique, maxLength 50 (uppercase coupon code)
- description: text, optional (admin notes)
- discountType: enumeration ['percentage', 'fixed'], required, default 'percentage'
- discountValue: integer, required, min 0 (percentage 0-100 or fixed HUF amount)
- minimumOrderAmount: integer, default 0, min 0 (minimum cart total to apply)
- maximumDiscount: integer, min 0, optional (cap for percentage discounts)
- usageLimit: integer, min 0, optional (max number of uses, null = unlimited)
- usedCount: integer, default 0, min 0 (current usage count)
- validFrom: datetime, optional (coupon valid from this date)
- validUntil: datetime, optional (coupon expires after this date)
- isActive: boolean, default true (admin toggle to enable/disable)

Use draftAndPublish: true for content workflow.

Create standard controller, routes, and service files following Strapi 5 pattern (export factories from @strapi/strapi).
  </action>
  <verify>
Run `pnpm dev:cms` and verify:
1. Coupon appears in Strapi Admin sidebar under Content Manager
2. Can create new coupon with all fields
3. discountType dropdown shows "percentage" and "fixed" options
  </verify>
  <done>
Coupon content type exists in Strapi with all fields for discount management. Admin can create coupons with codes, discount types, limits, and expiration dates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Coupon TypeScript interface to shared types</name>
  <files>packages/types/src/index.ts</files>
  <action>
Add Coupon interface to the shared types package matching the Strapi schema:

```typescript
// Coupon content type
export interface Coupon {
  id: number;
  documentId: string;
  code: string;
  description?: string;
  discountType: 'percentage' | 'fixed';
  discountValue: number;
  minimumOrderAmount: number;
  maximumDiscount?: number;
  usageLimit?: number;
  usedCount: number;
  validFrom?: string;
  validUntil?: string;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
  publishedAt: string;
}
```

Place after ProductVariant interface, before StrapiResponse interfaces.
  </action>
  <verify>
Run `pnpm build` from root to verify TypeScript compilation passes with no errors.
  </verify>
  <done>
Coupon interface exported from @csz/types package and available for use in API and web apps.
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure public read access for Coupon API</name>
  <files>apps/cms/src/bootstrap/permissions.ts</files>
  <action>
If permissions.ts exists, add coupon to the public permissions configuration (find only, not findOne - coupons are validated by code, not browsed).

If permissions are configured via Strapi admin, document the required permission:
- Public role: api::coupon.coupon.find (for coupon validation endpoint)

Actually, since coupon validation will go through Fastify API (not direct Strapi access from frontend), we need internal API access. Add coupon to Store Manager role permissions for full CRUD in the bootstrap file.

Check existing bootstrap pattern in apps/cms/src/bootstrap.ts or similar and follow the same pattern used for products/categories.
  </action>
  <verify>
Restart Strapi and verify:
1. GET http://localhost:1337/api/coupons returns 200 (may be empty array)
2. Store Manager role can create/edit/delete coupons in admin
  </verify>
  <done>
Coupon API accessible for validation. Store Manager can manage coupons in Strapi admin.
  </done>
</task>

</tasks>

<verification>
Run all services and verify coupon system:
```bash
pnpm db:start
pnpm dev:cms
```

1. Navigate to http://localhost:1337/admin
2. Click Content Manager > Coupon
3. Create test coupon: code "TEST10", discountType "percentage", discountValue 10, isActive true
4. Publish the coupon
5. Verify API returns coupon: curl http://localhost:1337/api/coupons
</verification>

<success_criteria>
- Coupon content type exists with all required fields (code, discountType, discountValue, limits, dates, isActive)
- Admin can create coupon with percentage or fixed discount
- Admin can set usage limit and expiration date
- Admin can enable/disable coupon via isActive toggle
- TypeScript Coupon interface available in @csz/types
- API endpoint returns coupon data
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-cart/04-01-SUMMARY.md`
</output>
