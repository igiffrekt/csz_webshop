---
phase: 04-shopping-cart
plan: 06
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/api/src/routes/cart/coupon.ts
  - apps/api/src/index.ts
autonomous: true

must_haves:
  truths:
    - "API validates coupon code and returns discount calculation"
    - "Invalid coupons return clear error messages"
    - "Expired, inactive, or over-limit coupons are rejected"
    - "Discount amount calculated correctly for percentage and fixed types"
  artifacts:
    - path: "apps/api/src/routes/cart/coupon.ts"
      provides: "Coupon validation endpoint"
      exports: ["couponRoutes"]
      min_lines: 60
  key_links:
    - from: "apps/api/src/routes/cart/coupon.ts"
      to: "Strapi CMS"
      via: "fetch to /api/coupons"
      pattern: "fetch.*api/coupons"
    - from: "apps/api/src/index.ts"
      to: "apps/api/src/routes/cart/coupon.ts"
      via: "route registration"
      pattern: "couponRoutes"
---

<objective>
Create Fastify API endpoint for server-side coupon validation.

Purpose: Coupon validation must happen server-side to prevent manipulation. The endpoint receives a coupon code and cart subtotal, validates against Strapi coupon data (active, dates, usage limits, minimum order), and returns the calculated discount amount.

Output: POST /cart/apply-coupon endpoint that validates coupons and returns discount calculation or error message.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shopping-cart/04-RESEARCH.md
@.planning/phases/04-shopping-cart/04-01-SUMMARY.md
@apps/api/src/index.ts
@apps/cms/src/api/coupon/content-types/coupon/schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qs for query string building</name>
  <files>apps/api/package.json</files>
  <action>
Install qs package for building Strapi query strings (same as used in web app):

```bash
cd apps/api && pnpm add qs && pnpm add -D @types/qs
```

This is used to build the filter query for fetching coupons from Strapi.
  </action>
  <verify>
Check apps/api/package.json contains qs in dependencies.
  </verify>
  <done>
qs package installed for Strapi query building.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create coupon validation route</name>
  <files>apps/api/src/routes/cart/coupon.ts</files>
  <action>
Create the coupon validation endpoint following the pattern from 04-RESEARCH.md:

```typescript
import { FastifyInstance } from 'fastify';
import qs from 'qs';

const STRAPI_URL = process.env.STRAPI_URL || 'http://localhost:1337';

interface ApplyCouponBody {
  code: string;
  subtotal: number;
}

interface CouponResponse {
  valid: boolean;
  error?: string;
  coupon?: {
    code: string;
    discountType: 'percentage' | 'fixed';
    discountValue: number;
    discountAmount: number;
  };
}

interface StrapiCoupon {
  id: number;
  documentId: string;
  code: string;
  discountType: 'percentage' | 'fixed';
  discountValue: number;
  minimumOrderAmount: number;
  maximumDiscount?: number;
  usageLimit?: number;
  usedCount: number;
  validFrom?: string;
  validUntil?: string;
  isActive: boolean;
}

export async function couponRoutes(fastify: FastifyInstance) {
  fastify.post<{ Body: ApplyCouponBody }>(
    '/cart/apply-coupon',
    {
      schema: {
        body: {
          type: 'object',
          required: ['code', 'subtotal'],
          properties: {
            code: { type: 'string', minLength: 1 },
            subtotal: { type: 'number', minimum: 0 },
          },
        },
        response: {
          200: {
            type: 'object',
            properties: {
              valid: { type: 'boolean' },
              error: { type: 'string' },
              coupon: {
                type: 'object',
                properties: {
                  code: { type: 'string' },
                  discountType: { type: 'string' },
                  discountValue: { type: 'number' },
                  discountAmount: { type: 'number' },
                },
              },
            },
          },
        },
      },
    },
    async (request, reply): Promise<CouponResponse> => {
      const { code, subtotal } = request.body;

      try {
        // Fetch coupon from Strapi - case insensitive match on published coupons
        const query = qs.stringify(
          {
            filters: {
              code: { $eqi: code.toUpperCase() },
              isActive: { $eq: true },
            },
            publicationState: 'live', // Only published coupons
          },
          { encodeValuesOnly: true }
        );

        const res = await fetch(`${STRAPI_URL}/api/coupons?${query}`);

        if (!res.ok) {
          fastify.log.error(`Strapi coupon fetch failed: ${res.status}`);
          return { valid: false, error: 'Hiba tortent a kupon ellenorzese soran' };
        }

        const data = await res.json();

        if (!data.data || data.data.length === 0) {
          return { valid: false, error: 'Ervenytelen kuponkod' };
        }

        const coupon: StrapiCoupon = data.data[0];
        const now = new Date();

        // Validate: is active
        if (!coupon.isActive) {
          return { valid: false, error: 'A kupon nem aktiv' };
        }

        // Validate: valid from date
        if (coupon.validFrom && new Date(coupon.validFrom) > now) {
          return { valid: false, error: 'A kupon meg nem ervenyes' };
        }

        // Validate: valid until date
        if (coupon.validUntil && new Date(coupon.validUntil) < now) {
          return { valid: false, error: 'A kupon lejart' };
        }

        // Validate: usage limit
        if (coupon.usageLimit && coupon.usedCount >= coupon.usageLimit) {
          return { valid: false, error: 'A kupon elerte a hasznalati limitet' };
        }

        // Validate: minimum order amount
        if (coupon.minimumOrderAmount && subtotal < coupon.minimumOrderAmount) {
          return {
            valid: false,
            error: `Minimum rendelesi osszeg: ${coupon.minimumOrderAmount.toLocaleString('hu-HU')} Ft`,
          };
        }

        // Calculate discount amount
        let discountAmount: number;

        if (coupon.discountType === 'percentage') {
          discountAmount = Math.round(subtotal * (coupon.discountValue / 100));
          // Apply maximum discount cap if set
          if (coupon.maximumDiscount && discountAmount > coupon.maximumDiscount) {
            discountAmount = coupon.maximumDiscount;
          }
        } else {
          // Fixed discount
          discountAmount = coupon.discountValue;
        }

        // Don't allow discount greater than subtotal
        discountAmount = Math.min(discountAmount, subtotal);

        return {
          valid: true,
          coupon: {
            code: coupon.code,
            discountType: coupon.discountType,
            discountValue: coupon.discountValue,
            discountAmount,
          },
        };
      } catch (error) {
        fastify.log.error(error, 'Coupon validation error');
        return { valid: false, error: 'Hiba tortent a kupon ellenorzese soran' };
      }
    }
  );
}
```

Create the `routes/cart` directory structure if it doesn't exist.
  </action>
  <verify>
Run `pnpm build` in apps/api (if build script exists) or just verify TypeScript syntax.
  </verify>
  <done>
Coupon validation endpoint created with full business logic for validation and discount calculation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register coupon route in main app</name>
  <files>apps/api/src/index.ts</files>
  <action>
Update the Fastify app to register the coupon routes:

1. Import the routes:
```typescript
import { couponRoutes } from './routes/cart/coupon.js';
```

2. Register after other plugins but before the start function:
```typescript
// Cart routes
await fastify.register(couponRoutes);
```

Note: Use `.js` extension in import for ESM compatibility (TypeScript compiles to JS).

Make sure the import path is correct based on the file structure. The file is at `src/routes/cart/coupon.ts`.
  </action>
  <verify>
Start API server: `pnpm dev:api`
Verify no startup errors in console.
Check route is registered by looking at startup logs or testing the endpoint.
  </verify>
  <done>
Coupon route registered and available at POST /cart/apply-coupon.
  </done>
</task>

</tasks>

<verification>
Test coupon validation endpoint:

1. Start all services:
```bash
pnpm db:start
pnpm dev:cms
pnpm dev:api
```

2. Create a test coupon in Strapi:
   - Go to http://localhost:1337/admin
   - Content Manager > Coupon > Create
   - code: "TEST10", discountType: "percentage", discountValue: 10, isActive: true
   - Publish the coupon

3. Test valid coupon:
```bash
curl -X POST http://localhost:4000/cart/apply-coupon \
  -H "Content-Type: application/json" \
  -d '{"code": "TEST10", "subtotal": 50000}'
```
Expected: `{"valid":true,"coupon":{"code":"TEST10","discountType":"percentage","discountValue":10,"discountAmount":5000}}`

4. Test invalid coupon:
```bash
curl -X POST http://localhost:4000/cart/apply-coupon \
  -H "Content-Type: application/json" \
  -d '{"code": "INVALID", "subtotal": 50000}'
```
Expected: `{"valid":false,"error":"Ervenytelen kuponkod"}`

5. Test minimum order (create coupon with minimumOrderAmount: 100000):
```bash
curl -X POST http://localhost:4000/cart/apply-coupon \
  -H "Content-Type: application/json" \
  -d '{"code": "MINORDER", "subtotal": 50000}'
```
Expected: Error about minimum order amount
</verification>

<success_criteria>
- qs package installed in API app
- POST /cart/apply-coupon endpoint responds to requests
- Valid coupon returns calculated discount amount
- Invalid coupon code returns "Ervenytelen kuponkod"
- Expired coupon returns "A kupon lejart"
- Inactive coupon returns "A kupon nem aktiv"
- Usage limit exceeded returns "A kupon elerte a hasznalati limitet"
- Minimum order not met returns message with required amount
- Percentage discount calculated correctly with optional max cap
- Fixed discount returned as-is (capped at subtotal)
- All error messages in Hungarian
- API server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-cart/04-06-SUMMARY.md`
</output>
