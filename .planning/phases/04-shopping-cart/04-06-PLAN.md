---
phase: 04-shopping-cart
plan: 06
type: execute
wave: 3
depends_on: ["04-04", "04-05"]
files_modified:
  - apps/web/src/components/cart/CouponInput.tsx
  - apps/web/src/components/cart/CartSheet.tsx
  - apps/web/src/lib/cart-api.ts
autonomous: true

must_haves:
  truths:
    - "User can enter coupon code in cart"
    - "Valid coupon shows discount in cart summary"
    - "Invalid coupon shows error message"
    - "User can remove applied coupon"
  artifacts:
    - path: "apps/web/src/components/cart/CouponInput.tsx"
      provides: "Coupon code input with validation"
      exports: ["CouponInput"]
      min_lines: 50
    - path: "apps/web/src/lib/cart-api.ts"
      provides: "Cart API client functions"
      exports: ["applyCoupon"]
  key_links:
    - from: "apps/web/src/components/cart/CouponInput.tsx"
      to: "apps/api/src/routes/cart/coupon.ts"
      via: "fetch POST /cart/apply-coupon"
      pattern: "fetch.*cart/apply-coupon"
    - from: "apps/web/src/components/cart/CartSheet.tsx"
      to: "apps/web/src/components/cart/CouponInput.tsx"
      via: "component import"
      pattern: "CouponInput"
---

<objective>
Create coupon input UI and integrate with cart for discount application.

Purpose: Users need to enter coupon codes to receive discounts. The coupon input validates against the Fastify API, displays errors for invalid codes, and shows the applied discount in the cart summary. Applied coupons can be removed.

Output: CouponInput component with validation, cart-api.ts for API calls, integration into CartSheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shopping-cart/04-RESEARCH.md
@.planning/phases/04-shopping-cart/04-04-SUMMARY.md
@.planning/phases/04-shopping-cart/04-05-SUMMARY.md
@apps/web/src/stores/cart.ts
@apps/web/src/components/cart/CartSheet.tsx
@apps/api/src/routes/cart/coupon.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cart API client</name>
  <files>apps/web/src/lib/cart-api.ts</files>
  <action>
Create API client for cart-related endpoints:

```typescript
import type { AppliedCoupon } from '@csz/types';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000';

export interface CouponValidationResponse {
  valid: boolean;
  error?: string;
  coupon?: AppliedCoupon;
}

/**
 * Validate and apply a coupon code
 * @param code - The coupon code to validate
 * @param subtotal - Current cart subtotal in HUF
 * @returns Validation result with coupon data or error
 */
export async function applyCoupon(
  code: string,
  subtotal: number
): Promise<CouponValidationResponse> {
  const response = await fetch(`${API_URL}/cart/apply-coupon`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ code, subtotal }),
  });

  if (!response.ok) {
    return {
      valid: false,
      error: 'Hiba tortent a kupon ellenorzese soran',
    };
  }

  return response.json();
}
```
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
  </verify>
  <done>
Cart API client created with applyCoupon function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Input component if not present</name>
  <files>apps/web/src/components/ui/input.tsx</files>
  <action>
Check if Input component exists. If not, add via shadcn:

```bash
cd apps/web && pnpm dlx shadcn@latest add input
```

The Input component is needed for the coupon code text field.
  </action>
  <verify>
Verify input.tsx exists in components/ui.
  </verify>
  <done>
Input component available for CouponInput.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CouponInput component</name>
  <files>apps/web/src/components/cart/CouponInput.tsx</files>
  <action>
Create coupon input component following the pattern from 04-RESEARCH.md:

```typescript
'use client';

import { useState } from 'react';
import { X, Tag, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { useCartStore, useCartSubtotal, useCartCoupon } from '@/stores/cart';
import { applyCoupon as applyCouponApi } from '@/lib/cart-api';

export function CouponInput() {
  const [code, setCode] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const subtotal = useCartSubtotal();
  const coupon = useCartCoupon();
  const applyCoupon = useCartStore((s) => s.applyCoupon);
  const removeCoupon = useCartStore((s) => s.removeCoupon);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const trimmedCode = code.trim().toUpperCase();

    if (!trimmedCode) {
      setError('Kerem adja meg a kuponkodot');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      const result = await applyCouponApi(trimmedCode, subtotal);

      if (result.valid && result.coupon) {
        applyCoupon(result.coupon);
        toast.success('Kupon sikeresen alkalmazva!', {
          description: result.coupon.discountType === 'percentage'
            ? `${result.coupon.discountValue}% kedvezmeny`
            : `${result.coupon.discountAmount.toLocaleString('hu-HU')} Ft kedvezmeny`,
        });
        setCode('');
      } else {
        setError(result.error || 'Ervenytelen kuponkod');
      }
    } catch (err) {
      setError('Hiba tortent a kupon ellenorzese soran');
    } finally {
      setIsLoading(false);
    }
  };

  const handleRemoveCoupon = () => {
    removeCoupon();
    toast.info('Kupon eltavolitva');
  };

  // If coupon already applied, show it
  if (coupon) {
    return (
      <div className="flex items-center justify-between bg-green-50 dark:bg-green-950 p-3 rounded-lg border border-green-200 dark:border-green-800">
        <div className="flex items-center gap-2">
          <Tag className="h-4 w-4 text-green-600 dark:text-green-400" />
          <span className="text-sm font-medium text-green-700 dark:text-green-300">
            {coupon.code}
          </span>
          <span className="text-xs text-green-600 dark:text-green-400">
            {coupon.discountType === 'percentage'
              ? `${coupon.discountValue}% kedvezmeny`
              : `${coupon.discountAmount.toLocaleString('hu-HU')} Ft`}
          </span>
        </div>
        <Button
          variant="ghost"
          size="sm"
          onClick={handleRemoveCoupon}
          className="h-8 w-8 p-0 text-green-600 hover:text-green-700 hover:bg-green-100"
          aria-label="Kupon eltavolitasa"
        >
          <X className="h-4 w-4" />
        </Button>
      </div>
    );
  }

  // Coupon input form
  return (
    <form onSubmit={handleSubmit} className="space-y-2">
      <div className="flex gap-2">
        <Input
          value={code}
          onChange={(e) => {
            setCode(e.target.value.toUpperCase());
            setError(null);
          }}
          placeholder="Kuponkod"
          className="flex-1 uppercase"
          disabled={isLoading}
          aria-label="Kuponkod"
          aria-invalid={!!error}
          aria-describedby={error ? 'coupon-error' : undefined}
        />
        <Button
          type="submit"
          variant="secondary"
          disabled={isLoading || !code.trim()}
        >
          {isLoading ? (
            <Loader2 className="h-4 w-4 animate-spin" />
          ) : (
            'Alkalmaz'
          )}
        </Button>
      </div>
      {error && (
        <p id="coupon-error" className="text-sm text-destructive">
          {error}
        </p>
      )}
    </form>
  );
}
```
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
  </verify>
  <done>
CouponInput component with form validation, API integration, and applied coupon display.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate CouponInput into CartSheet</name>
  <files>apps/web/src/components/cart/CartSheet.tsx</files>
  <action>
Update CartSheet to include CouponInput above the CartSummary:

1. Import CouponInput: `import { CouponInput } from './CouponInput';`

2. Add CouponInput in the cart content section, between the item list and CartSummary:

Find the section that has `<CartSummary />` and add `<CouponInput />` before it:

```tsx
<div className="pt-4 space-y-4">
  <Separator />
  <CouponInput />
  <Separator />
  <CartSummary />
</div>
```

The order should be: items scroll area > separator > coupon input > separator > cart summary > checkout buttons.
  </action>
  <verify>
Run `pnpm build` in apps/web.
Start dev server and open cart sheet - verify coupon input appears.
  </verify>
  <done>
CouponInput integrated into CartSheet between items and summary.
  </done>
</task>

</tasks>

<verification>
Full coupon flow test:

1. Start all services:
```bash
pnpm db:start
pnpm dev:cms
pnpm dev:api
pnpm dev:web
```

2. Create test coupon in Strapi (if not already):
   - code: "TESZT20", discountType: "percentage", discountValue: 20, isActive: true
   - Publish the coupon

3. Add items to cart:
   - Navigate to a product page
   - Add product to cart
   - Open cart sheet

4. Test valid coupon:
   - Enter "TESZT20" in coupon input
   - Click "Alkalmaz"
   - Verify: Green success toast, coupon badge appears, discount shown in summary

5. Test invalid coupon:
   - Remove existing coupon (click X)
   - Enter "INVALID123"
   - Click "Alkalmaz"
   - Verify: Error message "Ervenytelen kuponkod"

6. Test coupon removal:
   - Apply valid coupon
   - Click X on coupon badge
   - Verify: Coupon removed, discount removed from summary, toast notification

7. Verify cart total:
   - Apply 20% coupon to 50,000 Ft cart
   - Verify discount shows 10,000 Ft
   - Verify total shows 40,000 Ft
</verification>

<success_criteria>
- Cart API client (cart-api.ts) exports applyCoupon function
- CouponInput renders in CartSheet above summary
- Valid coupon code applies discount and shows success toast
- Invalid coupon shows inline error message
- Applied coupon displays as badge with remove button
- Removing coupon updates cart summary immediately
- Coupon code input converts to uppercase
- Loading state shows during API call
- Discount amount displays in CartSummary when coupon applied
- TypeScript compilation passes
- No console errors during coupon flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-cart/04-06-SUMMARY.md`
</output>
