---
phase: 04-shopping-cart
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - apps/web/src/components/cart/AddToCartButton.tsx
  - apps/web/src/components/cart/VariantSelector.tsx
  - apps/web/src/components/ui/sonner.tsx
  - apps/web/src/app/[locale]/layout.tsx
  - apps/web/src/app/[locale]/termekek/[slug]/page.tsx
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "User can add a product to cart with visual feedback"
    - "User can select a variant before adding to cart"
    - "Add-to-cart shows loading state then success confirmation"
    - "Toast notification appears when item added"
  artifacts:
    - path: "apps/web/src/components/cart/AddToCartButton.tsx"
      provides: "Add to cart button with animation"
      exports: ["AddToCartButton"]
      min_lines: 50
    - path: "apps/web/src/components/cart/VariantSelector.tsx"
      provides: "Product variant selection UI"
      exports: ["VariantSelector"]
    - path: "apps/web/src/components/ui/sonner.tsx"
      provides: "Toast notification component"
  key_links:
    - from: "apps/web/src/components/cart/AddToCartButton.tsx"
      to: "apps/web/src/stores/cart.ts"
      via: "useCartStore addItem"
      pattern: "useCartStore.*addItem"
    - from: "apps/web/src/app/[locale]/termekek/[slug]/page.tsx"
      to: "apps/web/src/components/cart/AddToCartButton.tsx"
      via: "component import"
      pattern: "AddToCartButton"
---

<objective>
Implement add-to-cart functionality with variant selection and visual feedback animations.

Purpose: Users need to add products to their cart with clear feedback. Products with variants require selection before adding. The add-to-cart button provides animated feedback (idle -> loading -> success states) and a toast notification confirms the action.

Output: AddToCartButton component with animation, VariantSelector component, toast notifications via Sonner, integrated into product detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shopping-cart/04-RESEARCH.md
@.planning/phases/04-shopping-cart/04-02-SUMMARY.md
@apps/web/src/stores/cart.ts
@apps/web/src/app/[locale]/termekek/[slug]/page.tsx
@packages/types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sonner toast component via shadcn</name>
  <files>
    apps/web/src/components/ui/sonner.tsx
    apps/web/src/app/[locale]/layout.tsx
    apps/web/package.json
  </files>
  <action>
Install Sonner toast component (shadcn/ui's recommended toast solution):

```bash
cd apps/web && pnpm dlx shadcn@latest add sonner
```

This will create `components/ui/sonner.tsx` and install the sonner package.

After installation, add the Toaster component to the locale layout (apps/web/src/app/[locale]/layout.tsx):

1. Import: `import { Toaster } from '@/components/ui/sonner';`
2. Add `<Toaster />` inside the body, after `{children}` and before closing tags
3. Configure position as "bottom-right" for cart notifications:

```tsx
<Toaster
  position="bottom-right"
  toastOptions={{
    classNames: {
      toast: 'group border-border',
      success: 'bg-green-50 border-green-200 text-green-800',
      error: 'bg-red-50 border-red-200 text-red-800',
    },
  }}
/>
```
  </action>
  <verify>
Verify sonner package in package.json.
Verify sonner.tsx exists in components/ui.
Verify Toaster added to layout.tsx.
  </verify>
  <done>
Sonner toast system installed and configured in app layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VariantSelector component</name>
  <files>apps/web/src/components/cart/VariantSelector.tsx</files>
  <action>
Create variant selector component for product detail page:

```typescript
'use client';

import { useState } from 'react';
import type { ProductVariant } from '@csz/types';
import { cn } from '@/lib/utils';
import { formatPrice } from '@/lib/formatters';

interface VariantSelectorProps {
  variants: ProductVariant[];
  selectedVariant: ProductVariant | null;
  onSelect: (variant: ProductVariant) => void;
}

export function VariantSelector({
  variants,
  selectedVariant,
  onSelect,
}: VariantSelectorProps) {
  if (variants.length === 0) return null;

  // Group variants by attributeLabel if present
  const label = variants[0]?.attributeLabel || 'Valasszon';

  return (
    <div className="space-y-3">
      <label className="text-sm font-medium text-foreground">
        {label}
      </label>
      <div className="flex flex-wrap gap-2">
        {variants.map((variant) => {
          const isSelected = selectedVariant?.id === variant.id;
          const isOutOfStock = variant.stock === 0;

          return (
            <button
              key={variant.id}
              type="button"
              onClick={() => !isOutOfStock && onSelect(variant)}
              disabled={isOutOfStock}
              className={cn(
                'px-4 py-2 text-sm font-medium rounded-md border transition-colors',
                isSelected
                  ? 'border-primary bg-primary text-primary-foreground'
                  : 'border-input bg-background hover:bg-accent hover:text-accent-foreground',
                isOutOfStock && 'opacity-50 cursor-not-allowed line-through'
              )}
            >
              {variant.name || variant.attributeValue}
              {variant.price !== variants[0]?.price && (
                <span className="ml-1 text-xs opacity-75">
                  ({formatPrice(variant.price)})
                </span>
              )}
            </button>
          );
        })}
      </div>
      {selectedVariant && (
        <p className="text-sm text-muted-foreground">
          Keszlet: {selectedVariant.stock > 0 ? `${selectedVariant.stock} db` : 'Elfogyott'}
        </p>
      )}
    </div>
  );
}
```

Create `cart` directory under components if it doesn't exist.
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
  </verify>
  <done>
VariantSelector component displays product variants with selection state and stock info.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AddToCartButton with animation</name>
  <files>apps/web/src/components/cart/AddToCartButton.tsx</files>
  <action>
Create add-to-cart button following the pattern from 04-RESEARCH.md:

```typescript
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { ShoppingCart, Check, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import { Button } from '@/components/ui/button';
import { useCartStore } from '@/stores/cart';
import type { Product, ProductVariant } from '@csz/types';

interface AddToCartButtonProps {
  product: Product;
  variant?: ProductVariant | null;
  quantity?: number;
  disabled?: boolean;
  requiresVariant?: boolean;
}

export function AddToCartButton({
  product,
  variant,
  quantity = 1,
  disabled,
  requiresVariant = false,
}: AddToCartButtonProps) {
  const [status, setStatus] = useState<'idle' | 'adding' | 'added'>('idle');
  const addItem = useCartStore((state) => state.addItem);

  const handleAddToCart = async () => {
    if (status !== 'idle') return;

    // Check if variant is required but not selected
    if (requiresVariant && !variant) {
      toast.error('Kerem valasszon meretet');
      return;
    }

    // Check stock
    const stock = variant?.stock ?? product.stock;
    if (stock === 0) {
      toast.error('A termek nincs keszleten');
      return;
    }

    setStatus('adding');

    // Brief delay for animation effect
    await new Promise(resolve => setTimeout(resolve, 300));

    addItem(product, variant ?? undefined, quantity);
    setStatus('added');

    toast.success('Hozzaadva a kosarhoz', {
      description: variant
        ? `${product.name} - ${variant.name || variant.attributeValue}`
        : product.name,
    });

    // Reset after animation
    setTimeout(() => setStatus('idle'), 1500);
  };

  const stock = variant?.stock ?? product.stock;
  const isOutOfStock = stock === 0;
  const needsVariant = requiresVariant && !variant;

  return (
    <Button
      onClick={handleAddToCart}
      disabled={disabled || isOutOfStock || status !== 'idle'}
      className="relative overflow-hidden min-w-[160px]"
      size="lg"
    >
      <AnimatePresence mode="wait">
        {status === 'idle' && (
          <motion.span
            key="idle"
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
            className="flex items-center gap-2"
          >
            <ShoppingCart className="h-4 w-4" />
            {isOutOfStock ? 'Elfogyott' : needsVariant ? 'Valasszon meretet' : 'Kosarba'}
          </motion.span>
        )}

        {status === 'adding' && (
          <motion.span
            key="adding"
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
          >
            <Loader2 className="h-4 w-4 animate-spin" />
          </motion.span>
        )}

        {status === 'added' && (
          <motion.span
            key="added"
            initial={{ opacity: 0, scale: 0.5 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.5 }}
            className="flex items-center gap-2 text-green-50"
          >
            <Check className="h-4 w-4" />
            Hozzaadva!
          </motion.span>
        )}
      </AnimatePresence>
    </Button>
  );
}
```
  </action>
  <verify>
Run `pnpm build` in apps/web to verify TypeScript compilation.
  </verify>
  <done>
AddToCartButton component with idle/loading/success animation states and toast feedback.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate into product detail page</name>
  <files>apps/web/src/app/[locale]/termekek/[slug]/page.tsx</files>
  <action>
Update the product detail page to use AddToCartButton and VariantSelector.

The page is a Server Component, so we need to create a client wrapper for the interactive parts.

Create `apps/web/src/components/product/ProductActions.tsx` as a Client Component:

```typescript
'use client';

import { useState } from 'react';
import type { Product, ProductVariant } from '@csz/types';
import { AddToCartButton } from '@/components/cart/AddToCartButton';
import { VariantSelector } from '@/components/cart/VariantSelector';

interface ProductActionsProps {
  product: Product;
}

export function ProductActions({ product }: ProductActionsProps) {
  const [selectedVariant, setSelectedVariant] = useState<ProductVariant | null>(null);
  const hasVariants = product.variants && product.variants.length > 0;

  return (
    <div className="space-y-6">
      {hasVariants && (
        <VariantSelector
          variants={product.variants!}
          selectedVariant={selectedVariant}
          onSelect={setSelectedVariant}
        />
      )}

      <AddToCartButton
        product={product}
        variant={selectedVariant}
        requiresVariant={hasVariants}
      />
    </div>
  );
}
```

Then update the product detail page to:
1. Import ProductActions
2. Replace existing placeholder add-to-cart button with <ProductActions product={product} />
3. Place it in the product info section, after price display

Look at the existing page structure and find where the add-to-cart functionality should go (likely after price/stock info).
  </action>
  <verify>
Run `pnpm build` in apps/web.
Start dev server `pnpm dev:web` and navigate to a product page.
Verify variant selector shows (if product has variants).
Click add to cart and verify toast appears.
  </verify>
  <done>
Product detail page has working add-to-cart with variant selection and visual feedback.
  </done>
</task>

</tasks>

<verification>
Full add-to-cart flow test:

1. Start all services:
```bash
pnpm db:start
pnpm dev:cms
pnpm dev:web
```

2. Navigate to a product page: http://localhost:3000/hu/termekek/[any-product-slug]

3. Test scenarios:
   - Product without variants: Click "Kosarba" - toast appears, button shows "Hozzaadva!"
   - Product with variants: Variant buttons visible, must select before add works
   - Out of stock: Button shows "Elfogyott" and is disabled

4. Check localStorage:
   - Open DevTools > Application > Local Storage
   - Look for 'csz-cart' key
   - Should contain added items
</verification>

<success_criteria>
- Sonner toast component installed and configured in layout
- VariantSelector shows product variants with stock info
- AddToCartButton has three animated states (idle/adding/added)
- Toast notification appears on successful add
- Variant selection required for products with variants
- Out-of-stock products show disabled button with "Elfogyott"
- Product detail page integrates both components
- TypeScript compilation passes
- Animation respects reduced-motion (via framer-motion defaults)
</success_criteria>

<output>
After completion, create `.planning/phases/04-shopping-cart/04-03-SUMMARY.md`
</output>
