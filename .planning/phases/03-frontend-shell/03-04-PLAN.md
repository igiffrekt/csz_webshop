---
phase: 03-frontend-shell
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/web/src/app/[locale]/termekek/[slug]/page.tsx
  - apps/web/src/components/product/ProductGallery.tsx
  - apps/web/src/components/product/ProductInfo.tsx
  - apps/web/src/components/product/VariantSelector.tsx
  - apps/web/src/components/product/SpecsTable.tsx
  - apps/web/src/components/product/CertBadges.tsx
  - apps/web/src/components/product/DocumentList.tsx
  - apps/web/src/lib/api.ts
  - apps/web/src/messages/hu.json
autonomous: true

must_haves:
  truths:
    - "User can view product images in a gallery"
    - "User can see product name, description, and price"
    - "User can see product variants if they exist"
    - "User can see certification badges"
    - "User can view specifications in a table"
    - "User can download product documents"
  artifacts:
    - path: "apps/web/src/app/[locale]/termekek/[slug]/page.tsx"
      provides: "Product detail page with SEO metadata"
      min_lines: 60
    - path: "apps/web/src/components/product/ProductGallery.tsx"
      provides: "Image gallery with thumbnails"
      contains: "use client"
    - path: "apps/web/src/components/product/SpecsTable.tsx"
      provides: "Specifications table"
      min_lines: 20
    - path: "apps/web/src/components/product/CertBadges.tsx"
      provides: "Certification badges display"
      min_lines: 15
  key_links:
    - from: "apps/web/src/app/[locale]/termekek/[slug]/page.tsx"
      to: "getProduct"
      via: "Server Component async fetch by slug"
      pattern: "await getProduct.*slug"
    - from: "apps/web/src/app/[locale]/termekek/[slug]/page.tsx"
      to: "generateMetadata"
      via: "Dynamic SEO metadata from product"
      pattern: "generateMetadata"
---

<objective>
Build the product detail page showing full product information - image gallery, description, variants, specifications, certifications, and downloadable documents.

Purpose: Enable users to view complete product details including fire safety certifications (PROD-04 through PROD-08), supporting informed purchase decisions.

Output: Fully functional /termekek/[slug] product detail page with all product information displayed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-frontend-shell/03-RESEARCH.md
@.planning/phases/03-frontend-shell/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProductGallery and ProductInfo components</name>
  <files>
    apps/web/src/components/product/ProductGallery.tsx
    apps/web/src/components/product/ProductInfo.tsx
    apps/web/src/messages/hu.json
  </files>
  <action>
**Create ProductGallery.tsx (Client Component):**
```typescript
'use client';

import { useState } from 'react';
import Image from 'next/image';
import { getStrapiMediaUrl } from '@/lib/formatters';
import type { StrapiMedia } from '@csz/types';
import { cn } from '@/lib/utils';

interface ProductGalleryProps {
  images: StrapiMedia[];
  productName: string;
}

export function ProductGallery({ images, productName }: ProductGalleryProps) {
  const [selectedIndex, setSelectedIndex] = useState(0);

  // Use placeholder if no images
  const displayImages = images.length > 0 ? images : [
    { id: 0, url: '/placeholder.jpg', alternativeText: productName } as StrapiMedia
  ];

  const selectedImage = displayImages[selectedIndex];

  return (
    <div className="flex flex-col gap-4">
      {/* Main image */}
      <div className="relative aspect-square w-full overflow-hidden rounded-lg bg-gray-100">
        <Image
          src={getStrapiMediaUrl(selectedImage.url)}
          alt={selectedImage.alternativeText || productName}
          fill
          sizes="(max-width: 768px) 100vw, 50vw"
          className="object-contain"
          priority
        />
      </div>

      {/* Thumbnail strip */}
      {displayImages.length > 1 && (
        <div className="flex gap-2 overflow-x-auto pb-2">
          {displayImages.map((image, index) => (
            <button
              key={image.id}
              onClick={() => setSelectedIndex(index)}
              className={cn(
                'relative h-20 w-20 flex-shrink-0 rounded-md overflow-hidden border-2 transition-colors',
                index === selectedIndex ? 'border-primary' : 'border-transparent hover:border-gray-300'
              )}
            >
              <Image
                src={getStrapiMediaUrl(image.url)}
                alt={image.alternativeText || `${productName} ${index + 1}`}
                fill
                sizes="80px"
                className="object-cover"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
```

**Create ProductInfo.tsx (Server Component):**
```typescript
import { formatPrice } from '@/lib/formatters';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { ShoppingCart, Check, X } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import type { Product } from '@csz/types';

interface ProductInfoProps {
  product: Product;
}

export async function ProductInfo({ product }: ProductInfoProps) {
  const t = await getTranslations('product');

  const inStock = product.stock > 0;
  const hasDiscount = product.compareAtPrice && product.compareAtPrice > product.basePrice;

  return (
    <div className="flex flex-col gap-4">
      {/* Badges */}
      <div className="flex gap-2">
        {product.isOnSale && (
          <Badge variant="destructive">{t('onSale')}</Badge>
        )}
        {product.isFeatured && (
          <Badge variant="secondary">{t('featured')}</Badge>
        )}
      </div>

      {/* Product name */}
      <h1 className="text-3xl font-bold">{product.name}</h1>

      {/* SKU */}
      <p className="text-sm text-muted-foreground">
        {t('sku')}: {product.sku}
      </p>

      {/* Price */}
      <div className="flex items-baseline gap-3">
        <span className="text-3xl font-bold">
          {formatPrice(product.basePrice)}
        </span>
        {hasDiscount && (
          <span className="text-lg text-muted-foreground line-through">
            {formatPrice(product.compareAtPrice!)}
          </span>
        )}
      </div>

      {/* Stock status */}
      <div className="flex items-center gap-2">
        {inStock ? (
          <>
            <Check className="h-4 w-4 text-green-600" />
            <span className="text-green-600">{t('inStock')}</span>
          </>
        ) : (
          <>
            <X className="h-4 w-4 text-red-600" />
            <span className="text-red-600">{t('outOfStock')}</span>
          </>
        )}
      </div>

      {/* Short description */}
      {product.shortDescription && (
        <p className="text-muted-foreground">{product.shortDescription}</p>
      )}

      {/* Add to cart button (placeholder - functional in Phase 4) */}
      <Button size="lg" className="w-full sm:w-auto" disabled={!inStock}>
        <ShoppingCart className="mr-2 h-5 w-5" />
        {t('addToCart')}
      </Button>
    </div>
  );
}
```

Add shadcn/ui Badge component:
```bash
cd apps/web && pnpm dlx shadcn@latest add badge
```

**Update hu.json:**
```json
{
  "product": {
    "onSale": "Akció",
    "featured": "Kiemelt",
    "sku": "Cikkszám",
    "inStock": "Készleten",
    "outOfStock": "Nincs készleten",
    "addToCart": "Kosárba",
    "specifications": "Műszaki adatok",
    "certifications": "Tanúsítványok",
    "documents": "Letölthető dokumentumok",
    "variants": "Változatok",
    "description": "Leírás"
  }
}
```
  </action>
  <verify>
1. ProductGallery renders main image and thumbnail strip
2. Clicking thumbnail changes main image
3. ProductInfo shows name, price, SKU, stock status
4. Compare price shows with strikethrough if higher than base price
5. Badges render for featured and on-sale products
  </verify>
  <done>ProductGallery handles image selection, ProductInfo displays core product details</done>
</task>

<task type="auto">
  <name>Task 2: Create SpecsTable, CertBadges, VariantSelector, DocumentList</name>
  <files>
    apps/web/src/components/product/SpecsTable.tsx
    apps/web/src/components/product/CertBadges.tsx
    apps/web/src/components/product/VariantSelector.tsx
    apps/web/src/components/product/DocumentList.tsx
    apps/web/src/messages/hu.json
  </files>
  <action>
**Create SpecsTable.tsx (Server Component):**
```typescript
import { getTranslations } from 'next-intl/server';
import type { Specification } from '@csz/types';

interface SpecsTableProps {
  specifications: Specification[];
}

export async function SpecsTable({ specifications }: SpecsTableProps) {
  const t = await getTranslations('product');

  if (!specifications || specifications.length === 0) {
    return null;
  }

  return (
    <section className="mt-8">
      <h2 className="text-xl font-semibold mb-4">{t('specifications')}</h2>
      <div className="border rounded-lg overflow-hidden">
        <table className="w-full">
          <tbody className="divide-y">
            {specifications.map((spec) => (
              <tr key={spec.id} className="hover:bg-muted/50">
                <td className="px-4 py-3 font-medium bg-muted/30 w-1/3">
                  {spec.name}
                </td>
                <td className="px-4 py-3">
                  {spec.value}
                  {spec.unit && ` ${spec.unit}`}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  );
}
```

**Create CertBadges.tsx (Server Component):**
```typescript
import { getTranslations } from 'next-intl/server';
import { Shield, Award } from 'lucide-react';
import type { Certification } from '@csz/types';

interface CertBadgesProps {
  certifications: Certification[];
}

export async function CertBadges({ certifications }: CertBadgesProps) {
  const t = await getTranslations('product');

  if (!certifications || certifications.length === 0) {
    return null;
  }

  return (
    <section className="mt-6">
      <h3 className="text-sm font-medium text-muted-foreground mb-3">
        {t('certifications')}
      </h3>
      <div className="flex flex-wrap gap-3">
        {certifications.map((cert) => (
          <div
            key={cert.id}
            className="flex items-center gap-2 px-3 py-2 bg-green-50 border border-green-200 rounded-md text-green-800"
            title={cert.standard || cert.name}
          >
            {cert.name.includes('CE') ? (
              <Shield className="h-4 w-4" />
            ) : (
              <Award className="h-4 w-4" />
            )}
            <span className="text-sm font-medium">{cert.name}</span>
            {cert.standard && (
              <span className="text-xs text-green-600">({cert.standard})</span>
            )}
          </div>
        ))}
      </div>
    </section>
  );
}
```

**Create VariantSelector.tsx (Client Component):**
```typescript
'use client';

import { useState } from 'react';
import { formatPrice } from '@/lib/formatters';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import type { ProductVariant } from '@csz/types';

interface VariantSelectorProps {
  variants: ProductVariant[];
  onSelect?: (variant: ProductVariant) => void;
}

export function VariantSelector({ variants, onSelect }: VariantSelectorProps) {
  const [selectedId, setSelectedId] = useState<number | null>(null);

  if (!variants || variants.length === 0) {
    return null;
  }

  const handleSelect = (variant: ProductVariant) => {
    setSelectedId(variant.id);
    onSelect?.(variant);
  };

  // Group variants by attributeLabel if present
  const label = variants[0]?.attributeLabel;

  return (
    <div className="mt-4">
      {label && (
        <h3 className="text-sm font-medium mb-2">{label}</h3>
      )}
      <div className="flex flex-wrap gap-2">
        {variants.map((variant) => (
          <Button
            key={variant.id}
            variant={selectedId === variant.id ? 'default' : 'outline'}
            size="sm"
            onClick={() => handleSelect(variant)}
            className={cn(
              'min-w-[80px]',
              variant.stock === 0 && 'opacity-50'
            )}
            disabled={variant.stock === 0}
          >
            {variant.attributeValue || variant.name}
            <span className="ml-2 text-xs">
              {formatPrice(variant.price)}
            </span>
          </Button>
        ))}
      </div>
    </div>
  );
}
```

**Create DocumentList.tsx (Server Component):**
```typescript
import { getTranslations } from 'next-intl/server';
import { FileText, Download } from 'lucide-react';
import { getStrapiMediaUrl } from '@/lib/formatters';
import type { StrapiMedia } from '@csz/types';

interface DocumentListProps {
  documents: StrapiMedia[];
}

export async function DocumentList({ documents }: DocumentListProps) {
  const t = await getTranslations('product');

  if (!documents || documents.length === 0) {
    return null;
  }

  return (
    <section className="mt-8">
      <h2 className="text-xl font-semibold mb-4">{t('documents')}</h2>
      <ul className="space-y-2">
        {documents.map((doc) => (
          <li key={doc.id}>
            <a
              href={getStrapiMediaUrl(doc.url)}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-3 p-3 border rounded-lg hover:bg-muted/50 transition-colors"
            >
              <FileText className="h-5 w-5 text-muted-foreground flex-shrink-0" />
              <span className="flex-1 truncate">{doc.name}</span>
              <Download className="h-4 w-4 text-muted-foreground" />
            </a>
          </li>
        ))}
      </ul>
    </section>
  );
}
```
  </action>
  <verify>
1. SpecsTable renders table with name/value pairs
2. CertBadges shows certification names with icons
3. VariantSelector displays variant buttons, selection updates state
4. DocumentList shows downloadable documents with links
5. All sections gracefully hide when data is empty
  </verify>
  <done>All product detail components render correctly and handle empty states</done>
</task>

<task type="auto">
  <name>Task 3: Build product detail page with SEO</name>
  <files>
    apps/web/src/app/[locale]/termekek/[slug]/page.tsx
    apps/web/src/lib/api.ts
  </files>
  <action>
**Add getProduct to api.ts:**
```typescript
export async function getProduct(slug: string): Promise<Product | null> {
  const query = qs.stringify({
    filters: { slug: { $eq: slug } },
    populate: {
      images: { fields: ['url', 'alternativeText', 'width', 'height', 'formats'] },
      documents: { fields: ['url', 'name'] },
      categories: { fields: ['name', 'slug'] },
      variants: {
        populate: {
          image: { fields: ['url', 'alternativeText'] }
        }
      },
      specifications: true,
      certifications: {
        populate: {
          certificate: { fields: ['url', 'name'] }
        }
      }
    }
  }, { encodeValuesOnly: true });

  const res = await fetch(`${STRAPI_URL}/api/products?${query}`, {
    next: { revalidate: 60 },
  });

  if (!res.ok) {
    return null;
  }

  const data = await res.json();
  return data.data?.[0] ?? null;
}
```

**Create /termekek/[slug]/page.tsx:**
```typescript
import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { getProduct } from '@/lib/api';
import { ProductGallery } from '@/components/product/ProductGallery';
import { ProductInfo } from '@/components/product/ProductInfo';
import { VariantSelector } from '@/components/product/VariantSelector';
import { CertBadges } from '@/components/product/CertBadges';
import { SpecsTable } from '@/components/product/SpecsTable';
import { DocumentList } from '@/components/product/DocumentList';
import { getStrapiMediaUrl } from '@/lib/formatters';

interface Props {
  params: Promise<{ slug: string; locale: string }>;
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { slug } = await params;
  const product = await getProduct(slug);

  if (!product) {
    return {
      title: 'Termék nem található',
    };
  }

  return {
    title: product.name,
    description: product.shortDescription || `${product.name} - Tűzvédelmi eszköz`,
    openGraph: {
      title: product.name,
      description: product.shortDescription || undefined,
      images: product.images?.[0] ? [getStrapiMediaUrl(product.images[0].url)] : undefined,
    },
  };
}

export default async function ProductPage({ params }: Props) {
  const { slug } = await params;
  const product = await getProduct(slug);

  if (!product) {
    notFound();
  }

  // JSON-LD structured data for SEO
  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: product.name,
    description: product.shortDescription || product.description,
    image: product.images?.[0] ? getStrapiMediaUrl(product.images[0].url) : undefined,
    sku: product.sku,
    offers: {
      '@type': 'Offer',
      price: product.basePrice,
      priceCurrency: 'HUF',
      availability: product.stock > 0
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
    },
  };

  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />

      <main className="container mx-auto px-4 py-8">
        {/* Breadcrumb - simple for now */}
        <nav className="text-sm text-muted-foreground mb-6">
          <a href="/termekek" className="hover:underline">Termékek</a>
          <span className="mx-2">/</span>
          <span>{product.name}</span>
        </nav>

        {/* Main product section */}
        <div className="grid md:grid-cols-2 gap-8 lg:gap-12">
          {/* Left: Gallery */}
          <ProductGallery
            images={product.images || []}
            productName={product.name}
          />

          {/* Right: Product info */}
          <div>
            <ProductInfo product={product} />

            {/* Certification badges */}
            {product.certifications && product.certifications.length > 0 && (
              <CertBadges certifications={product.certifications} />
            )}

            {/* Variant selector */}
            {product.variants && product.variants.length > 0 && (
              <VariantSelector variants={product.variants} />
            )}
          </div>
        </div>

        {/* Full description */}
        {product.description && (
          <section className="mt-12 prose prose-gray max-w-none">
            <h2 className="text-xl font-semibold mb-4">Leírás</h2>
            <div dangerouslySetInnerHTML={{ __html: product.description }} />
          </section>
        )}

        {/* Specifications table */}
        {product.specifications && (
          <SpecsTable specifications={product.specifications} />
        )}

        {/* Downloadable documents */}
        {product.documents && (
          <DocumentList documents={product.documents} />
        )}
      </main>
    </>
  );
}
```

**Create not-found.tsx:**
```typescript
// apps/web/src/app/[locale]/termekek/[slug]/not-found.tsx
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default function ProductNotFound() {
  return (
    <main className="container mx-auto px-4 py-16 text-center">
      <h1 className="text-2xl font-bold mb-4">Termék nem található</h1>
      <p className="text-muted-foreground mb-8">
        A keresett termék nem létezik vagy eltávolításra került.
      </p>
      <Link href="/termekek">
        <Button>Vissza a termékekhez</Button>
      </Link>
    </main>
  );
}
```

Add @tailwindcss/typography plugin for prose styling of descriptions:
```bash
cd apps/web && pnpm add @tailwindcss/typography
```

Update globals.css to include typography plugin (Tailwind v4 syntax).
  </action>
  <verify>
1. Navigate to /termekek/[valid-slug]
2. Product page loads with gallery, info, certifications
3. Check page source - JSON-LD script present with product data
4. Check meta tags - title and description from product
5. Navigate to /termekek/invalid-slug - 404 page shows
6. Download link works for documents (opens in new tab)
7. Breadcrumb navigates back to product list
  </verify>
  <done>Product detail page renders full product with SEO metadata, 404 handled gracefully</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /termekek and click a product
2. Product detail page shows:
   - Image gallery with thumbnail navigation
   - Product name, SKU, price (HUF formatted)
   - Stock status (in stock/out of stock)
   - Certification badges (CE, EN standards)
   - Variant selector (if variants exist)
   - Specifications table
   - Downloadable documents
3. Page has correct meta title and description
4. JSON-LD structured data present in page source
5. Invalid product slug shows 404 page
6. Page is responsive on mobile/tablet/desktop
</verification>

<success_criteria>
- Product detail page at /termekek/[slug] displays full product information
- Image gallery allows browsing multiple product images (PROD-04)
- Variants display and are selectable (PROD-05)
- Certification badges visible (PROD-06)
- Specifications shown in table format (PROD-07)
- Documents downloadable via links (PROD-08)
- SEO metadata and JSON-LD structured data present
- 404 page for invalid product slugs
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-shell/03-04-SUMMARY.md`
</output>
